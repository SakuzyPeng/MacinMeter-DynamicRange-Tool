# DR 计算器（dr_calculator.rs）优化建议与决策记录（可追踪）

目的：在不改变 DR 计算结果（数值一致性）的前提下，优化 `dr_calculator.rs` 相关路径的可维护性、内存与性能。

范围：`src/core/dr_calculator.rs`（协调层，敏感）、其直接依赖的 `src/core/histogram.rs`（窗口 RMS 与 20% 采样）、`src/core/peak_selection.rs`（峰值策略）。

一致性约束：
- 结果不变：DR 值、显示 RMS、主/次峰选择应与现实现完全一致。
- 算法口径不变：3 秒窗口；44.1kHz 使用 132480 样本窗口；RMS= sqrt(2·sum(s^2)/n)；“最响的 20% 窗口”统计；峰值策略默认 PreferSecondary。

---

## 当前实现概要（用于校对）

- 协调器：`DrCalculator::calculate_dr_from_samples()` 将交错数据交给 `ProcessingCoordinator` 做声道分离，然后对每个声道调用 `calculate_single_channel_dr()`。
- 统计器：`WindowRmsAnalyzer`（histogram.rs）按 3 秒窗口计算 RMS 和窗口峰值，使用“20% 采样”得到显示 RMS；峰值从“窗口主/次峰”中按策略选择。
- DR 公式：`DR = -20 · log10(RMS / Peak)`。

---

## 建议与分析（按风险从低到高）

1) 移除“尾窗重算”样本缓存（等价、零风险）
- 现状：为尾窗“排除最后样本”时重算 Peak，维持了 `current_window_samples: Vec<f64>` 并在尾窗做一次 O(n) 扫描（histogram.rs）。
- 问题：每个窗口保留完整样本缓存，内存占用大（f64 × 窗口长度），尾窗路径有额外扫描成本。
- 方案：改为流式“双峰跟踪”（max、max_count、second_max、last_abs）。尾窗逻辑：
  - 若 `last_abs < max` → 调整后 Peak 仍为 `max`；
  - 若 `last_abs == max` 且 `max_count > 1` → 仍为 `max`；
  - 否则 → 为 `second_max`（不存在则 0）。
- 结果：语义与现实现一致（尾窗只是“排除最后样本”），去掉大向量与扫描；内存显著下降，性能更稳。
- 状态：建议“已采纳/待办”二选一（实现后需做等价性回归测试）。

2) 20% 采样临时数组构造微调（等价、极低风险）
- 现状：`let mut rms_array = vec![0.0; seg_cnt];` 再逐项拷贝窗口 RMS，最后可能保留一个虚拟 0 窗。
- 方案：`let mut rms_array = self.window_rms_values.clone(); if has_virtual_zero { rms_array.push(0.0); }`。
- 原因：避免填零与手工复制，降低分支与指令数；完全等价。
- 状态：建议“已采纳/待办”。

3) 预留容量减少扩容（等价、极低风险）
- 现状：`window_rms_values` 与 `window_peaks` 可能多次扩容。
- 方案：首次处理前，根据 `samples.len()/window_len + 1` 做 `reserve`；或分阶段累计估算（流式输入时）。
- 原因：减少 realloc，轻微提升吞吐；不影响结果。
- 状态：建议“已采纳/待办”。

4) Sum Doubling 标志的语义澄清（文档、零风险）
- 现状：`DrCalculator` 传入 `WindowRmsAnalyzer::new(sample_rate, sum_doubling)`，但参数未使用（固定 foobar2000 兼容：2×平方和）。
- 方案：
  - 维持现状（固定开启），在文档标明“foorbar2000 兼容分支固定启用 Sum Doubling”。
  - 若未来要可配置，再显式接入 RMS 倍增路径并配测试矢量。
- 状态：建议“已澄清”（文档即可）。

5) 调试输出与错误口径对齐（零风险）
- 现状：`dr_calculator.rs` 的 TRACE 已在 `debug_assertions` 下；错误消息口径清晰。
- 方案：保持现状即可；对“多声道暂不支持”的报错保留明确提示。
- 状态：已完成。

6) SIMD 化“窗口内平方和 + abs 峰值”扫描（中等复杂度、谨慎）
- 现状：窗口内逐样本累加；SIMD 主要用于“top 20% RMS 的平方和”阶段。
- 方案：在 `process_samples()` 主循环中做块内 SIMD 累积（双通道：sumsq 与 absmax），窗口结束归约。
- 收益：在超大输入上进一步降低 CPU 时间。
- 风险：实现复杂，需确保尾窗与“双峰跟踪”逻辑正确；必须通过严密回归测试。
- 状态：暂缓，待 P95/P99 压测后再定优先级。

7) 保持 44.1kHz 特例与 3 秒窗语义（合规性）
- 说明：此为标准口径，绝不改动；所有优化以“结果等价”为第一约束。
- 状态：已确认，无需变更。

---

## 决策追踪（状态可更新）

- [ ] 1) 尾窗双峰跟踪替代样本缓存（等价）
  - 状态：待办
  - 风险：低（需回归测试）
  - 负责人：待指派
- [ ] 2) 20% 采样临时数组 clone + push 0（等价）
  - 状态：待办
  - 风险：极低
  - 负责人：待指派
- [ ] 3) `reserve` 预分配（等价）
  - 状态：待办
  - 风险：极低
  - 负责人：待指派
- [x] 4) Sum Doubling 语义澄清（文档）
  - 状态：已完成（本文件）
  - 风险：无
- [ ] 6) 窗口扫描 SIMD 化（谨慎）
  - 状态：暂缓
  - 风险：中等（实现复杂）

备注：序号与历史沟通一致，为便于引用保留空缺编号（5 为口径对齐，已完成）。

---

## 等价性与回归测试建议

必须覆盖以下场景，保证“优化前后结果 bit 级一致（或在 1e-12 内）”：

- 尾窗边界：
  - 尾窗最后样本为最大值且仅出现一次 → 调整后 Peak 应为 second_max/0。
  - 尾窗最后样本为最大值且出现多次 → 调整后 Peak 仍为 max。
  - 尾窗最后样本不是最大值 → 调整后 Peak 为 max。
- 20% 采样：
  - 恰好整除窗口（含虚拟 0 窗）与非整除窗口（无虚拟 0 窗）结果一致。
  - 少量窗口（1~5）与大量窗口（>1000）边界。
- 采样率：
  - 44.1kHz（132480）与 48/96/192kHz（3 秒窗）一致性。

验收标准：
- DR 值差异 < 1e-12；显示 RMS 差异 < 1e-12；主/次峰一致。
- 内存指标：在相同输入上，移除样本缓存后“峰值内存占用”显著下降（预计一个窗口 f64×N 的下降）。

---

## 后续建议（非功能性）

- 在 `DrCalculator` 文档中标注依赖路径与“敏感不变点”。
- 为 `WindowRmsAnalyzer` 添加小型基准（micro-bench），区分“窗口扫描阶段”和“20% 采样阶段”，为后续 SIMD 化提供基线。

---

最后更新：由审阅在 “foobar2000-plugin” 分支完成。若后续实施上述条目，请在本文件更新状态并附带 commit 链接，保持可追踪性。

