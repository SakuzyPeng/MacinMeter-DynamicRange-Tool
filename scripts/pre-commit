#!/bin/bash
# 🚀 MacinMeter DR Tool - 预提交钩子
# 与GitHub Actions相同的代码质量检查，在本地提交前执行

set -e  # 任何命令失败时立即退出

echo "🔍 MacinMeter DR Tool - 预提交质量检查"
echo "======================================"

# 🎨 1. 代码格式检查
echo ""
echo "🎨 1. 检查代码格式..."
if ! cargo fmt --check; then
    echo "❌ 代码格式检查失败！请运行 'cargo fmt' 修复格式问题"
    exit 1
fi
echo "✅ 代码格式检查通过"

# 📎 2. Clippy静态分析
echo ""
echo "📎 2. 运行Clippy静态分析..."
CLIPPY_OUTPUT=$(cargo clippy --all-targets --all-features -- -D warnings 2>&1)
CLIPPY_EXIT=$?
if [ $CLIPPY_EXIT -ne 0 ]; then
    # 只显示错误和警告，不显示成功的编译信息
    echo "$CLIPPY_OUTPUT" | grep -E "^error|^warning:" || echo "$CLIPPY_OUTPUT"
    echo "❌ Clippy检查失败！请修复上述警告"
    exit 1
fi
echo "✅ Clippy静态分析通过"

# 🔨 3. 编译检查
echo ""
echo "🔨 3. 检查代码编译..."
CHECK_OUTPUT=$(cargo check --all-targets --all-features 2>&1)
CHECK_EXIT=$?
if [ $CHECK_EXIT -ne 0 ]; then
    # 只显示错误，不显示编译进度信息
    echo "$CHECK_OUTPUT" | grep -E "^error" || echo "$CHECK_OUTPUT"
    echo "❌ 编译检查失败！请修复编译错误"
    exit 1
fi
echo "✅ 编译检查通过"

# 🧪 4. 单元测试
echo ""
echo "🧪 4. 运行单元测试..."
# 运行测试并过滤输出：只显示失败、忽略的测试和最后的统计信息
TEST_OUTPUT=$(cargo test 2>&1)
TEST_EXIT=$?

# 检查是否有失败
if echo "$TEST_OUTPUT" | grep -q "test result: FAILED"; then
    echo "$TEST_OUTPUT" | grep -E "^test .* FAILED|^test result:" || true
    echo "❌ 单元测试失败！请修复测试问题"
    exit 1
fi

# 按类型汇总统计（库单元测试、集成测试、文档测试）
echo "📊 测试结果统计："

# 提取各类型的测试统计
UNIT_LINE=$(echo "$TEST_OUTPUT" | grep "^test result:" | head -1)
INTEGRATION_LINES=$(echo "$TEST_OUTPUT" | grep -E "^Running.*tests/|^     Running.*tests/" -A 1000 | grep "^test result:" | head -20)
DOC_LINES=$(echo "$TEST_OUTPUT" | grep "Doc-tests" -A 1000 | grep "^test result:")

# 解析单元测试统计
if [ -n "$UNIT_LINE" ]; then
    UNIT_P=$(echo "$UNIT_LINE" | grep -oE "[0-9]+ passed" | head -1 | grep -oE "[0-9]+")
    UNIT_I=$(echo "$UNIT_LINE" | grep -oE "[0-9]+ ignored" | head -1 | grep -oE "[0-9]+")
    echo "  单元测试:  ✅ ${UNIT_P:-0} | ⚠️  ${UNIT_I:-0}"
else
    UNIT_P=0
    UNIT_I=0
fi

# 解析集成测试统计
INT_P=0
INT_I=0
echo "$INTEGRATION_LINES" | while read -r line; do
    [ -z "$line" ] && continue
    P=$(echo "$line" | grep -oE "[0-9]+ passed" | head -1 | grep -oE "[0-9]+")
    I=$(echo "$line" | grep -oE "[0-9]+ ignored" | head -1 | grep -oE "[0-9]+")
    INT_P=$((INT_P + ${P:-0}))
    INT_I=$((INT_I + ${I:-0}))
done | tail -1

# 简单方式：直接计算所有test result的总和
TOTAL_P=$(echo "$TEST_OUTPUT" | grep "^test result:" | grep -oE "[0-9]+ passed" | grep -oE "[0-9]+" | awk '{sum+=$1} END {print sum}')
TOTAL_I=$(echo "$TEST_OUTPUT" | grep "^test result:" | grep -oE "[0-9]+ ignored" | grep -oE "[0-9]+" | awk '{sum+=$1} END {print sum}')

echo "  集成测试:  ✅ $(($TOTAL_P - ${UNIT_P:-0})) | ⚠️  $(($TOTAL_I - ${UNIT_I:-0}))"
echo "  ─────────────────────────"
echo "  总  计:    ✅ ${TOTAL_P:-0} | ⚠️  ${TOTAL_I:-0}"

echo "✅ 单元测试通过"

# 🛡️ 5. 安全审计 (可选，如果安装了cargo-audit)
echo ""
echo "🛡️ 5. 安全审计..."
if command -v cargo-audit &> /dev/null; then
    if ! cargo audit --ignore RUSTSEC-0000-0000; then
        echo "⚠️  安全审计发现依赖问题（可能是已知的songbird依赖）"
        echo "💡 运行 'cargo audit' 查看详情，或继续提交"
    else
        echo "✅ 安全审计通过"
    fi
else
    echo "⚠️  cargo-audit未安装，跳过安全审计"
    echo "💡 运行 'cargo install cargo-audit' 安装"
fi

# 🎉 所有检查通过
echo ""
echo "🎉 所有检查通过！可以安全提交"
echo "======================================"

# 📊 显示一些有用的信息
echo ""
echo "📊 提交前信息:"
echo "  📁 工作目录: $(pwd)"
echo "  🦀 Rust版本: $(rustc --version)"
echo "  📦 Cargo版本: $(cargo --version)"
echo "  🔧 目标平台: $(rustc -vV | grep host | cut -d' ' -f2)"

echo ""
echo "💡 提示: 这个钩子与GitHub Actions CI保持同步"
echo "   如果本地检查通过，远程CI也应该能通过"