#!/bin/bash
# 🚀 MacinMeter DR Tool - 预提交钩子
# 与GitHub Actions相同的代码质量检查，在本地提交前执行

set -e  # 任何命令失败时立即退出

echo "🔍 MacinMeter DR Tool - 预提交质量检查"
echo "======================================"

# 🎨 1. 代码格式检查
echo ""
echo "🎨 1. 检查代码格式..."
if ! cargo fmt --check; then
    echo "❌ 代码格式检查失败！请运行 'cargo fmt' 修复格式问题"
    exit 1
fi
echo "✅ 代码格式检查通过"

# 📎 2. Clippy静态分析
echo ""
echo "📎 2. 运行Clippy静态分析..."
CLIPPY_OUTPUT=$(cargo clippy --all-targets --all-features -- -D warnings 2>&1)
CLIPPY_EXIT=$?
if [ $CLIPPY_EXIT -ne 0 ]; then
    # 只显示错误和警告，不显示成功的编译信息
    echo "$CLIPPY_OUTPUT" | grep -E "^error|^warning:" || echo "$CLIPPY_OUTPUT"
    echo "❌ Clippy检查失败！请修复上述警告"
    exit 1
fi
echo "✅ Clippy静态分析通过"

# 🔨 3. 编译检查
echo ""
echo "🔨 3. 检查代码编译..."
CHECK_OUTPUT=$(cargo check --all-targets --all-features 2>&1)
CHECK_EXIT=$?
if [ $CHECK_EXIT -ne 0 ]; then
    # 只显示错误，不显示编译进度信息
    echo "$CHECK_OUTPUT" | grep -E "^error" || echo "$CHECK_OUTPUT"
    echo "❌ 编译检查失败！请修复编译错误"
    exit 1
fi
echo "✅ 编译检查通过"

# 🧪 4. 单元测试
echo ""
echo "🧪 4. 运行单元测试..."
# 运行测试并过滤输出：只显示失败、忽略的测试和最后的统计信息
TEST_OUTPUT=$(cargo test 2>&1)
TEST_EXIT=$?

# 检查是否有失败
if echo "$TEST_OUTPUT" | grep -q "test result: FAILED"; then
    echo "$TEST_OUTPUT" | grep -E "^test .* FAILED|^test result:" || true
    echo "❌ 单元测试失败！请修复测试问题"
    exit 1
fi

# 按类型汇总统计（库测试、集成测试、doc测试）
# 只显示有忽略或失败的行，以及最后的总体统计
echo "📊 测试结果统计："

TOTAL_PASSED=0
TOTAL_IGNORED=0
TOTAL_FAILED=0
CURRENT_TEST_TYPE=""

# 提取带有测试套件信息的行，关联 running 和 test result
{
    echo "$TEST_OUTPUT" | grep -E "^Running|^     Running|^test result:" | {
        while read -r line; do
            if echo "$line" | grep -q "Running"; then
                # 提取当前测试套件名称 (如 "tests/boundary_tests.rs", "src/lib.rs")
                CURRENT_TEST_TYPE=$(echo "$line" | grep -oE '\(.*\)' | tr -d '()' | sed 's|.*/||')
            elif echo "$line" | grep -q "^test result:"; then
                # 解析统计信息
                PASSED=$(echo "$line" | grep -oE "[0-9]+ passed" | head -1 | grep -oE "[0-9]+")
                FAILED=$(echo "$line" | grep -oE "[0-9]+ failed" | head -1 | grep -oE "[0-9]+")
                IGNORED=$(echo "$line" | grep -oE "[0-9]+ ignored" | head -1 | grep -oE "[0-9]+")

                TOTAL_PASSED=$((TOTAL_PASSED + ${PASSED:-0}))
                TOTAL_IGNORED=$((TOTAL_IGNORED + ${IGNORED:-0}))
                TOTAL_FAILED=$((TOTAL_FAILED + ${FAILED:-0}))

                # 只显示有忽略或失败的行
                if [ "${IGNORED:-0}" != "0" ] || [ "${FAILED:-0}" != "0" ]; then
                    # 如果没有套件名，用编号表示
                    SUITE_NAME="${CURRENT_TEST_TYPE:-tests}"
                    STATS="${SUITE_NAME}: ✅ ${PASSED:-0}通过 "
                    [ "${IGNORED:-0}" != "0" ] && STATS="${STATS}⚠️  ${IGNORED}忽略 "
                    [ "${FAILED:-0}" != "0" ] && STATS="${STATS}❌ ${FAILED}失败 "
                    echo "  • $STATS"
                fi
            fi
        done

        # 显示总体统计
        echo "  • 总计: ✅ ${TOTAL_PASSED} | ⚠️  ${TOTAL_IGNORED}"
    }
}

echo "✅ 单元测试通过"

# 🛡️ 5. 安全审计 (可选，如果安装了cargo-audit)
echo ""
echo "🛡️ 5. 安全审计..."
if command -v cargo-audit &> /dev/null; then
    if ! cargo audit --ignore RUSTSEC-0000-0000; then
        echo "⚠️  安全审计发现依赖问题（可能是已知的songbird依赖）"
        echo "💡 运行 'cargo audit' 查看详情，或继续提交"
    else
        echo "✅ 安全审计通过"
    fi
else
    echo "⚠️  cargo-audit未安装，跳过安全审计"
    echo "💡 运行 'cargo install cargo-audit' 安装"
fi

# 🎉 所有检查通过
echo ""
echo "🎉 所有检查通过！可以安全提交"
echo "======================================"

# 📊 显示一些有用的信息
echo ""
echo "📊 提交前信息:"
echo "  📁 工作目录: $(pwd)"
echo "  🦀 Rust版本: $(rustc --version)"
echo "  📦 Cargo版本: $(cargo --version)"
echo "  🔧 目标平台: $(rustc -vV | grep host | cut -d' ' -f2)"

echo ""
echo "💡 提示: 这个钩子与GitHub Actions CI保持同步"
echo "   如果本地检查通过，远程CI也应该能通过"