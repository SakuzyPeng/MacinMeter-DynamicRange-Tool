#!/bin/bash
# ğŸš€ MacinMeter DR Tool - é¢„æäº¤é’©å­
# ä¸GitHub Actionsç›¸åŒçš„ä»£ç è´¨é‡æ£€æŸ¥ï¼Œåœ¨æœ¬åœ°æäº¤å‰æ‰§è¡Œ

set -e  # ä»»ä½•å‘½ä»¤å¤±è´¥æ—¶ç«‹å³é€€å‡º

echo "ğŸ” MacinMeter DR Tool - é¢„æäº¤è´¨é‡æ£€æŸ¥"
echo "======================================"

# ğŸ¨ 1. ä»£ç æ ¼å¼æ£€æŸ¥
echo ""
echo "ğŸ¨ 1. æ£€æŸ¥ä»£ç æ ¼å¼..."
if ! cargo fmt --check; then
    echo "âŒ ä»£ç æ ¼å¼æ£€æŸ¥å¤±è´¥ï¼è¯·è¿è¡Œ 'cargo fmt' ä¿®å¤æ ¼å¼é—®é¢˜"
    exit 1
fi
echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"

# ğŸ“ 2. Clippyé™æ€åˆ†æ
echo ""
echo "ğŸ“ 2. è¿è¡ŒClippyé™æ€åˆ†æ..."
CLIPPY_OUTPUT=$(cargo clippy --all-targets --all-features -- -D warnings 2>&1)
CLIPPY_EXIT=$?
if [ $CLIPPY_EXIT -ne 0 ]; then
    # åªæ˜¾ç¤ºé”™è¯¯å’Œè­¦å‘Šï¼Œä¸æ˜¾ç¤ºæˆåŠŸçš„ç¼–è¯‘ä¿¡æ¯
    echo "$CLIPPY_OUTPUT" | grep -E "^error|^warning:" || echo "$CLIPPY_OUTPUT"
    echo "âŒ Clippyæ£€æŸ¥å¤±è´¥ï¼è¯·ä¿®å¤ä¸Šè¿°è­¦å‘Š"
    exit 1
fi
echo "âœ… Clippyé™æ€åˆ†æé€šè¿‡"

# ğŸ”¨ 3. ç¼–è¯‘æ£€æŸ¥
echo ""
echo "ğŸ”¨ 3. æ£€æŸ¥ä»£ç ç¼–è¯‘..."
CHECK_OUTPUT=$(cargo check --all-targets --all-features 2>&1)
CHECK_EXIT=$?
if [ $CHECK_EXIT -ne 0 ]; then
    # åªæ˜¾ç¤ºé”™è¯¯ï¼Œä¸æ˜¾ç¤ºç¼–è¯‘è¿›åº¦ä¿¡æ¯
    echo "$CHECK_OUTPUT" | grep -E "^error" || echo "$CHECK_OUTPUT"
    echo "âŒ ç¼–è¯‘æ£€æŸ¥å¤±è´¥ï¼è¯·ä¿®å¤ç¼–è¯‘é”™è¯¯"
    exit 1
fi
echo "âœ… ç¼–è¯‘æ£€æŸ¥é€šè¿‡"

# ğŸ§ª 4. å•å…ƒæµ‹è¯•
echo ""
echo "ğŸ§ª 4. è¿è¡Œå•å…ƒæµ‹è¯•..."
# ç›´æ¥è¿è¡Œæµ‹è¯•ï¼Œcargo test ä¼šè‡ªåŠ¨æ˜¾ç¤ºè¾“å‡º
cargo test
TEST_RESULT=$?
if [ $TEST_RESULT -ne 0 ]; then
    echo "âŒ å•å…ƒæµ‹è¯•å¤±è´¥ï¼è¯·ä¿®å¤æµ‹è¯•é—®é¢˜"
    exit 1
fi
echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"

# ğŸ³ 5. x86 Docker CIæ¨¡æ‹Ÿæµ‹è¯•ï¼ˆè·¨å¹³å°éªŒè¯ï¼‰
echo ""
echo "ğŸ³ 5. x86 Docker CIæ¨¡æ‹Ÿæµ‹è¯•..."

#!/usr/bin/env bash
# æ£€æµ‹æ˜¯å¦å­˜åœ¨ä¸ç¼–è¯‘/æµ‹è¯•ç›¸å…³çš„ä»£ç å˜æ›´ï¼ˆä»…åœ¨å˜æ›´æ—¶æ‰è¿è¡ŒDockerï¼‰
# ä¼˜å…ˆä½¿ç”¨å·²æš‚å­˜ï¼ˆstagedï¼‰çš„å˜æ›´ï¼›è‹¥ä¸ºç©ºåˆ™å›é€€åˆ°å·¥ä½œåŒºå˜æ›´
CODE_CHANGED=0
if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACMRTUXB)
    if [ -z "$CHANGED_FILES" ]; then
        CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRTUXB)
    fi
    # é€æ¡åˆ¤å®šï¼Œåªæœ‰å‘½ä¸­ä»¥ä¸‹è·¯å¾„æ‰è®¤ä¸ºæ˜¯â€œä»£ç å˜æ›´â€
    while IFS= read -r f; do
        case "$f" in
            src/*|tests/*|benches/*|examples/*|build.rs|Cargo.toml|Cargo.lock)
                CODE_CHANGED=1; break ;;
            *) ;;
        esac
    done <<< "$CHANGED_FILES"
fi

# å…è®¸é€šè¿‡ç¯å¢ƒå˜é‡å¼ºåˆ¶è¿è¡Œæˆ–å¼ºåˆ¶è·³è¿‡
if [ "${PRECOMMIT_FORCE_DOCKER:-}" = "1" ]; then
    CODE_CHANGED=1
elif [ "${PRECOMMIT_SKIP_DOCKER:-}" = "1" ]; then
    CODE_CHANGED=0
fi

if [ "$CODE_CHANGED" -ne 1 ]; then
    echo "â­ï¸  æœªæ£€æµ‹åˆ°ä¸æ„å»º/æµ‹è¯•ç›¸å…³çš„ä»£ç å˜æ›´ï¼Œè·³è¿‡Docker CIæ¨¡æ‹Ÿ"
else
    if command -v docker &> /dev/null; then
        # æ£€æŸ¥æ˜¯å¦æœ‰ macinmeter-ci é•œåƒ
        if docker images macinmeter-ci:standalone -q | grep -q .; then
            echo "   æ­£åœ¨ä½¿ç”¨Dockeræ¨¡æ‹Ÿx86 CIç¯å¢ƒè¿è¡Œå®Œæ•´æµ‹è¯•..."
            echo "   å¼€å§‹æ—¶é—´: $(date +%H:%M:%S)"

            DOCKER_START=$(date +%s)
            # ä½¿ç”¨é¡¹ç›®ä¸“ç”¨CIé•œåƒï¼ˆå·²é¢„è£…æ‰€æœ‰ä¾èµ–ï¼‰
            if docker run --rm \
                --platform linux/amd64 \
                -v "$(pwd):/workspace" \
                -w /workspace \
                macinmeter-ci:standalone \
                bash -c "cargo test 2>&1 | tail -100"; then
                DOCKER_END=$(date +%s)
                DOCKER_TIME=$((DOCKER_END - DOCKER_START))
                echo "âœ… x86 Docker CIæµ‹è¯•é€šè¿‡ (ç”¨æ—¶: ${DOCKER_TIME}ç§’)"
            else
                echo "âŒ x86 Docker CIæµ‹è¯•å¤±è´¥ï¼"
                echo "ğŸ’¡ æç¤º: è¿™å¯èƒ½æ˜¯è·¨å¹³å°å·®å¼‚ï¼Œè¯·æ£€æŸ¥ä¸Šè¿°é”™è¯¯"
                exit 1
            fi
        else
            echo "âš ï¸  macinmeter-ci:standalone é•œåƒæœªæ‰¾åˆ°ï¼Œè·³è¿‡x86 CIæ¨¡æ‹Ÿ"
            echo "ğŸ’¡ æç¤º: è¿è¡Œ 'docker pull macinmeter-ci:standalone' æˆ–æ„å»ºé•œåƒ"
        fi
    else
        echo "âš ï¸  Dockeræœªå®‰è£…ï¼Œè·³è¿‡x86 CIæ¨¡æ‹Ÿæµ‹è¯•"
        echo "ğŸ’¡ å»ºè®®å®‰è£…Dockerä»¥åœ¨æœ¬åœ°éªŒè¯x86å…¼å®¹æ€§"
    fi
fi

# ğŸ›¡ï¸ 6. å®‰å…¨å®¡è®¡ (å¯é€‰ï¼Œå¦‚æœå®‰è£…äº†cargo-audit)
echo ""
echo "ğŸ›¡ï¸ 6. å®‰å…¨å®¡è®¡..."
if command -v cargo-audit &> /dev/null; then
    if ! cargo audit --ignore RUSTSEC-0000-0000; then
        echo "âš ï¸  å®‰å…¨å®¡è®¡å‘ç°ä¾èµ–é—®é¢˜ï¼ˆå¯èƒ½æ˜¯å·²çŸ¥çš„songbirdä¾èµ–ï¼‰"
        echo "ğŸ’¡ è¿è¡Œ 'cargo audit' æŸ¥çœ‹è¯¦æƒ…ï¼Œæˆ–ç»§ç»­æäº¤"
    else
        echo "âœ… å®‰å…¨å®¡è®¡é€šè¿‡"
    fi
else
    echo "âš ï¸  cargo-auditæœªå®‰è£…ï¼Œè·³è¿‡å®‰å…¨å®¡è®¡"
    echo "ğŸ’¡ è¿è¡Œ 'cargo install cargo-audit' å®‰è£…"
fi

# ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡
echo ""
echo "ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼å¯ä»¥å®‰å…¨æäº¤"
echo "======================================"

# ğŸ“Š æ˜¾ç¤ºä¸€äº›æœ‰ç”¨çš„ä¿¡æ¯
echo ""
echo "ğŸ“Š æäº¤å‰ä¿¡æ¯:"
echo "  ğŸ“ å·¥ä½œç›®å½•: $(pwd)"
echo "  ğŸ¦€ Rustç‰ˆæœ¬: $(rustc --version)"
echo "  ğŸ“¦ Cargoç‰ˆæœ¬: $(cargo --version)"
echo "  ğŸ”§ ç›®æ ‡å¹³å°: $(rustc -vV | grep host | cut -d' ' -f2)"

echo ""
echo "ğŸ’¡ æç¤º: è¿™ä¸ªé’©å­ä¸GitHub Actions CIä¿æŒåŒæ­¥"
echo "   å¦‚æœæœ¬åœ°æ£€æŸ¥é€šè¿‡ï¼Œè¿œç¨‹CIä¹Ÿåº”è¯¥èƒ½é€šè¿‡"
