name: CI/CD Pipeline - MacinMeter DR Tool

on:
  push:
    branches: [ master, main, early-version, foobar2000-plugin, ui-wrapper ]
    tags: [ 'v*' ]
    # 避免纯文档/说明类改动触发完整CI（仍可手动workflow_dispatch）
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - 'README'
      - 'README.*'
      - 'CHANGELOG*'
      - 'LICENSE*'
      - 'SILENCE_FILTERING_PLAN.md'
  pull_request:
    branches: [ master, main, early-version, foobar2000-plugin, ui-wrapper ]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - 'README'
      - 'README.*'
      - 'CHANGELOG*'
      - 'LICENSE*'
      - 'SILENCE_FILTERING_PLAN.md'
  workflow_dispatch:  # 允许手动触发
    inputs:
      skip_tests:
        description: 'Skip tests for faster builds'
        type: boolean
        default: false
      build_targets:
        description: 'Specific targets to build (comma-separated)'
        type: string
        default: 'all'

# [CONCURRENCY] 私有仓库优化：并发限制和资源管理
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # 私有仓库优化：减少网络重试
  CARGO_NET_RETRY: 2
  CARGO_NET_TIMEOUT: 30

jobs:
  # [DETECT] 快速变更检测 - 私有仓库优化
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      rust: ${{ steps.changes.outputs.rust }}
      docs: ${{ steps.changes.outputs.docs }}
    steps:
    - name: "[DISK] Disk usage (preflight)"
      run: |
        echo "Filesystem usage before job:"
        df -h || true
        echo "Workspace usage (top 20):"
        du -xh -d1 . 2>/dev/null | sort -h | tail -n 20 || true
        echo "Home cache usage (if any):"
        du -xh -d1 "$HOME/.cache" 2>/dev/null | sort -h | tail -n 20 || true
    - name: "[CHECKOUT] Checkout Repository"
      uses: actions/checkout@v4

    - name: "[FILTER] Check for Rust Code Changes"
      uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          rust:
            - 'src/**/*.rs'
            - 'Cargo.toml'
            - 'Cargo.lock'
            - '.github/workflows/**'
            - 'tests/**/*.rs'
          docs:
            - 'README.md'
            - 'docs/**'
            - '*.md'
            - 'CLAUDE.md'
            - 'API_REFERENCE.md'

  # [QUALITY] 代码质量检查和安全审计
  quality-check:
    name: Code Quality & Security Audit
    needs: changes
    if: ${{ needs.changes.outputs.rust == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    env:
      # CI环境专用设置 - 质量检查使用原生目标，避免跨编译复杂性
      RUSTFLAGS: '-C opt-level=3'  # 简化编译标志避免特性冲突

    steps:
    - name: "[DISK] Disk usage (preflight - Windows)"
      if: matrix.os == 'windows-latest'
      run: |
        Write-Host "Filesystem usage before build (Windows):"
        Get-PSDrive -PSProvider FileSystem | Format-Table -AutoSize
    - name: "[DISK] Disk usage (preflight - Unix)"
      if: matrix.os != 'windows-latest'
      shell: bash
      run: |
        echo "Filesystem usage before build:"
        df -h || true
        echo "Workspace usage (top 20):"
        du -xh -d1 . 2>/dev/null | sort -h | tail -n 20 || true
    - name: "[CHECKOUT] Checkout Repository"
      uses: actions/checkout@v4

    - name: "[RUST] Install Rust Toolchain"
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: "[CACHE] Smart Cache - Cargo Registry (crates.io)"
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-

    # 注意：跳过git依赖缓存，因为项目仅使用crates.io依赖

    # 说明：质量检查阶段不再缓存 target/ 以减少磁盘占用（避免在自托管Runner上积累）

    - name: "[CACHE] Cache Cargo Tools (Stable Key)"
      uses: actions/cache@v4
      id: cargo-tools-cache
      with:
        path: |
          ~/.cargo/bin/cargo-audit
          ~/.cargo/.crates.toml
          ~/.cargo/.crates2.json
        key: ${{ runner.os }}-cargo-audit-v4-stable
        restore-keys: |
          ${{ runner.os }}-cargo-audit-v4-
          ${{ runner.os }}-cargo-audit-

    - name: "[INSTALL] Install Security Audit Tool (Optimized Cache)"
      run: |
        echo "[CHECK] 检测cargo-audit缓存状态..."
        echo "缓存命中状态: '${{ steps.cargo-tools-cache.outputs.cache-hit }}'"

        # 检查cargo-audit是否存在且可用
        if command -v cargo-audit &> /dev/null && cargo-audit --version &> /dev/null; then
          echo "[OK] cargo-audit已可用（缓存恢复或已安装）"
          cargo-audit --version
        else
          echo "[INSTALL] 安装cargo-audit（缓存未命中或损坏）..."
          cargo install --locked cargo-audit
          echo "[OK] 新安装完成："
          cargo-audit --version
        fi

    - name: "[FMT] Check Code Formatting"
      run: |
        echo "[FMT] Checking code formatting..."
        cargo fmt --all -- --check

    - name: "[LINT] Run Clippy Static Analysis"
      run: |
        echo "[LINT] Running Clippy static analysis..."
        cargo clippy --all-targets --all-features -- -D warnings -D unused-unsafe -D unsafe-op-in-unsafe-fn

    - name: "[BUILD] Compile Check"
      run: |
        echo "[BUILD] Running compile check..."
        cargo check --all-targets --all-features

    - name: "[AUDIT] Security Audit"
      run: |
        echo "[AUDIT] Running security audit (stale DB to reduce writes)..."
        cargo audit --stale \
          --ignore RUSTSEC-2025-0009 --ignore RUSTSEC-2024-0336 \
          --ignore RUSTSEC-2023-0065 --ignore RUSTSEC-2025-0055 \
          --ignore RUSTSEC-2024-0388 --ignore RUSTSEC-2025-0010

    - name: "[TEST] Run Unit Tests"
      if: ${{ !github.event.inputs.skip_tests }}
      run: |
        echo "[TEST] Running unit tests..."
        cargo test --all-features -- --nocapture

    - name: "[CLEANUP] Cleanup workspace (free disk)"
      if: always()
      run: |
        echo "Cleaning target/ and temporary registries to free disk..."
        rm -rf target || true
        rm -rf "$HOME/.cargo/registry/src" || true
        echo "Filesystem usage after cleanup:"
        df -h || true

    - name: "[COVERAGE] Generate Test Coverage (Optional)"
      run: |
        echo "[COVERAGE] Test coverage analysis completed"
        # 可以添加 tarpaulin 或其他覆盖率工具

  # [BUILD] 多平台构建
  build:
    name: Build (${{ matrix.platform }}-${{ matrix.arch }})
    needs: [changes, quality-check]  # 依赖变更检测和质量检查
    # 私有仓库优化：条件构建
    if: ${{ needs.changes.outputs.rust == 'true' || github.event_name == 'workflow_dispatch' }}
    strategy:
      fail-fast: false
      max-parallel: 2  # 私有仓库优化：限制并发以避免资源争用
      matrix:
        include:
          # Windows x64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            platform: windows
            arch: x64
            extension: .exe

          # macOS Intel (Native)
          - os: macos-latest
            target: x86_64-apple-darwin
            platform: macos
            arch: intel
            extension: ""

          # macOS Apple Silicon (Native)
          - os: macos-15
            target: aarch64-apple-darwin
            platform: macos
            arch: arm64
            extension: ""

          # Linux x64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux
            arch: x64
            extension: ""

    runs-on: ${{ matrix.os }}

    steps:
    - name: "[CHECKOUT] Checkout Repository"
      uses: actions/checkout@v4

    - name: "[RUST] Install Rust Toolchain"
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    # 显式安装交叉编译目标 (确保可靠性)
    - name: "[TARGET] Install Cross-compilation Target"
      run: |
        echo "[TARGET] Installing target: ${{ matrix.target }}"
        rustup target add ${{ matrix.target }}
        rustup target list --installed | grep ${{ matrix.target }} || (echo "[FAIL] Target installation failed" && exit 1)
        echo "[OK] Target ${{ matrix.target }} successfully installed"

    # 多层缓存策略优化 - 私有仓库友好
    - name: "[CACHE] Platform Cache - Cargo Registry"
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
        key: cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          cargo-registry-

    - name: "[CACHE] Platform Cache - Git Dependencies"
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git/db/
        key: cargo-git-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          cargo-git-

    # 注意：尽量避免缓存 target/（占用大且容易填满自托管磁盘）；
    # 如需缓存编译产物，请改用 Swatinem/rust-cache 并限定 save-if 仅在主分支保存。

    # 生成精确到秒的时间戳（UTC时区） - Windows
    - name: "[TIME] Generate Timestamp (Windows)"
      if: matrix.os == 'windows-latest'
      id: timestamp-windows
      run: |
        $timestamp = Get-Date -Format "yyyy-MM-dd-HH-mm-ss-UTC" -AsUTC
        echo "timestamp=$timestamp" >> $env:GITHUB_OUTPUT
        echo "date_tag=$timestamp" >> $env:GITHUB_OUTPUT
      shell: pwsh

    # 生成精确到秒的时间戳（UTC时区） - Unix
    - name: "[TIME] Generate Timestamp (Unix)"
      if: matrix.os != 'windows-latest'
      id: timestamp-unix
      run: |
        timestamp=$(date -u +"%Y-%m-%d-%H-%M-%S-UTC")
        echo "timestamp=$timestamp" >> $GITHUB_OUTPUT
        echo "date_tag=$timestamp" >> $GITHUB_OUTPUT
      shell: bash

    # 统一时间戳输出 - Windows
    - name: "[TIME] Set Unified Timestamp (Windows)"
      if: matrix.os == 'windows-latest'
      id: timestamp-win
      run: |
        echo "timestamp=${{ steps.timestamp-windows.outputs.timestamp }}" >> $env:GITHUB_OUTPUT
        echo "date_tag=${{ steps.timestamp-windows.outputs.date_tag }}" >> $env:GITHUB_OUTPUT
      shell: pwsh

    # 统一时间戳输出 - Unix
    - name: "[TIME] Set Unified Timestamp (Unix)"
      if: matrix.os != 'windows-latest'
      id: timestamp-nix
      run: |
        echo "timestamp=${{ steps.timestamp-unix.outputs.timestamp }}" >> $GITHUB_OUTPUT
        echo "date_tag=${{ steps.timestamp-unix.outputs.date_tag }}" >> $GITHUB_OUTPUT
      shell: bash

    # 统一时间戳ID输出
    - name: "[TIME] Set Final Timestamp ID"
      id: timestamp
      run: |
        # 这一步只是为了保持后续步骤的兼容性
        echo "Final timestamp ID set for downstream steps"
      shell: bash

    - name: "[BUILD] Build Release Binary"
      env:
        # CI专用环境变量 - RUSTFLAGS在脚本中动态设置
        CI_TARGET: ${{ matrix.target }}
        # 修复audiopus_sys CMake版本兼容性问题（仅macOS需要）
        CMAKE_POLICY_VERSION_MINIMUM: ${{ contains(matrix.os, 'macos') && '3.5' || '' }}
      run: |
        echo "[BUILD] Building release binary for ${{ matrix.platform }}-${{ matrix.arch }}..."
        echo "[INFO] Build environment info:"
        echo "  Target: ${{ matrix.target }}"
        echo "  OS: ${{ matrix.os }}"
        echo "  Platform: ${{ matrix.platform }}"
        echo "  Arch: ${{ matrix.arch }}"

        # 动态设置RUSTFLAGS避免架构冲突
        case "$CI_TARGET" in
          "aarch64-apple-darwin")
            export RUSTFLAGS="-C target-feature=+neon -C opt-level=3"
            echo "[ARM64] ARM64 macOS: Using NEON optimizations"
            ;;
          "x86_64-apple-darwin"|"x86_64-pc-windows-msvc"|"x86_64-unknown-linux-gnu")
            export RUSTFLAGS="-C target-feature=+sse2,+sse3,+sse4.1,+sse4.2,+avx,+avx2 -C opt-level=3"
            echo "[X64] x86_64: Using SSE/AVX optimizations"
            ;;
          *)
            export RUSTFLAGS="-C opt-level=3"
            echo "[GENERIC] Generic: Using standard optimizations"
            ;;
        esac
        echo "  RUSTFLAGS: $RUSTFLAGS"

        echo "[CHECK] Verifying Rust setup:"
        rustc --version
        cargo --version
        rustup show

        echo "[TARGET] Using GitHub Actions native runner strategy:"
        echo "  Runner OS: ${{ matrix.os }}"
        echo "  Target: ${{ matrix.target }}"

        # 统一使用原生构建策略避免跨编译复杂性
        echo "[BUILD] Building for target: ${{ matrix.target }}"
        echo "[TIP] Using GitHub Actions native runner for ${{ matrix.target }}"

        # macOS特定的CMake兼容性处理
        if [[ "${{ matrix.os }}" == macos* ]]; then
          echo "[MACOS] macOS detected: Setting CMake compatibility flags for audiopus_sys"
          export CMAKE_POLICY_VERSION_MINIMUM=3.5
          export CMAKE_ARGS="-DCMAKE_POLICY_VERSION_MINIMUM=3.5"
        fi

        # 直接构建，依赖GitHub Actions的runner原生支持
        cargo build --release --verbose

        # 构建 dr-bench 基准测试工具
        echo "[BUILD] Building dr-bench benchmark tool..."
        cargo build --release --bin dr-bench --verbose
      shell: bash
    # 准备二进制文件 - Windows
    - name: "[BINARY] Prepare Binary with Timestamp (Windows)"
      if: matrix.os == 'windows-latest'
      id: binary-windows
      run: |
        $binary_name = "MacinMeter-DR-Tool-${{ steps.timestamp-windows.outputs.timestamp }}-${{ matrix.platform }}-${{ matrix.arch }}${{ matrix.extension }}"

        # 智能路径检测 - Native vs Cross-compilation
        $native_path = "target/release/MacinMeter-DynamicRange-Tool-foo_dr${{ matrix.extension }}"
        $cross_path = "target/${{ matrix.target }}/release/MacinMeter-DynamicRange-Tool-foo_dr${{ matrix.extension }}"

        if (Test-Path $native_path) {
          Write-Host "[OK] Using native build path: $native_path"
          $source_path = $native_path
        } elseif (Test-Path $cross_path) {
          Write-Host "[OK] Using cross-compilation path: $cross_path"
          $source_path = $cross_path
        } else {
          Write-Host "[FAIL] Binary not found in either path!"
          Write-Host "  Native path: $native_path"
          Write-Host "  Cross path: $cross_path"
          exit 1
        }

        Copy-Item $source_path $binary_name
        echo "binary_name=$binary_name" >> $env:GITHUB_OUTPUT
        echo "binary_path=$binary_name" >> $env:GITHUB_OUTPUT

        # 准备 dr-bench
        $bench_name = "dr-bench-${{ steps.timestamp-windows.outputs.timestamp }}-${{ matrix.platform }}-${{ matrix.arch }}${{ matrix.extension }}"
        $bench_native = "target/release/dr-bench${{ matrix.extension }}"
        if (Test-Path $bench_native) {
          Copy-Item $bench_native $bench_name
          echo "bench_name=$bench_name" >> $env:GITHUB_OUTPUT
        }
      shell: pwsh

    # 准备二进制文件 - Unix
    - name: "[BINARY] Prepare Binary with Timestamp (Unix)"
      if: matrix.os != 'windows-latest'
      id: binary-unix
      run: |
        binary_name="MacinMeter-DR-Tool-${{ steps.timestamp-unix.outputs.timestamp }}-${{ matrix.platform }}-${{ matrix.arch }}${{ matrix.extension }}"

        # 智能路径检测 - Native vs Cross-compilation
        native_path="target/release/MacinMeter-DynamicRange-Tool-foo_dr${{ matrix.extension }}"
        cross_path="target/${{ matrix.target }}/release/MacinMeter-DynamicRange-Tool-foo_dr${{ matrix.extension }}"

        if [ -f "$native_path" ]; then
          echo "[OK] Using native build path: $native_path"
          source_path="$native_path"
        elif [ -f "$cross_path" ]; then
          echo "[OK] Using cross-compilation path: $cross_path"
          source_path="$cross_path"
        else
          echo "[FAIL] Binary not found in either path!"
          echo "  Native path: $native_path"
          echo "  Cross path: $cross_path"
          exit 1
        fi

        cp "$source_path" "$binary_name"
        chmod +x "$binary_name"  # 确保可执行权限
        echo "binary_name=$binary_name" >> $GITHUB_OUTPUT
        echo "binary_path=$binary_name" >> $GITHUB_OUTPUT

        # 准备 dr-bench
        bench_name="dr-bench-${{ steps.timestamp-unix.outputs.timestamp }}-${{ matrix.platform }}-${{ matrix.arch }}${{ matrix.extension }}"
        bench_native="target/release/dr-bench${{ matrix.extension }}"
        if [ -f "$bench_native" ]; then
          cp "$bench_native" "$bench_name"
          chmod +x "$bench_name"
          echo "bench_name=$bench_name" >> $GITHUB_OUTPUT
        fi
      shell: bash

    # 统一二进制输出 - Windows
    - name: "[BINARY] Set Unified Binary Info (Windows)"
      if: matrix.os == 'windows-latest'
      id: binary-win
      run: |
        echo "binary_name=${{ steps.binary-windows.outputs.binary_name }}" >> $env:GITHUB_OUTPUT
        echo "binary_path=${{ steps.binary-windows.outputs.binary_path }}" >> $env:GITHUB_OUTPUT
      shell: pwsh

    # 统一二进制输出 - Unix
    - name: "[BINARY] Set Unified Binary Info (Unix)"
      if: matrix.os != 'windows-latest'
      id: binary-nix
      run: |
        echo "binary_name=${{ steps.binary-unix.outputs.binary_name }}" >> $GITHUB_OUTPUT
        echo "binary_path=${{ steps.binary-unix.outputs.binary_path }}" >> $GITHUB_OUTPUT
      shell: bash

    # 统一二进制ID输出
    - name: "[BINARY] Set Final Binary ID"
      id: binary
      run: |
        # 这一步只是为了保持后续步骤的兼容性
        echo "Final binary ID set for downstream steps"
      shell: bash

    # 验证二进制文件 - Windows
    - name: "[VERIFY] Verify Binary (Windows)"
      if: matrix.os == 'windows-latest'
      run: |
        echo "[CHECK] Verifying built binary..."
        if (Test-Path "${{ steps.binary-windows.outputs.binary_path }}") {
          $size = (Get-Item "${{ steps.binary-windows.outputs.binary_path }}").Length
          Write-Host "[OK] Binary verified: ${{ steps.binary-windows.outputs.binary_name }} ($size bytes)"
        } else {
          Write-Host "[FAIL] Binary not found!"
          exit 1
        }
      shell: pwsh

    # 验证二进制文件 - Unix
    - name: "[VERIFY] Verify Binary (Unix)"
      if: matrix.os != 'windows-latest'
      run: |
        echo "[CHECK] Verifying built binary..."
        if [ -f "${{ steps.binary-unix.outputs.binary_path }}" ]; then
          size=$(stat -c%s "${{ steps.binary-unix.outputs.binary_path }}" 2>/dev/null || stat -f%z "${{ steps.binary-unix.outputs.binary_path }}")
          echo "[OK] Binary verified: ${{ steps.binary-unix.outputs.binary_name }} ($size bytes)"
        else
          echo "[FAIL] Binary not found!"
          exit 1
        fi
      shell: bash

    - name: "[COMPRESS] Compress Binary (Unix systems)"
      if: matrix.os != 'windows-latest'
      run: |
        echo "[COMPRESS] Compressing binary to save storage..."
        gzip -9 "${{ steps.binary-unix.outputs.binary_path }}"
        echo "compressed_path=${{ steps.binary-unix.outputs.binary_path }}.gz" >> $GITHUB_OUTPUT
      id: compress

    - name: "[UPLOAD] Upload Build Artifacts"
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.os == 'windows-latest' && steps.binary-windows.outputs.binary_name || steps.binary-unix.outputs.binary_name }}
        path: ${{ matrix.os == 'windows-latest' && steps.binary-windows.outputs.binary_path || steps.compress.outputs.compressed_path }}
        retention-days: 14  # 私有仓库优化：减少存储成本
        compression-level: ${{ matrix.os == 'windows-latest' && '9' || '0' }}  # Windows压缩，Unix已压缩

    - name: "[UPLOAD] Upload dr-bench (Windows)"
      if: matrix.os == 'windows-latest' && steps.binary-windows.outputs.bench_name != ''
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.binary-windows.outputs.bench_name }}
        path: ${{ steps.binary-windows.outputs.bench_name }}
        retention-days: 14
        compression-level: 9

    - name: "[UPLOAD] Upload dr-bench (Unix)"
      if: matrix.os != 'windows-latest' && steps.binary-unix.outputs.bench_name != ''
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.binary-unix.outputs.bench_name }}
        path: ${{ steps.binary-unix.outputs.bench_name }}
        retention-days: 14
        compression-level: 9

    - name: "[CLEANUP] Cleanup workspace (Windows)"
      if: always() && matrix.os == 'windows-latest'
      run: |
        Write-Host "Cleaning target/ and cargo registries to free disk (Windows)..."
        Remove-Item -Path target -Recurse -Force -ErrorAction SilentlyContinue
        $cargoSrc = Join-Path $env:USERPROFILE ".cargo\registry\src"
        if (Test-Path $cargoSrc) { Remove-Item -Path $cargoSrc -Recurse -Force -ErrorAction SilentlyContinue }
        Get-PSDrive -PSProvider FileSystem | Format-Table -AutoSize
    - name: "[CLEANUP] Cleanup workspace (Unix)"
      if: always() && matrix.os != 'windows-latest'
      shell: bash
      run: |
        echo "Cleaning target/ and cargo registries to free disk..."
        rm -rf target || true
        rm -rf "$HOME/.cargo/registry/src" || true
        echo "Filesystem usage after cleanup:"
        df -h || true

  # [SUMMARY] 构建摘要和发布准备
  build-summary:
    name: Build Summary & Release Preparation
    needs: [changes, quality-check, build]
    runs-on: ubuntu-latest
    if: always() && (needs.changes.outputs.rust == 'true' || github.event_name == 'workflow_dispatch')  # 只在有代码变更或手动触发时运行

    steps:
    - name: "[DOWNLOAD] Download All Artifacts"
      uses: actions/download-artifact@v4

    - name: "[SUMMARY] Generate Build Summary"
      run: |
        {
          echo "# MacinMeter DR Tool - Build Summary"
          echo ""
          echo "## Build Information"
          echo "- **Build Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "- **Commit**: ${{ github.sha }}"
          echo "- **Branch**: ${{ github.ref_name }}"
          echo "- **Trigger**: ${{ github.event_name }}"
          echo ""
          echo "## Available Binaries"
          echo ""

          # 列出所有生成的二进制文件
          for dir in MacinMeter-DR-Tool-*; do
            if [ -d "$dir" ]; then
              binary_file=$(ls "$dir"/)
              size=$(stat -c%s "$dir/$binary_file" 2>/dev/null || echo "unknown")
              echo "- **$binary_file** - $size bytes"
            fi
          done

          echo ""
          echo "## Security & Quality"

          # 基于实际job结果动态显示状态
          if [ "${{ needs.quality-check.result }}" = "success" ]; then
            echo "- [OK] Code formatting check passed"
            echo "- [OK] Static analysis (Clippy) passed"
            echo "- [OK] Security audit completed"
            echo "- [OK] Unit tests passed"
          elif [ "${{ needs.quality-check.result }}" = "failure" ]; then
            echo "- [FAIL] Quality checks failed - see job details"
            echo "- [CHECK] Check 'Code Quality & Security Audit' job for details"
          elif [ "${{ needs.quality-check.result }}" = "cancelled" ]; then
            echo "- [STOP] Quality checks were cancelled"
          elif [ "${{ needs.quality-check.result }}" = "skipped" ]; then
            echo "- [SKIP] Quality checks were skipped (no code changes)"
          else
            echo "- [?] Quality checks status: ${{ needs.quality-check.result }}"
          fi

          echo ""
          echo "## Usage Instructions"
          echo ""
          echo "1. Download the appropriate binary for your platform"
          echo "2. Make it executable (Unix systems): \`chmod +x MacinMeter-DR-Tool-*\`"
          echo "3. Run without arguments for batch mode: \`./MacinMeter-DR-Tool-*\`"
          echo "4. Or specify a file: \`./MacinMeter-DR-Tool-* audio.flac\`"
          echo ""
          echo "---"
          echo "*Generated by MacinMeter DR Tool CI/CD Pipeline*"
        } >> $GITHUB_STEP_SUMMARY

    - name: "[DONE] Summary Generated"
      run: |
        echo "[OK] Build summary has been added to the GitHub Actions Summary"
        echo "[TIP] You can view the formatted summary in the Actions page above"

  # [GUI] Tauri GUI 打包（macOS DMG & Windows 安装包）
  gui-build:
    name: Build Tauri GUI (${{ matrix.os }})
    needs: [changes, quality-check]
    if: ${{ needs.changes.outputs.rust == 'true' || github.event_name == 'workflow_dispatch' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # 只为 Apple Silicon macOS 和 Windows x64 构建 GUI
          - os: macos-15
          - os: windows-latest
    runs-on: ${{ matrix.os }}

    steps:
    - name: "[CHECKOUT] Checkout Repository"
      uses: actions/checkout@v4

    - name: "[RUST] Install Rust Toolchain"
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: "[NODE] Setup Node.js"
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: tauri-app/package-lock.json

    - name: "[NPM] Install frontend dependencies"
      working-directory: tauri-app
      run: npm ci

    - name: "[BUILD] Build Tauri app"
      working-directory: tauri-app
      env:
        # macOS 上为 audiopus_sys 旧 CMakeLists 启用兼容策略
        CMAKE_POLICY_VERSION_MINIMUM: ${{ startsWith(matrix.os, 'macos') && '3.5' || '' }}
        CMAKE_ARGS: ${{ startsWith(matrix.os, 'macos') && '-DCMAKE_POLICY_VERSION_MINIMUM=3.5' || '' }}
        # 为 aarch64-apple-darwin 显式开启 ring 期望的 CPU 特性，避免编译期断言失败
        RUSTFLAGS: ${{ startsWith(matrix.os, 'macos') && '-C target-feature=+neon,+aes,+sha2' || '' }}
      run: npm run tauri build -- --ci

    - name: "[UPLOAD] Upload macOS DMG"
      if: matrix.os != 'windows-latest'
      uses: actions/upload-artifact@v4
      with:
        name: MacinMeter-DR-GUI-macos
        path: |
          tauri-app/src-tauri/target/release/bundle/dmg/*.dmg

    - name: "[UPLOAD] Upload Windows portable exe"
      if: matrix.os == 'windows-latest'
      uses: actions/upload-artifact@v4
      with:
        name: MacinMeter-DR-GUI-windows
        path: |
          tauri-app/src-tauri/target/release/*.exe
          tauri-app/src-tauri/target/release/bundle/**/*.exe

  # [RELEASE] 自动发布 (仅在tag推送时)
  release:
    name: Create Release
    needs: [changes, quality-check, build]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') && needs.changes.outputs.rust == 'true'  # 仅在版本tag且有代码变更时触发

    steps:
    - name: "[DOWNLOAD] Download All Artifacts"
      uses: actions/download-artifact@v4

    - name: "[RELEASE] Create Release"
      uses: softprops/action-gh-release@v1
      with:
        draft: false
        prerelease: contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc')
        generate_release_notes: true
        files: |
          MacinMeter-DR-Tool-*/MacinMeter-DR-Tool-*
        body: |
          ## MacinMeter DR Tool Release

          ### Features
          - [OK] 基于foobar2000 DR Meter的衍生实现
          - [OK] 基于IDA Pro逆向工程的算法研究与独立实现
          - [OK] SIMD加速和多线程支持
          - [OK] 批量处理模式（双击启动）
          - [OK] 支持多种音频格式 (WAV, FLAC, MP3, AAC, OGG)
          - [OK] 兼容foobar2000格式的详细分析报告

          ### Available Platforms
          - **Windows x64**: `MacinMeter-DR-Tool-*-windows-x64.exe`
          - **macOS Intel**: `MacinMeter-DR-Tool-*-macos-intel`
          - **macOS Apple Silicon**: `MacinMeter-DR-Tool-*-macos-arm64`
          - **Linux x64**: `MacinMeter-DR-Tool-*-linux-x64`

          ### Quick Start
          1. Download the binary for your platform
          2. Place in a folder with audio files
          3. Double-click to run (or use command line)
          4. Results saved to `DR_Analysis_Results_*.txt`

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
