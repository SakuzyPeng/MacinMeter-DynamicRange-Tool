name: CI/CD Pipeline - MacinMeter DR Tool (foobar2000å…¼å®¹ç‰ˆ)

on:
  push:
    branches: [ master, main, early-version, foobar2000-plugin, ui-wrapper ]
    tags: [ 'v*' ]
    # é¿å…çº¯æ–‡æ¡£/è¯´æ˜ç±»æ”¹åŠ¨è§¦å‘å®Œæ•´CIï¼ˆä»å¯æ‰‹åŠ¨workflow_dispatchï¼‰
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - 'README'
      - 'README.*'
      - 'CHANGELOG*'
      - 'LICENSE*'
      - 'SILENCE_FILTERING_PLAN.md'
  pull_request:
    branches: [ master, main, early-version, foobar2000-plugin, ui-wrapper ]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - 'README'
      - 'README.*'
      - 'CHANGELOG*'
      - 'LICENSE*'
      - 'SILENCE_FILTERING_PLAN.md'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      skip_tests:
        description: 'Skip tests for faster builds'
        type: boolean
        default: false
      build_targets:
        description: 'Specific targets to build (comma-separated)'
        type: string
        default: 'all'

# ğŸš€ ç§æœ‰ä»“åº“ä¼˜åŒ–ï¼šå¹¶å‘é™åˆ¶å’Œèµ„æºç®¡ç†
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # ç§æœ‰ä»“åº“ä¼˜åŒ–ï¼šå‡å°‘ç½‘ç»œé‡è¯•
  CARGO_NET_RETRY: 2
  CARGO_NET_TIMEOUT: 30

jobs:
  # ğŸš€ å¿«é€Ÿå˜æ›´æ£€æµ‹ - ç§æœ‰ä»“åº“ä¼˜åŒ–
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      rust: ${{ steps.changes.outputs.rust }}
      docs: ${{ steps.changes.outputs.docs }}
    steps:
    - name: ğŸ§¹ Disk usage (preflight)
      run: |
        echo "Filesystem usage before job:"
        df -h || true
        echo "Workspace usage (top 20):"
        du -xh -d1 . 2>/dev/null | sort -h | tail -n 20 || true
        echo "Home cache usage (if any):"
        du -xh -d1 "$HOME/.cache" 2>/dev/null | sort -h | tail -n 20 || true
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ” Check for Rust Code Changes
      uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          rust:
            - 'src/**/*.rs'
            - 'Cargo.toml'
            - 'Cargo.lock'
            - '.github/workflows/**'
            - 'tests/**/*.rs'
          docs:
            - 'README.md'
            - 'docs/**'
            - '*.md'
            - 'CLAUDE.md'
            - 'API_REFERENCE.md'
            
  # ğŸ” ä»£ç è´¨é‡æ£€æŸ¥å’Œå®‰å…¨å®¡è®¡
  quality-check:
    name: Code Quality & Security Audit
    needs: changes
    if: ${{ needs.changes.outputs.rust == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    env:
      # ğŸ¯ CIç¯å¢ƒä¸“ç”¨è®¾ç½® - è´¨é‡æ£€æŸ¥ä½¿ç”¨åŸç”Ÿç›®æ ‡ï¼Œé¿å…è·¨ç¼–è¯‘å¤æ‚æ€§
      RUSTFLAGS: '-C opt-level=3'  # ç®€åŒ–ç¼–è¯‘æ ‡å¿—é¿å…ç‰¹æ€§å†²çª
    
    steps:
    - name: ğŸ§¹ Disk usage (preflight - Windows)
      if: matrix.os == 'windows-latest'
      run: |
        Write-Host "Filesystem usage before build (Windows):"
        Get-PSDrive -PSProvider FileSystem | Format-Table -AutoSize
    - name: ğŸ§¹ Disk usage (preflight - Unix)
      if: matrix.os != 'windows-latest'
      shell: bash
      run: |
        echo "Filesystem usage before build:"
        df -h || true
        echo "Workspace usage (top 20):"
        du -xh -d1 . 2>/dev/null | sort -h | tail -n 20 || true
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ¦€ Install Rust Toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
        
    - name: ğŸ“¦ Smart Cache - Cargo Registry (crates.io)
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-
          
    # æ³¨æ„ï¼šè·³è¿‡gitä¾èµ–ç¼“å­˜ï¼Œå› ä¸ºé¡¹ç›®ä»…ä½¿ç”¨crates.ioä¾èµ–
          
    # è¯´æ˜ï¼šè´¨é‡æ£€æŸ¥é˜¶æ®µä¸å†ç¼“å­˜ target/ ä»¥å‡å°‘ç£ç›˜å ç”¨ï¼ˆé¿å…åœ¨è‡ªæ‰˜ç®¡Runnerä¸Šç§¯ç´¯ï¼‰
          
    - name: ğŸ“¦ Cache Cargo Tools (Stable Key)
      uses: actions/cache@v4
      id: cargo-tools-cache
      with:
        path: |
          ~/.cargo/bin/cargo-audit
          ~/.cargo/.crates.toml
          ~/.cargo/.crates2.json
        key: ${{ runner.os }}-cargo-audit-v4-stable
        restore-keys: |
          ${{ runner.os }}-cargo-audit-v4-
          ${{ runner.os }}-cargo-audit-
          
    - name: ğŸ”§ Install Security Audit Tool (Optimized Cache)
      run: |
        echo "ğŸ¯ æ£€æµ‹cargo-auditç¼“å­˜çŠ¶æ€..."
        echo "ç¼“å­˜å‘½ä¸­çŠ¶æ€: '${{ steps.cargo-tools-cache.outputs.cache-hit }}'"
        
        # æ£€æŸ¥cargo-auditæ˜¯å¦å­˜åœ¨ä¸”å¯ç”¨
        if command -v cargo-audit &> /dev/null && cargo-audit --version &> /dev/null; then
          echo "âœ… cargo-auditå·²å¯ç”¨ï¼ˆç¼“å­˜æ¢å¤æˆ–å·²å®‰è£…ï¼‰"
          cargo-audit --version
        else
          echo "ğŸ“¦ å®‰è£…cargo-auditï¼ˆç¼“å­˜æœªå‘½ä¸­æˆ–æŸåï¼‰..."
          cargo install --locked cargo-audit
          echo "âœ… æ–°å®‰è£…å®Œæˆï¼š"
          cargo-audit --version
        fi
      
    - name: ğŸ“‹ Check Code Formatting
      run: |
        echo "ğŸ¨ Checking code formatting..."
        cargo fmt --all -- --check
        
    - name: ğŸ” Run Clippy Static Analysis
      run: |
        echo "ğŸ“ Running Clippy static analysis..."
        cargo clippy --all-targets --all-features -- -D warnings -D unused-unsafe -D unsafe-op-in-unsafe-fn
        
    - name: âœ… Compile Check
      run: |
        echo "ğŸ”¨ Running compile check..."
        cargo check --all-targets --all-features
        
    - name: ğŸ›¡ï¸ Security Audit
      run: |
        echo "ğŸ”’ Running security audit (stale DB to reduce writes)..."
        cargo audit --stale \
          --ignore RUSTSEC-2025-0009 --ignore RUSTSEC-2024-0336 \
          --ignore RUSTSEC-2023-0065 --ignore RUSTSEC-2025-0055 \
          --ignore RUSTSEC-2024-0388 --ignore RUSTSEC-2025-0010
        
    - name: ğŸ§ª Run Unit Tests
      if: ${{ !github.event.inputs.skip_tests }}
      run: |
        echo "ğŸ§ª Running unit tests..."
        cargo test --all-features -- --nocapture
    
    - name: ğŸ§¹ Cleanup workspace (free disk)
      if: always()
      run: |
        echo "Cleaning target/ and temporary registries to free disk..."
        rm -rf target || true
        rm -rf "$HOME/.cargo/registry/src" || true
        echo "Filesystem usage after cleanup:"
        df -h || true
        
    - name: ğŸ“Š Generate Test Coverage (Optional)
      run: |
        echo "ğŸ“Š Test coverage analysis completed"
        # å¯ä»¥æ·»åŠ  tarpaulin æˆ–å…¶ä»–è¦†ç›–ç‡å·¥å…·
        
  # ğŸ—ï¸ å¤šå¹³å°æ„å»º
  build:
    name: Build (${{ matrix.platform }}-${{ matrix.arch }})
    needs: [changes, quality-check]  # ä¾èµ–å˜æ›´æ£€æµ‹å’Œè´¨é‡æ£€æŸ¥
    # ğŸš€ ç§æœ‰ä»“åº“ä¼˜åŒ–ï¼šæ¡ä»¶æ„å»º
    if: ${{ needs.changes.outputs.rust == 'true' || github.event_name == 'workflow_dispatch' }}
    strategy:
      fail-fast: false
      max-parallel: 2  # ç§æœ‰ä»“åº“ä¼˜åŒ–ï¼šé™åˆ¶å¹¶å‘ä»¥é¿å…èµ„æºäº‰ç”¨
      matrix:
        include:
          # Windows x64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            platform: windows
            arch: x64
            extension: .exe
            
          # macOS Intel (Native)
          - os: macos-latest
            target: x86_64-apple-darwin
            platform: macos
            arch: intel
            extension: ""
            
          # macOS Apple Silicon (Native) 
          - os: macos-15
            target: aarch64-apple-darwin
            platform: macos
            arch: arm64
            extension: ""
            
          # Linux x64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux
            arch: x64
            extension: ""
            
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ¦€ Install Rust Toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}
        
    # ğŸ¯ æ˜¾å¼å®‰è£…äº¤å‰ç¼–è¯‘ç›®æ ‡ (ç¡®ä¿å¯é æ€§)
    - name: ğŸ¯ Install Cross-compilation Target
      run: |
        echo "ğŸ¯ Installing target: ${{ matrix.target }}"
        rustup target add ${{ matrix.target }}
        rustup target list --installed | grep ${{ matrix.target }} || (echo "âŒ Target installation failed" && exit 1)
        echo "âœ… Target ${{ matrix.target }} successfully installed"
        
    # ğŸš€ å¤šå±‚ç¼“å­˜ç­–ç•¥ä¼˜åŒ– - ç§æœ‰ä»“åº“å‹å¥½
    - name: ğŸ“¦ Platform Cache - Cargo Registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
        key: cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          cargo-registry-
          
    - name: ğŸ“¦ Platform Cache - Git Dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git/db/
        key: cargo-git-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          cargo-git-
          
    # æ³¨æ„ï¼šå°½é‡é¿å…ç¼“å­˜ target/ï¼ˆå ç”¨å¤§ä¸”å®¹æ˜“å¡«æ»¡è‡ªæ‰˜ç®¡ç£ç›˜ï¼‰ï¼›
    # å¦‚éœ€ç¼“å­˜ç¼–è¯‘äº§ç‰©ï¼Œè¯·æ”¹ç”¨ Swatinem/rust-cache å¹¶é™å®š save-if ä»…åœ¨ä¸»åˆ†æ”¯ä¿å­˜ã€‚
          
    # ğŸ• ç”Ÿæˆç²¾ç¡®åˆ°ç§’çš„æ—¶é—´æˆ³ï¼ˆUTCæ—¶åŒºï¼‰ - Windows
    - name: ğŸ• Generate Timestamp (Windows)
      if: matrix.os == 'windows-latest'
      id: timestamp-windows
      run: |
        $timestamp = Get-Date -Format "yyyy-MM-dd-HH-mm-ss-UTC" -AsUTC
        echo "timestamp=$timestamp" >> $env:GITHUB_OUTPUT
        echo "date_tag=$timestamp" >> $env:GITHUB_OUTPUT
      shell: pwsh
      
    # ğŸ• ç”Ÿæˆç²¾ç¡®åˆ°ç§’çš„æ—¶é—´æˆ³ï¼ˆUTCæ—¶åŒºï¼‰ - Unix
    - name: ğŸ• Generate Timestamp (Unix)
      if: matrix.os != 'windows-latest'
      id: timestamp-unix
      run: |
        timestamp=$(date -u +"%Y-%m-%d-%H-%M-%S-UTC")
        echo "timestamp=$timestamp" >> $GITHUB_OUTPUT
        echo "date_tag=$timestamp" >> $GITHUB_OUTPUT
      shell: bash
      
    # ğŸ• ç»Ÿä¸€æ—¶é—´æˆ³è¾“å‡º - Windows
    - name: ğŸ• Set Unified Timestamp (Windows)
      if: matrix.os == 'windows-latest'
      id: timestamp-win
      run: |
        echo "timestamp=${{ steps.timestamp-windows.outputs.timestamp }}" >> $env:GITHUB_OUTPUT
        echo "date_tag=${{ steps.timestamp-windows.outputs.date_tag }}" >> $env:GITHUB_OUTPUT
      shell: pwsh
      
    # ğŸ• ç»Ÿä¸€æ—¶é—´æˆ³è¾“å‡º - Unix
    - name: ğŸ• Set Unified Timestamp (Unix)
      if: matrix.os != 'windows-latest'
      id: timestamp-nix
      run: |
        echo "timestamp=${{ steps.timestamp-unix.outputs.timestamp }}" >> $GITHUB_OUTPUT
        echo "date_tag=${{ steps.timestamp-unix.outputs.date_tag }}" >> $GITHUB_OUTPUT
      shell: bash
      
    # ğŸ• ç»Ÿä¸€æ—¶é—´æˆ³IDè¾“å‡º
    - name: ğŸ• Set Final Timestamp ID
      id: timestamp
      run: |
        # è¿™ä¸€æ­¥åªæ˜¯ä¸ºäº†ä¿æŒåç»­æ­¥éª¤çš„å…¼å®¹æ€§
        echo "Final timestamp ID set for downstream steps"
      shell: bash

    - name: ğŸ—ï¸ Build Release Binary
      env:
        # ğŸ¯ CIä¸“ç”¨ç¯å¢ƒå˜é‡ - RUSTFLAGSåœ¨è„šæœ¬ä¸­åŠ¨æ€è®¾ç½®
        CI_TARGET: ${{ matrix.target }}
        # ğŸ› ï¸ ä¿®å¤audiopus_sys CMakeç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜ï¼ˆä»…macOSéœ€è¦ï¼‰
        CMAKE_POLICY_VERSION_MINIMUM: ${{ contains(matrix.os, 'macos') && '3.5' || '' }}
      run: |
        echo "ğŸš€ Building release binary for ${{ matrix.platform }}-${{ matrix.arch }}..."
        echo "ğŸ“‹ Build environment info:"
        echo "  Target: ${{ matrix.target }}"
        echo "  OS: ${{ matrix.os }}"
        echo "  Platform: ${{ matrix.platform }}"
        echo "  Arch: ${{ matrix.arch }}"

        # ğŸ¯ åŠ¨æ€è®¾ç½®RUSTFLAGSé¿å…æ¶æ„å†²çª
        case "$CI_TARGET" in
          "aarch64-apple-darwin")
            export RUSTFLAGS="-C target-feature=+neon -C opt-level=3"
            echo "ğŸ ARM64 macOS: Using NEON optimizations"
            ;;
          "x86_64-apple-darwin"|"x86_64-pc-windows-msvc"|"x86_64-unknown-linux-gnu")
            export RUSTFLAGS="-C target-feature=+sse2,+sse3,+sse4.1,+sse4.2,+avx,+avx2 -C opt-level=3"
            echo "ğŸ’» x86_64: Using SSE/AVX optimizations"
            ;;
          *)
            export RUSTFLAGS="-C opt-level=3"
            echo "ğŸ”§ Generic: Using standard optimizations"
            ;;
        esac
        echo "  RUSTFLAGS: $RUSTFLAGS"
        
        echo "ğŸ” Verifying Rust setup:"
        rustc --version
        cargo --version
        rustup show

        echo "ğŸ¯ Using GitHub Actions native runner strategy:"
        echo "  Runner OS: ${{ matrix.os }}"
        echo "  Target: ${{ matrix.target }}"

        # ğŸ¯ ç»Ÿä¸€ä½¿ç”¨åŸç”Ÿæ„å»ºç­–ç•¥é¿å…è·¨ç¼–è¯‘å¤æ‚æ€§
        echo "ğŸ—ï¸ Building for target: ${{ matrix.target }}"
        echo "ğŸ’¡ Using GitHub Actions native runner for ${{ matrix.target }}"

        # ğŸ› ï¸ macOSç‰¹å®šçš„CMakeå…¼å®¹æ€§å¤„ç†
        if [[ "${{ matrix.os }}" == macos* ]]; then
          echo "ğŸ macOS detected: Setting CMake compatibility flags for audiopus_sys"
          export CMAKE_POLICY_VERSION_MINIMUM=3.5
          export CMAKE_ARGS="-DCMAKE_POLICY_VERSION_MINIMUM=3.5"
        fi

        # ç›´æ¥æ„å»ºï¼Œä¾èµ–GitHub Actionsçš„runneråŸç”Ÿæ”¯æŒ
        cargo build --release --verbose
      shell: bash
    # ğŸ“¦ å‡†å¤‡äºŒè¿›åˆ¶æ–‡ä»¶ - Windows
    - name: ğŸ“¦ Prepare Binary with Timestamp (Windows)
      if: matrix.os == 'windows-latest'
      id: binary-windows
      run: |
        $binary_name = "MacinMeter-DR-Tool-${{ steps.timestamp-windows.outputs.timestamp }}-${{ matrix.platform }}-${{ matrix.arch }}${{ matrix.extension }}"
        
        # æ™ºèƒ½è·¯å¾„æ£€æµ‹ - Native vs Cross-compilation
        $native_path = "target/release/MacinMeter-DynamicRange-Tool-foo_dr${{ matrix.extension }}"
        $cross_path = "target/${{ matrix.target }}/release/MacinMeter-DynamicRange-Tool-foo_dr${{ matrix.extension }}"
        
        if (Test-Path $native_path) {
          Write-Host "âœ… Using native build path: $native_path"
          $source_path = $native_path
        } elseif (Test-Path $cross_path) {
          Write-Host "âœ… Using cross-compilation path: $cross_path" 
          $source_path = $cross_path
        } else {
          Write-Host "âŒ Binary not found in either path!"
          Write-Host "  Native path: $native_path"
          Write-Host "  Cross path: $cross_path"
          exit 1
        }
        
        Copy-Item $source_path $binary_name
        echo "binary_name=$binary_name" >> $env:GITHUB_OUTPUT
        echo "binary_path=$binary_name" >> $env:GITHUB_OUTPUT
      shell: pwsh
      
    # ğŸ“¦ å‡†å¤‡äºŒè¿›åˆ¶æ–‡ä»¶ - Unix
    - name: ğŸ“¦ Prepare Binary with Timestamp (Unix)
      if: matrix.os != 'windows-latest'
      id: binary-unix
      run: |
        binary_name="MacinMeter-DR-Tool-${{ steps.timestamp-unix.outputs.timestamp }}-${{ matrix.platform }}-${{ matrix.arch }}${{ matrix.extension }}"
        
        # æ™ºèƒ½è·¯å¾„æ£€æµ‹ - Native vs Cross-compilation
        native_path="target/release/MacinMeter-DynamicRange-Tool-foo_dr${{ matrix.extension }}"
        cross_path="target/${{ matrix.target }}/release/MacinMeter-DynamicRange-Tool-foo_dr${{ matrix.extension }}"
        
        if [ -f "$native_path" ]; then
          echo "âœ… Using native build path: $native_path"
          source_path="$native_path"
        elif [ -f "$cross_path" ]; then
          echo "âœ… Using cross-compilation path: $cross_path"
          source_path="$cross_path"
        else
          echo "âŒ Binary not found in either path!"
          echo "  Native path: $native_path"
          echo "  Cross path: $cross_path"
          exit 1
        fi
        
        cp "$source_path" "$binary_name"
        chmod +x "$binary_name"  # ç¡®ä¿å¯æ‰§è¡Œæƒé™
        echo "binary_name=$binary_name" >> $GITHUB_OUTPUT
        echo "binary_path=$binary_name" >> $GITHUB_OUTPUT
      shell: bash
      
    # ğŸ“¦ ç»Ÿä¸€äºŒè¿›åˆ¶è¾“å‡º - Windows
    - name: ğŸ“¦ Set Unified Binary Info (Windows)
      if: matrix.os == 'windows-latest'
      id: binary-win
      run: |
        echo "binary_name=${{ steps.binary-windows.outputs.binary_name }}" >> $env:GITHUB_OUTPUT
        echo "binary_path=${{ steps.binary-windows.outputs.binary_path }}" >> $env:GITHUB_OUTPUT
      shell: pwsh
      
    # ğŸ“¦ ç»Ÿä¸€äºŒè¿›åˆ¶è¾“å‡º - Unix
    - name: ğŸ“¦ Set Unified Binary Info (Unix)
      if: matrix.os != 'windows-latest'
      id: binary-nix
      run: |
        echo "binary_name=${{ steps.binary-unix.outputs.binary_name }}" >> $GITHUB_OUTPUT
        echo "binary_path=${{ steps.binary-unix.outputs.binary_path }}" >> $GITHUB_OUTPUT
      shell: bash
      
    # ğŸ“¦ ç»Ÿä¸€äºŒè¿›åˆ¶IDè¾“å‡º
    - name: ğŸ“¦ Set Final Binary ID
      id: binary
      run: |
        # è¿™ä¸€æ­¥åªæ˜¯ä¸ºäº†ä¿æŒåç»­æ­¥éª¤çš„å…¼å®¹æ€§
        echo "Final binary ID set for downstream steps"
      shell: bash
      
    # âœ… éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶ - Windows
    - name: âœ… Verify Binary (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        echo "ğŸ” Verifying built binary..."
        if (Test-Path "${{ steps.binary-windows.outputs.binary_path }}") {
          $size = (Get-Item "${{ steps.binary-windows.outputs.binary_path }}").Length
          Write-Host "âœ… Binary verified: ${{ steps.binary-windows.outputs.binary_name }} ($size bytes)"
        } else {
          Write-Host "âŒ Binary not found!"
          exit 1
        }
      shell: pwsh
      
    # âœ… éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶ - Unix
    - name: âœ… Verify Binary (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        echo "ğŸ” Verifying built binary..."
        if [ -f "${{ steps.binary-unix.outputs.binary_path }}" ]; then
          size=$(stat -c%s "${{ steps.binary-unix.outputs.binary_path }}" 2>/dev/null || stat -f%z "${{ steps.binary-unix.outputs.binary_path }}")
          echo "âœ… Binary verified: ${{ steps.binary-unix.outputs.binary_name }} ($size bytes)"
        else
          echo "âŒ Binary not found!"
          exit 1
        fi
      shell: bash
      
    - name: ğŸ“¦ Compress Binary (Unix systems)
      if: matrix.os != 'windows-latest'
      run: |
        echo "ğŸ—œï¸ Compressing binary to save storage..."
        gzip -9 "${{ steps.binary-unix.outputs.binary_path }}"
        echo "compressed_path=${{ steps.binary-unix.outputs.binary_path }}.gz" >> $GITHUB_OUTPUT
      id: compress
      
    - name: ğŸ“¤ Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.os == 'windows-latest' && steps.binary-windows.outputs.binary_name || steps.binary-unix.outputs.binary_name }}
        path: ${{ matrix.os == 'windows-latest' && steps.binary-windows.outputs.binary_path || steps.compress.outputs.compressed_path }}
        retention-days: 14  # ç§æœ‰ä»“åº“ä¼˜åŒ–ï¼šå‡å°‘å­˜å‚¨æˆæœ¬
        compression-level: ${{ matrix.os == 'windows-latest' && '9' || '0' }}  # Windowså‹ç¼©ï¼ŒUnixå·²å‹ç¼©
    
    - name: ğŸ§¹ Cleanup workspace (Windows)
      if: always() && matrix.os == 'windows-latest'
      run: |
        Write-Host "Cleaning target/ and cargo registries to free disk (Windows)..."
        Remove-Item -Path target -Recurse -Force -ErrorAction SilentlyContinue
        $cargoSrc = Join-Path $env:USERPROFILE ".cargo\registry\src"
        if (Test-Path $cargoSrc) { Remove-Item -Path $cargoSrc -Recurse -Force -ErrorAction SilentlyContinue }
        Get-PSDrive -PSProvider FileSystem | Format-Table -AutoSize
    - name: ğŸ§¹ Cleanup workspace (Unix)
      if: always() && matrix.os != 'windows-latest'
      shell: bash
      run: |
        echo "Cleaning target/ and cargo registries to free disk..."
        rm -rf target || true
        rm -rf "$HOME/.cargo/registry/src" || true
        echo "Filesystem usage after cleanup:"
        df -h || true
        
  # ğŸ“‹ æ„å»ºæ‘˜è¦å’Œå‘å¸ƒå‡†å¤‡
  build-summary:
    name: Build Summary & Release Preparation
    needs: [changes, quality-check, build]
    runs-on: ubuntu-latest
    if: always() && (needs.changes.outputs.rust == 'true' || github.event_name == 'workflow_dispatch')  # åªåœ¨æœ‰ä»£ç å˜æ›´æˆ–æ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œ
    
    steps:
    - name: ğŸ“¥ Download All Artifacts
      uses: actions/download-artifact@v4
      
    - name: ğŸ“‹ Generate Build Summary
      run: |
        {
          echo "# ğŸš€ MacinMeter DR Tool (foobar2000å…¼å®¹ç‰ˆ) - Build Summary"
          echo ""
          echo "## ğŸ“… Build Information"
          echo "- **Build Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "- **Commit**: ${{ github.sha }}"
          echo "- **Branch**: ${{ github.ref_name }}"
          echo "- **Trigger**: ${{ github.event_name }}"
          echo ""
          echo "## ğŸ“¦ Available Binaries"
          echo ""
          
          # åˆ—å‡ºæ‰€æœ‰ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶
          for dir in MacinMeter-DR-Tool-*; do
            if [ -d "$dir" ]; then
              binary_file=$(ls "$dir"/)
              size=$(stat -c%s "$dir/$binary_file" 2>/dev/null || echo "unknown")
              echo "- **$binary_file** - $size bytes"
            fi
          done
          
          echo ""
          echo "## ğŸ›¡ï¸ Security & Quality"

          # åŸºäºå®é™…jobç»“æœåŠ¨æ€æ˜¾ç¤ºçŠ¶æ€
          if [ "${{ needs.quality-check.result }}" = "success" ]; then
            echo "- âœ… Code formatting check passed"
            echo "- âœ… Static analysis (Clippy) passed"
            echo "- âœ… Security audit completed"
            echo "- âœ… Unit tests passed"
          elif [ "${{ needs.quality-check.result }}" = "failure" ]; then
            echo "- âŒ Quality checks failed - see job details"
            echo "- ğŸ” Check 'Code Quality & Security Audit' job for details"
          elif [ "${{ needs.quality-check.result }}" = "cancelled" ]; then
            echo "- â¹ï¸ Quality checks were cancelled"
          elif [ "${{ needs.quality-check.result }}" = "skipped" ]; then
            echo "- â­ï¸ Quality checks were skipped (no code changes)"
          else
            echo "- â“ Quality checks status: ${{ needs.quality-check.result }}"
          fi

          echo ""
          echo "## ğŸ”§ Usage Instructions"
          echo ""
          echo "1. Download the appropriate binary for your platform"
          echo "2. Make it executable (Unix systems): \`chmod +x MacinMeter-DR-Tool-*\`"
          echo "3. Run without arguments for batch mode: \`./MacinMeter-DR-Tool-*\`"
          echo "4. Or specify a file: \`./MacinMeter-DR-Tool-* audio.flac\`"
          echo ""
          echo "---"
          echo "*Generated by MacinMeter DR Tool CI/CD Pipeline*"
        } >> $GITHUB_STEP_SUMMARY
        
    - name: ğŸ“Š Summary Generated
      run: |
        echo "âœ… Build summary has been added to the GitHub Actions Summary"
        echo "ğŸ’¡ You can view the formatted summary in the Actions page above"

  # ğŸ–¼ï¸ Tauri GUI æ‰“åŒ…ï¼ˆmacOS DMG & Windows å®‰è£…åŒ…ï¼‰
  gui-build:
    name: Build Tauri GUI (${{ matrix.os }})
    needs: [changes, quality-check]
    if: ${{ needs.changes.outputs.rust == 'true' || github.event_name == 'workflow_dispatch' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # åªä¸º Apple Silicon macOS å’Œ Windows x64 æ„å»º GUI
          - os: macos-15
          - os: windows-latest
    runs-on: ${{ matrix.os }}

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ¦€ Install Rust Toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: tauri-app/package-lock.json

    - name: ğŸ“¦ Install frontend dependencies
      working-directory: tauri-app
      run: npm ci

    - name: ğŸ—ï¸ Build Tauri app
      working-directory: tauri-app
      env:
        # macOS ä¸Šä¸º audiopus_sys æ—§ CMakeLists å¯ç”¨å…¼å®¹ç­–ç•¥
        CMAKE_POLICY_VERSION_MINIMUM: ${{ startsWith(matrix.os, 'macos') && '3.5' || '' }}
        CMAKE_ARGS: ${{ startsWith(matrix.os, 'macos') && '-DCMAKE_POLICY_VERSION_MINIMUM=3.5' || '' }}
      run: npm run tauri build -- --ci

    - name: ğŸ“¦ Upload macOS DMG
      if: matrix.os != 'windows-latest'
      uses: actions/upload-artifact@v4
      with:
        name: MacinMeter-DR-GUI-macos
        path: |
          tauri-app/src-tauri/target/release/bundle/dmg/*.dmg

    - name: ğŸ“¦ Upload Windows portable exe
      if: matrix.os == 'windows-latest'
      uses: actions/upload-artifact@v4
      with:
        name: MacinMeter-DR-GUI-windows
        path: |
          tauri-app/src-tauri/target/release/*.exe
          tauri-app/src-tauri/target/release/bundle/**/*.exe
      
  # ğŸš€ è‡ªåŠ¨å‘å¸ƒ (ä»…åœ¨tagæ¨é€æ—¶)
  release:
    name: Create Release
    needs: [changes, quality-check, build]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') && needs.changes.outputs.rust == 'true'  # ä»…åœ¨ç‰ˆæœ¬tagä¸”æœ‰ä»£ç å˜æ›´æ—¶è§¦å‘
    
    steps:
    - name: ğŸ“¥ Download All Artifacts
      uses: actions/download-artifact@v4
      
    - name: ğŸ·ï¸ Create Release
      uses: softprops/action-gh-release@v1
      with:
        draft: false
        prerelease: contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc')
        generate_release_notes: true
        files: |
          MacinMeter-DR-Tool-*/MacinMeter-DR-Tool-*
        body: |
          ## ğŸš€ MacinMeter DR Tool Release (foobar2000å…¼å®¹ç‰ˆ)
          
          ### ğŸ¯ Features
          - âœ… åŸºäºfoobar2000 DR Meterçš„è¡ç”Ÿå®ç°
          - ğŸ”¬ åŸºäºIDA Proé€†å‘å·¥ç¨‹çš„ç®—æ³•ç ”ç©¶ä¸ç‹¬ç«‹å®ç°
          - ğŸš€ SIMDåŠ é€Ÿå’Œå¤šçº¿ç¨‹æ”¯æŒ
          - ğŸ“ æ‰¹é‡å¤„ç†æ¨¡å¼ï¼ˆåŒå‡»å¯åŠ¨ï¼‰
          - ğŸµ æ”¯æŒå¤šç§éŸ³é¢‘æ ¼å¼ (WAV, FLAC, MP3, AAC, OGG)
          - ğŸ“Š å…¼å®¹foobar2000æ ¼å¼çš„è¯¦ç»†åˆ†ææŠ¥å‘Š
          
          ### ğŸ“¦ Available Platforms
          - **Windows x64**: `MacinMeter-DR-Tool-*-windows-x64.exe`
          - **macOS Intel**: `MacinMeter-DR-Tool-*-macos-intel`  
          - **macOS Apple Silicon**: `MacinMeter-DR-Tool-*-macos-arm64`
          - **Linux x64**: `MacinMeter-DR-Tool-*-linux-x64`
          
          ### ğŸ”§ Quick Start
          1. Download the binary for your platform
          2. Place in a folder with audio files
          3. Double-click to run (or use command line)
          4. Results saved to `DR_Analysis_Results_*.txt`
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
