[English](BENCHMARKS.md) | [中文](BENCHMARKS_CN.md)

# 性能基准

本文档包含 MacinMeter DR Tool 的详细性能测试数据。

---

## 测量方法

- macOS 脚本：`scripts/benchmark.sh`（单次）、`scripts/benchmark_10x.sh`（10 次统计）。
- Windows 脚本：`scripts/benchmark.ps1`、`scripts/benchmark-10x.ps1`（与 macOS 采样逻辑一致）。
- 指标采集：每 0.1 s 通过 `ps` (或 PowerShell `Get-Process`) 记录 RSS 与累计 CPU 时间；使用 `date +%s.%N` 或 Windows 计时器测量总时长；处理速度＝音频总大小（MB）÷运行时长（s）。

---

## 测试环境

- macOS 26 · Apple M4 Pro · 12 核 (8P + 4E)
- Windows 10 · Intel i7-11800H

---

## 数据集

| 类别 | 规模 | 编码/声道 | 采样率分布 | 位深分布 | 备注 |
| --- | --- | --- | --- | --- | --- |
| 单大型文件 | 约 1.6 GB · 1 首 · 约 94 分钟 | FLAC / 2ch | 96 kHz | 24-bit | mediainfo 提取 |
| 69 首 FLAC 集 | 约 1.17 GB · 69 首 | FLAC / 2ch | 48 kHz × 69 | 24-bit × 69 | 常见 CD 合集 |
| 106 首 FLAC | 约 11.7 GB · 106 首 | FLAC / 2ch | 96×50，48×46，192×8，88.2×2 | 24-bit × 106 | 用于文件级并行基准 |

---

## macOS M4 Pro 基准

### 单文件基准（10 次，解码并行 vs 串行）

| 模式 | 平均时间 (s) | 中位数 (s) | 标准差 (s) | 平均吞吐 (MB/s) | 中位数 (MB/s) | 标准差 (MB/s) |
| --- | ---:| ---:| ---:| ---:| ---:| ---:|
| 并行解码 | 2.780 | 2.766 | 0.069 | 721.55 | 724.89 | 17.99 |
| 串行解码 `--serial` | 10.809 | 10.588 | 0.584 | 185.90 | 189.41 | 9.84 |

| 模式 | 峰值内存平均 (MB) | 峰值内存中位 (MB) | 峰值内存标准差 (MB) | CPU 峰值平均 (%) | CPU 平均 (%) |
| --- | ---:| ---:| ---:| ---:| ---:|
| 并行解码 | 47.87 | 44.51 | 7.46 | 33.04 | 32.47 |
| 串行解码 `--serial` | 25.37 | 25.84 | 0.91 | 8.38 | 8.32 |

### 批量基准（10 次，文件级并行 vs 禁用）

| 数据集 | 模式 | 平均时间 (s) | 中位数 (s) | 标准差 (s) | 平均吞吐 (MB/s) | 中位数 (MB/s) | 标准差 (MB/s) |
| --- | --- | ---:| ---:| ---:| ---:| ---:| ---:|
| 69 首 FLAC | 默认并行 | 1.178 | 1.025 | 0.457 | 1113.84 | 1167.73 | 159.40 |
| 106 首 FLAC | 默认并行 | 9.462 | 9.018 | 0.796 | 1241.84 | 1294.15 | 101.56 |
| 106 首 FLAC | 禁用文件并行 `--no-parallel-files` | 26.997 | 26.035 | 2.591 | 435.34 | 447.81 | 33.43 |

| 数据集 | 模式 | 峰值内存平均 (MB) | 峰值内存中位 (MB) | 峰值内存标准差 (MB) | CPU 峰值平均 (%) | CPU 平均 (%) |
| --- | --- | ---:| ---:| ---:| ---:| ---:|
| 69 首 FLAC | 默认并行 | 97.65 | 94.22 | 11.72 | 64.62 | 61.99 |
| 106 首 FLAC | 默认并行 | 1743.26 | 1679.38 | 183.64 | 80.54 | 78.69 |
| 106 首 FLAC | 禁用文件并行 `--no-parallel-files` | 87.41 | 87.71 | 2.73 | 21.69 | 20.02 |

---

## Windows 基准

### Windows 10 · Intel i7-11800H (10 次)

- 测试脚本与 macOS 相同采样逻辑，数值统一换算为秒与 MB。
- Windows 数据与 macOS 相同，均基于去重后的 106 首集合（仅数值与此前 107 首版本相同）。

| 数据集 | 模式 | 平均时间 (s) | 中位数 (s) | 标准差 (s) | 平均吞吐 (MB/s) | 中位数 (MB/s) | 标准差 (MB/s) |
| --- | --- | ---:| ---:| ---:| ---:| ---:| ---:|
| 单大型文件 | 默认并行 | 6.090 | 6.085 | 0.014 | 248.05 | 248.26 | 0.56 |
| 69 首 FLAC | 默认并行 | 3.057 | 3.051 | 0.027 | 381.49 | 382.23 | 3.30 |
| 106 首 FLAC | 默认并行 | 16.411 | 16.213 | 0.416 | 715.07 | 723.44 | 17.49 |

| 数据集 | 峰值内存平均 (MB) | 峰值内存中位 (MB) | 峰值内存标准差 (MB) | 平均内存平均 (MB) | 平均内存中位 (MB) | 平均内存标准差 (MB) |
| --- | ---:| ---:| ---:| ---:| ---:| ---:|
| 单大型文件 | 217.89 | 217.87 | 12.90 | 135.39 | 136.78 | 8.01 |
| 69 首 FLAC | 40.17 | 40.21 | 1.05 | 26.84 | 26.75 | 0.55 |
| 106 首 FLAC | 178.67 | 175.07 | 23.57 | 98.82 | 99.24 | 10.97 |

### Windows 11 · Intel i9-13900H (10 次)

69 首 FLAC 集在默认 4 并发下，通过线程优先级优化后性能表现稳定：

| 指标 | 中位数 | 平均值 | 标准差 |
| --- | ---:| ---:| ---:|
| 运行时间 | 2.052 s | 2.056 s | 0.016 s |
| 处理速度 | 568.18 MB/s | 567.23 MB/s | 4.28 MB/s |
| 峰值内存 | 41.43 MB | 40.09 MB | 4.49 MB |
| 平均内存 | 21.98 MB | 21.31 MB | 2.25 MB |
| CPU 平均占用 | 36.57% | 36.30% | 1.32% |
| CPU 峰值占用 | 43.19% | 43.54% | 2.09% |

相比 macOS M4 Pro（中位 1.025 秒、1167.73 MB/s），i9-13900H 在相同 69 首 FLAC 数据集（1.17GB）上的表现为中位 2.05 秒、568 MB/s，整体性能约为 M4 Pro 的 49%。混合 P/E 核调度已通过线程优先级优化得到改善。

---

## 串行模式对比

| 平台 | 模式 | 106 首 FLAC 时间 (s) | 吞吐 (MB/s) | 峰值内存 (MB) | 平均内存 (MB) | 平均 CPU (%) |
| --- | --- | ---:| ---:| ---:| ---:| ---:|
| Windows 10 · i7-11800H | `--serial --no-parallel-files` | 127.452 | 89.4 | 23.38 | 17.76 | 20.0 |
| Windows 10 · i7-11800H | Dynamic Range Meter 1.1.1 | 162.0 | 70.4 | <15 | <15 | 15.0 |

> Windows 完全串行为极端调度或内存受限环境提供兜底，Dynamic Range Meter 1.1.1 记录列供第三方基准参考。

---

## DSD/FFmpeg 管道优化

### 测试数据集

| 类别 | 规模 | 编码/声道 | 采样率 | 备注 |
| --- | --- | --- | --- | --- |
| 10 首 DSD | 约 3.85 GB · 10 首 | DSF / 2ch | DSD128 (5.6 MHz) | 通过 FFmpeg 降采样至 352.8 kHz |

### 优化内容

异步双缓冲架构：

```
FFmpeg → [管道] → 读取线程(1MB BufReader) → [Channel 4×512KB] → 主线程
```

- BufReader 从 128KB 增大到 1MB
- 新增异步读取线程持续预读数据
- 通过 crossbeam-channel 传递数据块（容量 4 块 × 512KB）
- 减少 FFmpeg 写端阻塞，改善 Windows 4KB 管道缓冲限制

### macOS M4 Pro · DSD 基准（10 次）

| 版本 | 平均时间 (s) | 中位数 (s) | 最小 (s) | 最大 (s) | 提升 |
| --- | ---:| ---:| ---:| ---:| ---:|
| 优化前 (无 BufReader) | 17.914 | 17.927 | 17.274 | 18.919 | — |
| **优化后 (异步 1MB)** | **11.603** | **11.545** | **11.302** | **12.020** | **+35%** |

### Windows 10 · Intel i7-11800H · DSD 基准（10 次）

| 版本 | 平均时间 (s) | 中位数 (s) | 处理速度 (MB/s) | 提升 |
| --- | ---:| ---:| ---:| ---:|
| 优化前 (2025-11-04) | 245.815 | 244.557 | 15.68 | — |
| **优化后 (2026-01-29)** | **16.824** | **16.793** | **229.07** | **14.6 倍** |

| 版本 | 峰值内存 (MB) | 平均内存 (MB) | CPU 平均 (%) | CPU 峰值 (%) |
| --- | ---:| ---:| ---:| ---:|
| 优化前 (2025-11-04) | 201.41 | 153.46 | 22.48 | 26.93 |
| **优化后 (2026-01-29)** | **316.45** | **197.69** | **10.70** | **14.22** |

### 跨平台对比

优化后 macOS vs Windows 性能差距从 **13.7×** 缩小到 **1.45×**：

| 平台 | 10 首 DSD 中位数 (s) | 处理速度 (MB/s) | 相对性能 |
| --- | ---:| ---:| ---:|
| macOS M4 Pro | 11.545 | ~333 | 1.00× |
| Windows i7-11800H | 16.793 | 229 | 0.69× |

> Windows DSD 处理性能提升 **14.6 倍**，主要归功于异步双缓冲消除了 4KB 管道缓冲限制导致的 FFmpeg 写阻塞。

---

## 性能建议

- 建议优先使用 Release 构建；并行解码与 SIMD 可显著提升吞吐。
- 对大文件可调整 `--parallel-threads` 与 `--parallel-batch` 平衡吞吐与资源。
