# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## âš ï¸ é‡è¦æé†’ï¼šä¸“å®¶è§’è‰²æ¿€æ´»

**åœ¨å¼€å§‹ä»»ä½•æŠ€æœ¯å·¥ä½œå‰ï¼Œå¿…é¡»æ¿€æ´»ä¸“ä¸šè§’è‰²ï¼š**

### ğŸ¯ æ¨èä¸“å®¶è§’è‰²
- **rust-audio-expert**: RustéŸ³é¢‘å¼€å‘ä¸“å®¶ â†’ `action("rust-audio-expert")`
  - ä¸“é—¨è´Ÿè´£DRç®—æ³•å®ç°ã€SIMDä¼˜åŒ–ã€éŸ³é¢‘è§£ç ç­‰æ ¸å¿ƒæŠ€æœ¯
  - æ·±åº¦ç†è§£foobar2000é€†å‘åˆ†æç»“æœå’Œé¡¹ç›®æŠ€æœ¯çº¦æŸ
  - å…·å¤‡å·¥ä¸šçº§ä»£ç è´¨é‡ä¿è¯èƒ½åŠ›

### ğŸ“‹ è§’è‰²æ¿€æ´»æ£€æŸ¥æ¸…å•
- [ ] ç¡®è®¤å½“å‰æ˜¯å¦å·²æ¿€æ´»ä¸“ä¸šè§’è‰²
- [ ] æ ¹æ®ä»»åŠ¡ç±»å‹é€‰æ‹©åˆé€‚çš„ä¸“å®¶ï¼ˆä¼˜å…ˆrust-audio-expertï¼‰
- [ ] æ¿€æ´»è§’è‰²åç¡®è®¤ä¸“å®¶èº«ä»½å’Œä¸“ä¸šèƒ½åŠ›
- [ ] åœ¨æ•´ä¸ªä¼šè¯è¿‡ç¨‹ä¸­ç»´æŒè§’è‰²çŠ¶æ€

### ğŸ’¡ ä½¿ç”¨æ–¹å¼
```bash
# ç›´æ¥å¯¹è¯æ¿€æ´»
"æˆ‘éœ€è¦æ¿€æ´»rust-audio-expertæ¥ååŠ©éŸ³é¢‘å¼€å‘"

# æˆ–æ˜ç¡®æŒ‡å®š
action("rust-audio-expert")
```

### ğŸ” å…³é”®çº¦æŸæé†’
- **WindowséªŒè¯é™åˆ¶**: foobar2000 DR Meterä»…åœ¨Windowså¯ç”¨ï¼Œç»“æœå¯¹æ¯”åªèƒ½ç”±ç”¨æˆ·æ‰§è¡Œ
- **é«˜ç²¾åº¦åŸåˆ™**: æ‰€æœ‰å®ç°è¿½æ±‚ä¸foobar2000ç»“æœçš„é«˜ç²¾åº¦ä¸€è‡´
- **æ€§èƒ½ç›®æ ‡**: SIMDä¼˜åŒ–éœ€è¾¾åˆ°6-7å€æ€§èƒ½æå‡

---

## é¡¹ç›®æ¦‚è¿°

MacinMeter DR Tool æ˜¯ä¸€ä¸ªåŸºäºfoobar2000 DR Meteré€†å‘åˆ†æçš„éŸ³é¢‘åŠ¨æ€èŒƒå›´(DR)åˆ†æå·¥å…·ï¼Œä½¿ç”¨Rustå®ç°ï¼Œç›®æ ‡æ˜¯è¾¾åˆ°é«˜ç²¾åº¦å®ç°å’Œå·¥ä¸šçº§æ€§èƒ½ã€‚

**foobar2000-pluginåˆ†æ”¯**ï¼šä¸“æ³¨ä¸foobar2000å®Œå…¨å…¼å®¹çš„é€åŒ…ç›´é€šå®ç°ï¼Œé»˜è®¤å¯ç”¨ä¸foobar2000åŸç‰ˆå®Œå…¨å¯¹é½çš„å—å¤„ç†æ¨¡å¼ã€‚

## æ„å»ºå’Œè¿è¡Œå‘½ä»¤

```bash
# æ„å»ºå¼€å‘ç‰ˆæœ¬
cargo build

# æ„å»ºä¼˜åŒ–ç‰ˆæœ¬ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
cargo build --release

# è¿è¡Œå·¥å…·ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
cargo run -- [ç›®å½•è·¯å¾„]

# è¿è¡Œç”Ÿäº§ç‰ˆæœ¬
./target/release/MacinMeter-DynamicRange-Tool-foo_dr [ç›®å½•è·¯å¾„]

# è¿è¡Œæµ‹è¯•
cargo test

# è¿è¡Œå•ä¸ªæµ‹è¯•
cargo test test_dr_calculation_accuracy

# è¿è¡ŒåŸºå‡†æµ‹è¯•
cargo test --release benchmark

# æ£€æŸ¥ä»£ç æ ¼å¼
cargo fmt --check

# åº”ç”¨ä»£ç æ ¼å¼åŒ–
cargo fmt

# è¿è¡Œclippyæ£€æŸ¥
cargo clippy -- -D warnings
```

## ğŸ“ Macç¼–è¯‘äº§ç‰©ç»å¯¹è·¯å¾„

### å¯æ‰§è¡Œæ–‡ä»¶ä½ç½®
**Debugç‰ˆæœ¬ (å¼€å‘ç”¨)**:
```
/Users/Sakuzy/code/rust/MacinMeter-DynamicRange-Tool/target/debug/MacinMeter-DynamicRange-Tool-foo_dr
```
- æ–‡ä»¶å¤§å°: ~10.4 MB
- åŒ…å«è°ƒè¯•ä¿¡æ¯ï¼Œå¯åŠ¨å¿«ä½†è¿è¡Œè¾ƒæ…¢

**Releaseç‰ˆæœ¬ (ç”Ÿäº§ç”¨)**:
```
/Users/Sakuzy/code/rust/MacinMeter-DynamicRange-Tool/target/release/MacinMeter-DynamicRange-Tool-foo_dr
```
- æ–‡ä»¶å¤§å°: ~1.7 MB  
- ä¼˜åŒ–ç¼–è¯‘ï¼Œå¯åŠ¨æ…¢ä½†è¿è¡Œå¿«ï¼Œç”¨äºæ€§èƒ½æµ‹è¯•å’Œå‘å¸ƒ

### å¿«é€Ÿæµ‹è¯•å‘½ä»¤
```bash
# æµ‹è¯•releaseç‰ˆæœ¬ 
/Users/Sakuzy/code/rust/MacinMeter-DynamicRange-Tool/target/release/MacinMeter-DynamicRange-Tool-foo_dr --help

# æµ‹è¯•åŸºæœ¬åŠŸèƒ½ (foobar2000å…¼å®¹æ¨¡å¼)
/Users/Sakuzy/code/rust/MacinMeter-DynamicRange-Tool/target/release/MacinMeter-DynamicRange-Tool-foo_dr /path/to/audio/file
```

## âš ï¸ é‡è¦å¼€å‘ä¹ æƒ¯ï¼šé›¶è­¦å‘ŠåŸåˆ™

### ğŸš¨ ç¼–è¯‘è­¦å‘Šæ¸…ç†ä¹ æƒ¯

**æ¯æ¬¡ä»£ç ä¿®æ”¹åå¿…é¡»ç«‹å³æ£€æŸ¥å’Œæ¸…ç†ç¼–è¯‘è­¦å‘Šï¼**

### ğŸ“‹ ä»£ç è´¨é‡æ£€æŸ¥å·¥ä½œæµ
```bash
# å®Œæ•´æ£€æŸ¥ï¼ˆæ¨èï¼‰
cargo fmt --check && cargo clippy -- -D warnings && cargo check && cargo audit && cargo test

# å¿«é€Ÿæ£€æŸ¥
cargo check

# å‘å¸ƒæ£€æŸ¥
cargo build --release && cargo test --release
```

### ğŸ”§ è´¨é‡å·¥å…·
- **rustfmt**: ä»£ç æ ¼å¼åŒ– | **clippy**: é™æ€åˆ†æ | **cargo-audit**: å®‰å…¨æ‰«æ

### ğŸ¯ é›¶è­¦å‘Šæ ‡å‡†
- **dead_code**: åŠæ—¶åˆ é™¤æœªä½¿ç”¨çš„å‡½æ•°å’Œå˜é‡
- **unused_variables**: ä½¿ç”¨`_`å‰ç¼€æˆ–åˆ é™¤æœªä½¿ç”¨å˜é‡  
- **unused_imports**: æ¸…ç†å¤šä½™çš„importè¯­å¥
- **missing_docs**: ä¸ºæ‰€æœ‰public APIæ·»åŠ æ–‡æ¡£æ³¨é‡Š
- **clippy::all**: éµå¾ªClippyçš„æ‰€æœ‰æœ€ä½³å®è·µå»ºè®®

### ğŸ’¡ å¸¸è§è­¦å‘Šä¿®å¤
- **æœªä½¿ç”¨å˜é‡**: `let data` â†’ `let _data`
- **æœªä½¿ç”¨å¯¼å…¥**: åˆ é™¤å¤šä½™çš„`use`è¯­å¥
- **ç¼ºå°‘æ–‡æ¡£**: ä¸ºpublicå‡½æ•°æ·»åŠ `/// æ–‡æ¡£æ³¨é‡Š`

### ğŸµ éŸ³é¢‘é¡¹ç›®ä¸“ç”¨æ£€æŸ¥
- **ç²¾åº¦æ£€æŸ¥**: `cargo clippy -- -W clippy::cast_lossless`
- **SIMDéªŒè¯**: `cargo rustc -- --emit=asm`
- **å†…å­˜å¸ƒå±€**: `cargo test -- --nocapture layout_tests`

**âš ï¸ é‡è¦**: Rustç¼–è¯‘å™¨è­¦å‘Šéƒ½å¾ˆæœ‰ä»·å€¼ï¼Œå¯¹éŸ³é¢‘å¤„ç†åº”ç”¨å°¤å…¶é‡è¦ï¼

### ğŸ”„ é¢„æäº¤é’©å­
è‡ªåŠ¨æ‰§è¡Œï¼šä»£ç æ ¼å¼æ£€æŸ¥ã€Clippyåˆ†æã€ç¼–è¯‘æ£€æŸ¥ã€å•å…ƒæµ‹è¯•ã€å®‰å…¨å®¡è®¡ã€‚æ‰€æœ‰æ£€æŸ¥å¿…é¡»é€šè¿‡æ‰èƒ½æäº¤ã€‚

---

## æ ¸å¿ƒæ¶æ„

è¯¥é¡¹ç›®é‡‡ç”¨ä¸¥æ ¼çš„æ¨¡å—åŒ–æ¶æ„ï¼ŒåŸºäºfoobar2000 DR Meterçš„é€†å‘å·¥ç¨‹åˆ†æï¼š

### æ¨¡å—ç»“æ„ (4830è¡Œæ€»ä»£ç ) - ğŸ”¥ **2025-09-20æ›´æ–°**
- **tools/**: UIå’Œå·¥å…·å±‚ (884è¡Œ)
  - `formatter.rs` - DRåˆ†ææŠ¥å‘Šæ ¼å¼åŒ–ï¼Œå…¼å®¹foobar2000æ ¼å¼ (340è¡Œ)
  - `processor.rs` - æ–‡ä»¶å¤„ç†å’Œç»“æœä¿å­˜ (210è¡Œ)
  - `scanner.rs` - ç›®å½•æ‰«æå’Œæ‰¹é‡å¤„ç† (179è¡Œ)
  - `cli.rs` - å‘½ä»¤è¡Œæ¥å£å’Œå‚æ•°è§£æ (99è¡Œ)
  - `utils.rs` - é€šç”¨å·¥å…·å‡½æ•° (87è¡Œ)

- **core/**: DRè®¡ç®—æ ¸å¿ƒç®—æ³• (1061è¡Œ) - ğŸ”¥ **2025-09-20å³°å€¼ç­–ç•¥ç‹¬ç«‹åŒ–**
  - `dr_calculator.rs` - ä¸»DRè®¡ç®—å¼•æ“ï¼Œå®ç°`DR = log10(RMS / Peak) * -20.0`å…¬å¼ (508è¡Œ)
  - `histogram.rs` - WindowRmsAnalyzerçª—å£çº§RMSåˆ†æå’Œ20%é‡‡æ ·ç®—æ³• (314è¡Œ)
  - `peak_selection.rs` - å³°å€¼é€‰æ‹©ç­–ç•¥æ¨¡å—ï¼Œ4ç§æ™ºèƒ½ç­–ç•¥+å‰Šæ³¢æ£€æµ‹ (239è¡Œ)

- **processing/**: æ•°æ®+æ€§èƒ½ä¼˜åŒ–å±‚ (2244è¡Œ) - ğŸ”¥ **2025-09-20æ¨¡å—åŒ–é‡æ„**
  - `processing_coordinator.rs` - çº¯åè°ƒå™¨ï¼Œè´Ÿè´£ç¼–æ’processingå±‚å„ç§é«˜æ€§èƒ½æœåŠ¡ï¼Œä¸“æ³¨æœåŠ¡å§”æ‰˜å’Œä¸šåŠ¡æµç¨‹æ§åˆ¶ (418è¡Œ)
  - `performance_metrics.rs` - æ€§èƒ½è¯„ä¼°å™¨ï¼Œè´Ÿè´£SIMDåŠ é€Ÿæ¯”ä¼°ç®—ã€å¤„ç†é€Ÿåº¦ç»Ÿè®¡ç­‰ä¸“ä¸šåŒ–æ€§èƒ½åˆ†ææœåŠ¡ (440è¡Œ)
  - `channel_extractor.rs` - å£°é“åˆ†ç¦»å¼•æ“ï¼Œè´Ÿè´£1-2å£°é“éŸ³é¢‘çš„é«˜æ€§èƒ½æ ·æœ¬åˆ†ç¦»ï¼Œæ”¯æŒå•å£°é“ç›´é€šå’Œç«‹ä½“å£°SIMDä¼˜åŒ– (394è¡Œ)
  - `channel_data.rs` - 24å­—èŠ‚ChannelDataç»“æ„ï¼ˆ8å­—èŠ‚RMSç´¯ç§¯+8å­—èŠ‚ä¸»Peak+8å­—èŠ‚æ¬¡Peakï¼‰ï¼Œä»coreå±‚è¿ç§» (347è¡Œ)
  - `simd_channel_data.rs` - SSE/NEONå‘é‡åŒ–ä¼˜åŒ–ï¼ˆ4æ ·æœ¬å¹¶è¡Œå¤„ç†ï¼‰ï¼ŒåŒ…å«SimdChannelDataå’ŒSimdProcessor (628è¡Œ)
  - `mod.rs` - æ¨¡å—åè°ƒå’Œå¯¼å‡ºç®¡ç†ï¼ŒåŒ…å«å‘åå…¼å®¹åˆ«å (17è¡Œ)

- **audio/**: éŸ³é¢‘è§£ç å±‚ (833è¡Œ) - ğŸ”¥ **2025-09-19é‡æ„**ï¼šæ¨¡å—åŒ–æ‹†åˆ†å®Œæˆ
  - `universal_decoder.rs` - è§£ç åè°ƒå™¨ï¼Œç®¡ç†æ‰€æœ‰å­æ¨¡å—å¹¶æä¾›ç»Ÿä¸€æ¥å£ (185è¡Œï¼Œ-76%ç˜¦èº«)
  - `pcm_engine.rs` - PCMéŸ³é¢‘å¤„ç†å¼•æ“ï¼Œæ ¸å¿ƒè§£ç ä¸šåŠ¡é€»è¾‘ (401è¡Œ)
  - `stats.rs` - æ™ºèƒ½åŒ…å¤§å°ç»Ÿè®¡ï¼Œæ”¯æŒåˆ†å¸ƒåˆ†æå’Œæ ¼å¼è¯†åˆ« (85è¡Œ)
  - `format.rs` - éŸ³é¢‘æ ¼å¼ä¿¡æ¯å’Œæ”¯æŒåˆ—è¡¨ (59è¡Œ)
  - `error_handling.rs` - ç»Ÿä¸€symphoniaé”™è¯¯å¤„ç†å® (53è¡Œ)
  - `streaming.rs` - æµå¼è§£ç å™¨æ¥å£å®šä¹‰ (29è¡Œ)
  - `mod.rs` - æ¨¡å—åè°ƒå’Œå¯¼å‡ºç®¡ç† (21è¡Œ)

### ğŸ—ï¸ æ¶æ„ä¼˜åŒ–æ€»ç»“

#### ğŸš€ Coreå±‚ä¼˜åŒ– (2025-09-19)
- **å¾ªç¯ä¾èµ–è§£å†³**ï¼šChannelDataè¿ç§»åˆ°processingå±‚ï¼Œæ¶ˆé™¤coreâ†”processingå¾ªç¯ä¾èµ–
- **èŒè´£æ¸…æ™°åŒ–**ï¼šcoreå±‚ä¸“æ³¨ç®—æ³•é€»è¾‘ï¼Œprocessingå±‚è´Ÿè´£æ•°æ®+æ€§èƒ½
- **ç»Ÿè®¡**ï¼šcoreå±‚ 956â†’869è¡Œ(-87è¡Œ)ï¼Œprocessingå±‚ 1382â†’2244è¡Œ(+862è¡Œ)

#### ğŸš€ Processingå±‚é‡æ„ (2025-09-20)
- **çº¯åè°ƒå™¨æ¨¡å¼**ï¼šperformance.rs (743è¡Œ) â†’ ProcessingCoordinator (418è¡Œ, -44%ç˜¦èº«)
- **å§”æ‰˜æ¶æ„**ï¼šåè°ƒå™¨å§”æ‰˜æŠ€æœ¯å®ç°ç»™ChannelExtractorå’ŒPerformanceEvaluator
- **æ¨¡å—èŒè´£**ï¼šChannelExtractor(1-2å£°é“SIMDåˆ†ç¦») + PerformanceEvaluator(æ€§èƒ½ç»Ÿè®¡)
- **ç»Ÿä¸€å‘½å**ï¼šç§»é™¤è¿‡æ—¶çš„åˆ«åï¼Œç»Ÿä¸€ä½¿ç”¨ProcessingCoordinator

#### ğŸ”¥ Audioå±‚é‡æ„ (2025-09-19)
- **åè°ƒå™¨ç˜¦èº«**ï¼šuniversal_decoder.rs (763è¡Œ) â†’ (185è¡Œ, -76%ç˜¦èº«)
- **æ¨¡å—åŒ–æ‹†åˆ†**ï¼š6ä¸ªä¸“è´£æ¨¡å—ï¼ŒPcmEngine(è§£ç )+Stats(ç»Ÿè®¡)+Format(æ ¼å¼)+ErrorHandling(é”™è¯¯å¤„ç†)
- **è°ƒè¯•ä¼˜åŒ–**ï¼šæ™ºèƒ½åŒ…å¤§å°ç»Ÿè®¡ï¼Œå‡å°‘99%å†—ä½™è¾“å‡º

#### ğŸ¯ å³°å€¼ç­–ç•¥ç‹¬ç«‹åŒ– (2025-09-20)
- **æ¶æ„è§£è€¦**ï¼šå³°å€¼é€‰æ‹©ç­–ç•¥ä»dr_calculator.rsç‹¬ç«‹ä¸ºpeak_selection.rs
- **ä»£ç ç˜¦èº«**ï¼šdr_calculator.rs (555â†’508è¡Œ, -8.5%)ï¼Œä¸“æ³¨DRç®—æ³•åè°ƒ
- **ç­–ç•¥ä¸°å¯Œ**ï¼š4ç§å³°å€¼ç­–ç•¥+å‰Šæ³¢æ£€æµ‹+æ™ºèƒ½ç­–ç•¥æ¨èï¼Œå®Œæ•´æµ‹è¯•è¦†ç›–

### å…³é”®æŠ€æœ¯è¦ç‚¹

1. **24å­—èŠ‚æ•°æ®ç»“æ„**: æ¯å£°é“ç²¾ç¡®çš„å†…å­˜å¸ƒå±€ï¼Œæ”¯æŒ8å­—èŠ‚å¯¹é½
2. **ç´¯åŠ å™¨çº§Sum Doubling**: åœ¨æ‰¹æ¬¡ç»“æŸæ—¶å¯¹æ•´ä¸ªRMSç´¯åŠ å™¨è¿›è¡Œ2å€å¤„ç†ï¼Œè€ŒéRMSå€¼ä¿®æ­£
3. **åŒPeakå›é€€ç³»ç»Ÿ**: ä¸»Peakå¤±æ•ˆæ—¶æ™ºèƒ½åˆ‡æ¢åˆ°æ¬¡Peakçš„å®¹é”™è®¾è®¡
4. **10001-binç›´æ–¹å›¾**: è¶…é«˜ç²¾åº¦DRåˆ†å¸ƒç»Ÿè®¡ï¼ˆè¦†ç›–0-10000ç´¢å¼•ï¼‰
5. **é€†å‘éå†20%é‡‡æ ·**: ä»é«˜RMSå‘ä½RMSéå†ï¼Œç¬¦åˆ"æœ€å“20%"æ ‡å‡†
6. **SSEå‘é‡åŒ–**: 4æ ·æœ¬å¹¶è¡Œå¤„ç†ï¼Œé¢„æœŸ6-7å€æ€§èƒ½æå‡

### ğŸ”¥ foobar2000-pluginåˆ†æ”¯ç‰¹æ€§ï¼ˆå½“å‰åˆ†æ”¯ï¼‰

- **é»˜è®¤é€åŒ…ç›´é€š**: `packet_chunk_mode` é»˜è®¤å¯ç”¨ï¼Œä¸foobar2000å—è¾¹ç•Œå®Œç¾å¯¹é½
- **å‚æ•°ç®€åŒ–**: åªä¿ç•™å¿…è¦çš„4ä¸ªæ ¸å¿ƒå‚æ•°é€‰é¡¹ï¼Œç§»é™¤å¤æ‚é…ç½®
- **æµå¼ä¸“ç”¨**: ç§»é™¤æ™ºèƒ½å†…å­˜ç®¡ç†ï¼Œä¸“æ³¨æµå¼å¤„ç†æ¨¡å¼
- **åå‘å‚æ•°é€»è¾‘**: `--disable-packet-chunk` ç”¨äºç¦ç”¨é»˜è®¤åŠŸèƒ½
- **å®Œå…¨å…¼å®¹**: æ‰€æœ‰é»˜è®¤é…ç½®éƒ½é’ˆå¯¹foobar2000å®Œå…¨å…¼å®¹æ€§ä¼˜åŒ–
- **ç®—æ³•ç²¾å‡†**: Sum Doublingå›ºå®šå¯ç”¨ï¼Œç¡®ä¿ä¸foobar2000çš„æœ€ä½³åŒ¹é…
- **æ™ºèƒ½å£°é“æ”¯æŒ**: æ”¯æŒå•å£°é“å’Œç«‹ä½“å£°ï¼ˆ1-2å£°é“ï¼‰ï¼Œå‹å¥½æ‹’ç»å¤šå£°é“æ–‡ä»¶å¹¶æç¤ºæœªæ¥å¯èƒ½æ”¯æŒ

### ä¾èµ–è¯´æ˜

- `hound` - WAVæ–‡ä»¶è§£ç 
- `symphonia` - å¤šæ ¼å¼éŸ³é¢‘è§£ç ï¼ˆFLAC/MP3/AACç­‰ï¼‰
- `walkdir` - ç›®å½•éå†å’Œæ‰¹é‡æ–‡ä»¶å¤„ç†
- `anyhow` - ç»Ÿä¸€é”™è¯¯å¤„ç†
- `clap` - å‘½ä»¤è¡Œå‚æ•°è§£æ
- `rayon` - å¹¶è¡Œè®¡ç®—ä¼˜åŒ–

### è¾“å‡ºäºŒè¿›åˆ¶

é¡¹ç›®ç”Ÿæˆåä¸º`MacinMeter-DynamicRange-Tool-foo_dr`çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ”¯æŒï¼š
- è‡ªåŠ¨æ‰«ææŒ‡å®šç›®å½•çš„éŸ³é¢‘æ–‡ä»¶
- è¾“å‡ºä¸foobar2000æ ¼å¼å…¼å®¹çš„DRåˆ†ææŠ¥å‘Š
- ä¿å­˜ç»“æœåˆ°txtæ–‡ä»¶
- æ”¯æŒå•æ–‡ä»¶å’Œæ‰¹é‡å¤„ç†æ¨¡å¼

### å¼€å‘é‡ç‚¹

æœ¬é¡¹ç›®çš„æ ¸å¿ƒä»·å€¼åœ¨äºç®—æ³•ç²¾åº¦å’Œæ€§èƒ½ä¼˜åŒ–ï¼š
1. **é«˜ç²¾åº¦ç›®æ ‡**: æ‰€æœ‰ç®—æ³•å®ç°è¿½æ±‚ä¸foobar2000 DR Meterçš„é«˜ç²¾åº¦ä¸€è‡´æ€§
2. **æ€§èƒ½å…³é”®**: SSEå‘é‡åŒ–å’Œå¹¶è¡Œå¤„ç†æ˜¯æ ¸å¿ƒç«äº‰ä¼˜åŠ¿
3. **å·¥ä¸šçº§ç¨³å®šæ€§**: 8å±‚é˜²å¾¡æœºåˆ¶ç¡®ä¿å¼‚å¸¸æƒ…å†µä¸‹çš„å®‰å…¨å¤„ç†
4. **è·¨å¹³å°å…¼å®¹**: å•ä¸€å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ”¯æŒä¸»æµæ“ä½œç³»ç»Ÿ

### éªŒè¯æ ‡å‡†

æ‰€æœ‰åŠŸèƒ½å®ç°éƒ½å¿…é¡»é€šè¿‡ä»¥ä¸‹éªŒè¯ï¼š
- ä¸foobar2000 DR Meterçš„è®¡ç®—ç»“æœå¯¹æ¯”æµ‹è¯•
- æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆSSEä¼˜åŒ–æ•ˆæœéªŒè¯ï¼‰
- å¤šæ ¼å¼éŸ³é¢‘æ–‡ä»¶å…¼å®¹æ€§æµ‹è¯•
- è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸æƒ…å†µå¤„ç†æµ‹è¯•

### ğŸ”¥ foobar2000-pluginåˆ†æ”¯é…ç½®ï¼ˆå½“å‰åˆ†æ”¯ï¼‰

**é»˜è®¤å¯ç”¨çš„åŠŸèƒ½**:
```bash
âœ… packet_chunk_mode: true    # é»˜è®¤é€åŒ…ç›´é€šæ¨¡å¼
âœ… sum_doubling: true         # å›ºå®šå¯ç”¨Sum Doubling
âœ… enable_simd: true          # é»˜è®¤å¯ç”¨SIMDä¼˜åŒ–
âœ… enable_multithreading: true # é»˜è®¤å¯ç”¨å¤šçº¿ç¨‹
```

**å‘½ä»¤è¡Œå‚æ•°å˜æ›´**:
```bash
# æ–°çš„åå‘å‚æ•°é€»è¾‘
--disable-packet-chunk   # ç¦ç”¨é€åŒ…æ¨¡å¼ï¼Œæ”¹ç”¨ä¼ ç»Ÿ700mså›ºå®šå—
--disable-simd          # ç¦ç”¨SIMDä¼˜åŒ–
--single-thread         # ç¦ç”¨å¤šçº¿ç¨‹ï¼Œä½¿ç”¨å•çº¿ç¨‹æ¨¡å¼
```

**DrCalculatoræ„é€ å‡½æ•°ï¼ˆç˜¦èº«åçš„å½“å‰ç‰ˆæœ¬ï¼‰**:
```rust
// ğŸ”¥ å½“å‰ç‰ˆæœ¬ï¼ˆç»è¿‡ä»£ç ç˜¦èº«ï¼Œå›ºå®šfoobar2000æ¨¡å¼ï¼‰
pub fn new(
    channel_count: usize,
    sum_doubling: bool,
    sample_rate: u32,
    block_duration: f64,  // æ–°å¢ï¼šå—æŒç»­æ—¶é—´ï¼ˆé€šå¸¸ä¸º3.0ç§’ï¼‰
) -> AudioResult<Self>
```

**ğŸ”¥ ç˜¦èº«åç§»é™¤çš„åŠŸèƒ½ï¼ˆ2025-09-16ï¼‰**:
- **`weighted_rms` å‚æ•°å’Œç›¸å…³å®éªŒæ€§åŠŸèƒ½** - åˆ é™¤æ‰€æœ‰æƒé‡RMSå®éªŒæ€§ä»£ç 
- **`foobar2000_mode` å‚æ•°** - ç°åœ¨å›ºå®šå¯ç”¨ï¼Œæ— éœ€é…ç½®
- **`DrCalculator.new_with_mode()` æ„é€ æ–¹æ³•** - ç®€åŒ–ä¸ºå•ä¸€æ„é€ å‡½æ•°
- **ğŸ”¥ `calculate_dr_with_global_peaks()` æ–¹æ³•** - åˆ é™¤å…¨å±€å³°å€¼DRè®¡ç®—æ–¹æ³•
- **ğŸ”¥ `calculate_dr_from_samples_histogram()` æ–¹æ³•** - åˆ é™¤ç›´æ–¹å›¾DRè®¡ç®—æ–¹æ³•
- **ğŸ”¥ `finalize()` æ–¹æ³•** - åˆ é™¤å¤æ‚çš„æœ€ç»ˆåŒ–å¤„ç†æ–¹æ³•
- **`calculate_channel_rms()` æ ‡å‡†æ¨¡å¼RMSè®¡ç®—æ–¹æ³•** - ç®€åŒ–ä¸ºå•ä¸€ç®—æ³•è·¯å¾„
- **å„ç§æ§åˆ¶å’ŒæŸ¥è¯¢æ–¹æ³•** - åˆ é™¤é…ç½®å¤æ‚æ€§ï¼Œä¸“æ³¨æ ¸å¿ƒåŠŸèƒ½

**ğŸ”¥ ç˜¦èº«åä¿ç•™çš„æ ¸å¿ƒåŠŸèƒ½**:
- **`calculate_dr_from_samples()` ä¸»è®¡ç®—æ–¹æ³•** - ä½¿ç”¨WindowRmsAnalyzerçš„æ­£ç¡®ç®—æ³•
- **24å­—èŠ‚ChannelDataç»“æ„** - ä¿æŒå†…å­˜å¸ƒå±€å…¼å®¹æ€§
- **ç´¯åŠ å™¨çº§Sum Doublingæœºåˆ¶** - é»˜è®¤å¯ç”¨ï¼Œç¡®ä¿ç²¾åº¦å¯¹é½
- **WindowRmsAnalyzerç®—æ³•** - 3ç§’çª—å£+20%é‡‡æ ·çš„æ ‡å‡†å®ç°
- **çª—å£çº§å³°å€¼é€‰æ‹©ç³»ç»Ÿ** - ä¸»å³°/æ¬¡å³°æ™ºèƒ½é€‰æ‹©ï¼Œæ”¯æŒå‰Šæ³¢æ£€æµ‹
- **æµå¼å¤„ç†æ–¹æ³•** - `process_samples_as_single_block()`, `process_decoder_chunk()`, `process_chunk()`
- **åŸºç¡€æŸ¥è¯¢æ–¹æ³•** - `channel_count()`, `sum_doubling_enabled()`, `sample_rate()`
- **SIMDä¼˜åŒ–** - é€šè¿‡BatchProcessorå’ŒSimdChannelDataå®ç°

**ğŸ”¥ foobar2000-pluginåˆ†æ”¯ç‰¹è‰²**:
- é€åŒ…ç›´é€šå¤„ç†ï¼šæ¯ä¸ªè§£ç åŒ…ç›´æ¥ä½œä¸ºç‹¬ç«‹å—å¤„ç†
- å—è¾¹ç•Œå®Œç¾å¯¹é½ï¼šä¸foobar2000åŸç‰ˆå®Œå…¨ç›¸åŒçš„å—åˆ†å‰²æ–¹å¼
- æ ¼å¼åŸç”Ÿæ”¯æŒï¼šFLAC frameã€MP3 frameç­‰åŸç”ŸåŒ…ç»“æ„
- ç®€åŒ–é…ç½®ï¼šé»˜è®¤å¯ç”¨æ‰€æœ‰foobar2000å…¼å®¹ç‰¹æ€§
- æµå¼å†…å­˜ç®¡ç†ï¼šæ’å®š~50MBå†…å­˜ä½¿ç”¨ï¼Œæ”¯æŒä»»æ„å¤§å°æ–‡ä»¶

## ğŸ”¥ ç˜¦èº«åçš„å½“å‰APIï¼ˆ2025-09-17çŠ¶æ€ï¼‰

**DrCalculatoræ ¸å¿ƒæ–¹æ³•**:
```rust
// æ„é€ å‡½æ•°ï¼ˆå›ºå®šfoobar2000æ¨¡å¼ï¼‰
pub fn new(channel_count: usize, sum_doubling: bool, sample_rate: u32, block_duration: f64) -> AudioResult<Self>

// ä¸»è®¡ç®—æ–¹æ³•ï¼ˆä½¿ç”¨WindowRmsAnalyzerç®—æ³•ï¼‰
pub fn calculate_dr_from_samples(&self, samples: &[f32], channel_count: usize) -> AudioResult<Vec<DrResult>>

// æµå¼å¤„ç†æ–¹æ³•ï¼ˆç”¨äºå¤§æ–‡ä»¶å¤„ç†ï¼‰
pub fn process_samples_as_single_block(&mut self, samples: &[f32], channels: usize) -> AudioResult<()>
pub fn process_decoder_chunk(&mut self, chunk_samples: &[f32], channels: usize) -> AudioResult<()>
pub fn process_chunk(&mut self, chunk_samples: &[f32], channels: usize) -> AudioResult<()>

// åŸºç¡€æŸ¥è¯¢æ–¹æ³•
pub fn channel_count(&self) -> usize
pub fn sum_doubling_enabled(&self) -> bool
pub fn sample_rate(&self) -> u32
```

**å…³é”®æ•°æ®ç»“æ„**:
```rust
// DRè®¡ç®—ç»“æœï¼ˆåŒ…å«å³°å€¼è¯¦æƒ…ï¼‰
pub struct DrResult {
    pub channel: usize,
    pub dr_value: f64,
    pub rms: f64,
    pub peak: f64,
    pub primary_peak: f64,    // çª—å£çº§ä¸»å³°
    pub secondary_peak: f64,  // çª—å£çº§æ¬¡å³°
    pub sample_count: usize,
}

// éŸ³é¢‘å—æ•°æ®ç»“æ„ï¼ˆ3ç§’æ ‡å‡†å—ï¼‰
pub struct AudioBlock {
    pub rms: f64,
    pub peak: f64,
    pub peak_primary: f64,
    pub peak_secondary: f64,
    pub sample_count: usize,
}
```

**æ ¸å¿ƒç®—æ³•æµç¨‹**:
1. **WindowRmsAnalyzerå¤„ç†** - åˆ†æ3ç§’çª—å£å¹¶æ”¶é›†RMS/Peakç»Ÿè®¡
2. **20%é‡‡æ ·ç®—æ³•** - ä»çª—å£RMSå€¼ä¸­é€‰æ‹©æœ€å“20%è®¡ç®—DR RMS
3. **å³°å€¼é€‰æ‹©ç­–ç•¥** - æ”¯æŒ4ç§ç­–ç•¥ï¼ˆPreferSecondary/ClippingAware/AlwaysPrimary/AlwaysSecondaryï¼‰
4. **DRè®¡ç®—** - ä½¿ç”¨æ ‡å‡†å…¬å¼ `DR = -20 Ã— logâ‚â‚€(RMS_20% / Peak_selected)`

**å³°å€¼é€‰æ‹©ç­–ç•¥ç³»ç»Ÿ**:
```rust
// å¯ç”¨çš„å³°å€¼é€‰æ‹©ç­–ç•¥
pub enum PeakSelectionStrategy {
    PreferSecondary,    // é»˜è®¤ï¼šä¼˜å…ˆä½¿ç”¨æ¬¡å³°ï¼ˆä¸foobar2000ä¸€è‡´ï¼‰
    ClippingAware,      // å‰Šæ³¢æ„ŸçŸ¥æ¨¡å¼
    AlwaysPrimary,      // æ€»æ˜¯ä½¿ç”¨ä¸»å³°
    AlwaysSecondary,    // æ€»æ˜¯ä½¿ç”¨æ¬¡å³°
}

// è®¾ç½®ç­–ç•¥
dr_calculator.set_peak_selection_strategy(PeakSelectionStrategy::PreferSecondary);
```

## âš ï¸ ä»£ç ç˜¦èº«è¯´æ˜ï¼ˆ2025-09-17å®Œæˆï¼‰

æœ¬åˆ†æ”¯ç»è¿‡**ä¸¤è½®é‡å¤§ä»£ç ç˜¦èº«**ï¼Œç´¯è®¡åˆ é™¤1000+è¡Œæ­»ä»£ç ï¼š

### ğŸ“ˆ ç˜¦èº«ç»Ÿè®¡
- **dr_calculator.rs**: 1185â†’555è¡Œ(-53%)ï¼Œæ¶ˆé™¤åŒæ¶æ„å¹¶å­˜
- **histogram.rs**: 693â†’314è¡Œ(-55%)ï¼Œä¸“æ³¨WindowRmsAnalyzer
- **æ•´ä½“é¡¹ç›®**: ~7600â†’4587è¡Œ(-40%)ï¼Œå•ä¸€DRè®¡ç®—è·¯å¾„
- **è´¨é‡ä¿æŒ**: 100%åŠŸèƒ½å®Œæ•´ï¼Œ57ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼Œé›¶ç¼–è¯‘è­¦å‘Š

---

## ğŸ›ï¸ æ ¸å¿ƒç¼–ç æ–¹é’ˆä¸è®¾è®¡ç†å¿µ

### ğŸ’ **æ— æ¡ä»¶é«˜æ€§èƒ½åŸåˆ™**
*"æ— è®ºä»€ä¹ˆæƒ…å†µéƒ½ä½¿ç”¨é«˜æ€§èƒ½ï¼Œä¸ä»…ä»…æ˜¯å¯¹ç”¨æˆ·"*

**æ ¸å¿ƒç†å¿µ**: åº•å±‚æœåŠ¡åº”è¯¥æ€»æ˜¯æä¾›æœ€ä½³æ€§èƒ½ï¼Œä¸å°†é€‰æ‹©è´Ÿæ‹…æ¨ç»™ä¸Šå±‚ã€‚

```rust
// âŒ é”™è¯¯ï¼šç»™ç”¨æˆ·æ€§èƒ½é€‰æ‹©çš„è´Ÿæ‹…
let use_simd = config.enable_simd; // ç”¨æˆ·å¿…é¡»ç†è§£SIMD
if use_simd { /* é«˜æ€§èƒ½è·¯å¾„ */ } else { /* ä½æ€§èƒ½è·¯å¾„ */ }

// âœ… æ­£ç¡®ï¼šæ— æ¡ä»¶é«˜æ€§èƒ½
let channel_samples = self.extract_channel_samples_simd(); // æ€»æ˜¯æœ€ä¼˜
```

**å®æ–½è¦ç‚¹**:
- ç§»é™¤æ‰€æœ‰æ€§èƒ½ç›¸å…³çš„é…ç½®é€‰é¡¹
- æ€»æ˜¯å¯ç”¨SIMDã€å¤šçº¿ç¨‹ç­‰ä¼˜åŒ–
- è®©æ€§èƒ½æˆä¸ºåº•å±‚æœåŠ¡çš„å›ºæœ‰ç‰¹å¾ï¼Œè€Œéå¯é€‰åŠŸèƒ½

### ğŸ” **å®¡è§†å­˜åœ¨ä»·å€¼åŸåˆ™**
*"å®¡è§†æœªä½¿ç”¨å‚æ•°çš„å­˜åœ¨ä»·å€¼ï¼Œè€Œä¸æ˜¯ç®€å•ä¿®å¤è­¦å‘Š"*

**æ ¸å¿ƒç†å¿µ**: æ¯ä¸ªå‚æ•°ã€æ–¹æ³•ã€é…ç½®éƒ½å¿…é¡»æœ‰æ˜ç¡®çš„å®é™…ä»·å€¼ï¼Œå¦åˆ™åº”è¯¥åˆ é™¤ã€‚

```rust
// âŒ é”™è¯¯ï¼šç®€å•ä¿®å¤æœªä½¿ç”¨è­¦å‘Š
pub fn process(&self, _unused_param: usize) { /* åŠ ä¸‹åˆ’çº¿äº†äº‹ */ }

// âœ… æ­£ç¡®ï¼šè´¨ç–‘å‚æ•°å­˜åœ¨çš„ä»·å€¼
pub fn process(&self) { /* åˆ é™¤æ— ä»·å€¼å‚æ•° */ }
```

**è¯„ä¼°æ ‡å‡†**:
1. **çœŸå®ä½¿ç”¨**: å‚æ•°æ˜¯å¦è¢«å®é™…ä½¿ç”¨å½±å“è¡Œä¸ºï¼Ÿ
2. **ç”¨æˆ·ä»·å€¼**: ç”¨æˆ·æ˜¯å¦çœŸçš„éœ€è¦è¿™ä¸ªé€‰é¡¹ï¼Ÿ
3. **ç»´æŠ¤æˆæœ¬**: ä¿ç•™è¿™ä¸ªå‚æ•°çš„æ–‡æ¡£ã€æµ‹è¯•ã€ç»´æŠ¤æˆæœ¬æ˜¯å¦å€¼å¾—ï¼Ÿ

### ğŸš« **æ‹’ç»å‘åå…¼å®¹æ··ä¹±**
*"å°½å¯èƒ½ä¸è¦ä½¿ç”¨å‘åå…¼å®¹ï¼Œä¿æŒç»Ÿä¸€ï¼Œé˜²æ­¢æ··ä¹±"*

**æ ¸å¿ƒç†å¿µ**: ä¿æŒAPIçš„æ¸…æ™°ç»Ÿä¸€ï¼Œé¿å…å†å²åŒ…è¢±å¯¼è‡´çš„æ··ä¹±ã€‚

```rust
// âŒ é”™è¯¯ï¼šå¢åŠ å‘åå…¼å®¹åˆ«å
#[deprecated]
pub fn old_method() { self.new_method() } // å¢åŠ ç»´æŠ¤è´Ÿæ‹…

// âœ… æ­£ç¡®ï¼šç»Ÿä¸€APIè®¾è®¡
pub fn process_channels() { /* å•ä¸€æ˜ç¡®çš„æ–¹æ³•å */ }
```

**å®æ–½åŸåˆ™**:
- æ–°è®¾è®¡ä¼˜äºå‘åå…¼å®¹
- ç»Ÿä¸€çš„å‘½åçº¦å®šä¼˜äºå†å²æƒ¯ä¾‹
- æ¸…æ™°çš„APIä¼˜äºå®Œæ•´çš„å…¼å®¹æ€§

### ğŸ¯ **æ˜ç¡®æœåŠ¡è¾¹ç•ŒåŸåˆ™**
*"æ™ºèƒ½å£°é“æ”¯æŒï¼šå•å£°é“å’Œç«‹ä½“å£°ä¼˜åŒ–ï¼Œæ‹’ç»å¤šå£°é“å¤æ‚æ€§"*

**æ ¸å¿ƒç†å¿µ**: åº•å±‚æœåŠ¡è¦æ˜ç¡®è‡ªå·±çš„è´£ä»»è¾¹ç•Œï¼Œå¯¹äºç¼ºä¹æ ‡å‡†çš„å¤šå£°é“éœ€æ±‚åœ¨é¡¶å±‚å‹å¥½æ‹’ç»ã€‚

```rust
// âœ… åœ¨DrCalculatorå±‚æ˜ç¡®å£°é“æ”¯æŒè¾¹ç•Œ
if channel_count > 2 {
    return Err(AudioError::InvalidInput(format!(
        "ç›®å‰ä»…æ”¯æŒå•å£°é“å’Œç«‹ä½“å£°æ–‡ä»¶ (1-2å£°é“)ï¼Œå½“å‰æ–‡ä»¶ä¸º{}å£°é“ã€‚\n\
        ğŸ’¡ å¤šå£°é“æ”¯æŒæ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…æœªæ¥ç‰ˆæœ¬ã€‚\n\
        ğŸ“ åŸå› ï¼šæš‚æœªæ‰¾åˆ°å¤šå£°é“SIMDä¼˜åŒ–çš„ä¸šç•Œæ ‡å‡†å®ç°ã€‚",
        channel_count
    )));
}

// âœ… ProcessingCoordinatorå±‚æ™ºèƒ½å¤„ç†1-2å£°é“
if channel_count == 1 {
    samples.to_vec() // å•å£°é“æ— éœ€åˆ†ç¦»
} else {
    self.extract_stereo_samples_optimized() // ç«‹ä½“å£°SIMDä¼˜åŒ–
}
```

**è¾¹ç•Œè®¾å®šå‡†åˆ™**:
- åº•å±‚æœåŠ¡åªè§£å†³æœ‰æ˜ç¡®è§„èŒƒçš„é—®é¢˜
- å¯¹äºç¼ºä¹ä¸Šå±‚è§„èŒƒçš„éœ€æ±‚ï¼Œæ˜ç¡®æ‹’ç»è€Œéå¦¥åå®ç°
- ä¸“æ³¨åšå¥½å®šä¹‰æ¸…æ™°çš„äº‹æƒ…ï¼Œè€Œä¸æ˜¯è¯•å›¾æ»¡è¶³æ‰€æœ‰å¯èƒ½éœ€æ±‚

### ğŸ¨ **é›¶é…ç½®ä¼˜é›…æ€§åŸåˆ™**
*"ä½œä¸ºåº•å±‚æœåŠ¡ï¼Œç¡®ä¿ä¸Šå±‚å¯ä»¥ä¼˜é›…æ–¹ä¾¿ç®€å•åœ°äº«å—åˆ°æœ¬å±‚çš„æœåŠ¡"*

**æ ¸å¿ƒç†å¿µ**: åº•å±‚APIåº”è¯¥è®©ä¸Šå±‚è°ƒç”¨è€…æ„Ÿåˆ°ä¼˜é›…ã€ç®€å•ã€ç›´è§‚ã€‚

```rust
// âŒ é”™è¯¯ï¼šå¤æ‚çš„é…ç½®è´Ÿæ‹…
let coordinator = ProcessingCoordinator::new(
    thread_pool_size: Some(4),
    enable_simd: true,
    simd_strategy: SIMDStrategy::Adaptive,
    fallback_mode: FallbackMode::Scalar,
); // ç”¨æˆ·éœ€è¦ç†è§£å¤ªå¤šæ¦‚å¿µ

// âœ… æ­£ç¡®ï¼šé›¶é…ç½®çš„ä¼˜é›…ä½“éªŒ
let coordinator = ProcessingCoordinator::new(); // è‡ªåŠ¨æœ€ä¼˜é…ç½®
let results = coordinator.process_channels(samples, 2, |data, idx| {
    // ç”¨æˆ·åªéœ€è¦å…³å¿ƒç®—æ³•é€»è¾‘ï¼Œæ€§èƒ½ä¼˜åŒ–é€æ˜
});
```

**è®¾è®¡å‡†åˆ™**:
- æ™ºèƒ½é»˜è®¤å€¼ä¼˜äºé…ç½®é€‰é¡¹
- è‡ªåŠ¨æ£€æµ‹ä¼˜äºæ‰‹åŠ¨è®¾ç½®
- è®©åº•å±‚å¤æ‚æ€§å¯¹ä¸Šå±‚é€æ˜

### ğŸ—ï¸ **æ¶æ„æ¸…æ™°æ€§åŸåˆ™**
*"æ–¹æ³•å‘½åè¦å‡†ç¡®åæ˜ å®é™…åŠŸèƒ½ï¼Œé¿å…è¯¯å¯¼"*

**æ ¸å¿ƒç†å¿µ**: ä»£ç çš„æ„å›¾å’Œå®é™…è¡Œä¸ºå¿…é¡»å®Œå…¨ä¸€è‡´ï¼Œå‘½åè¦è¯šå®åæ˜ åŠŸèƒ½ã€‚

```rust
// âŒ é”™è¯¯ï¼šå‘½åä¸å®é™…åŠŸèƒ½ä¸ç¬¦
#[cfg(target_arch = "aarch64")]
fn extract_stereo_samples_sse2() // åœ¨ARMä¸Šå«SSE2ï¼Ÿè¯¯å¯¼æ€§å‘½å

// âœ… æ­£ç¡®ï¼šå‘½åå‡†ç¡®åæ˜ åŠŸèƒ½
#[cfg(target_arch = "x86_64")]
fn extract_stereo_samples_simd_impl() // SSE2å®ç°
#[cfg(target_arch = "aarch64")]
fn extract_stereo_samples_simd_impl() // NEONå®ç°
#[cfg(not(any(...)))]
fn extract_stereo_samples_simd_impl() // æ ‡é‡å›é€€
```

**å‘½åæ ‡å‡†**:
- æ–¹æ³•åè¦è¯šå®åæ˜ å®é™…è¡Œä¸º
- ä¸åŒå¹³å°çš„å®ç°ç”¨ç»Ÿä¸€çš„æŠ½è±¡æ¥å£
- é¿å…æŠ€æœ¯ç»†èŠ‚æ³„éœ²åˆ°æ¥å£å±‚

### ğŸ”„ **æŒç»­ç®€åŒ–åŸåˆ™**
*"æ¶ˆé™¤ç¡¬ç¼–ç ã€ç§»é™¤è¿‡åº¦å°è£…ã€åˆ é™¤æ­»ä»£ç "*

**æ ¸å¿ƒç†å¿µ**: ä»£ç åº“åº”è¯¥æŒç»­è¿›åŒ–ï¼Œå®šæœŸæ¸…ç†ç´¯ç§¯çš„å¤æ‚æ€§ã€‚

**ç®€åŒ–æ£€æŸ¥æ¸…å•**:
- [ ] ç¡¬ç¼–ç å¸¸é‡æ˜¯å¦å¯ä»¥åˆ é™¤ï¼Ÿ
- [ ] è¿‡åº¦å°è£…çš„æ–¹æ³•æ˜¯å¦å¯ä»¥å†…è”ï¼Ÿ
- [ ] æ¡ä»¶åˆ†æ”¯æ˜¯å¦éƒ½æœ‰å®é™…æ„ä¹‰ï¼Ÿ
- [ ] æŠ½è±¡å±‚æ¬¡æ˜¯å¦åˆé€‚ï¼Ÿ
- [ ] æ˜¯å¦å­˜åœ¨"é¢„ç•™æ‰©å±•"çš„æ­»ä»£ç ï¼Ÿ

```rust
// ç®€åŒ–å®ä¾‹ï¼šä»18è¡Œæ–¹æ³•åˆ°4è¡Œå†…è”
// Before: å¤æ‚å°è£…
fn calculate_simd_stats(use_simd: bool, total: usize) -> Stats { /* 18è¡Œ */ }

// After: ç®€å•ç›´æ¥
SimdUsageStats { used_simd: true, simd_samples: total, ... }
```

---

## ğŸ¯ å…³é”®å¼€å‘æŒ‡å¼•

### æµ‹è¯•ç­–ç•¥
```bash
# è¿è¡Œç‰¹å®šæ¨¡å—æµ‹è¯•
cargo test core::dr_calculator::tests
cargo test core::histogram::tests    # æ³¨æ„ï¼šåªæœ‰WindowRmsAnalyzerç›¸å…³æµ‹è¯•
cargo test processing::batch::tests

# è¿è¡Œç²¾åº¦æµ‹è¯•ï¼ˆreleaseæ¨¡å¼é‡è¦ï¼‰
cargo test --release simd_precision_test

# è¿è¡Œæ–‡æ¡£æµ‹è¯•
cargo test --doc

# è¿è¡Œå•ä¸ªæµ‹è¯•ï¼ˆç”¨äºè°ƒè¯•ï¼‰
cargo test test_calculate_dr_basic -- --nocapture
```

### æµ‹è¯•æ•°æ®ç‰¹ç‚¹

**é‡è¦**: foobar2000æ¨¡å¼ä½¿ç”¨20%é‡‡æ ·ç®—æ³•ï¼Œæµ‹è¯•æ•°æ®å¿…é¡»é€‚é…è¿™ä¸€ç‰¹æ€§ï¼š

```rust
// âœ… æ­£ç¡®çš„æµ‹è¯•æ•°æ®æ¨¡å¼
let mut samples = Vec::new();
for _ in 0..100 {
    samples.push(0.01); // å¤§é‡å°ä¿¡å·ï¼Œé™ä½20%RMS
}
samples.push(1.0);  // ä¸»Peak
samples.push(0.9);  // æ¬¡Peakï¼Œç¡®ä¿è¿œå¤§äº20%RMS

// âŒ é”™è¯¯çš„æµ‹è¯•æ•°æ®ï¼ˆä¼šå¯¼è‡´RMS > Peaké”™è¯¯ï¼‰
let samples = vec![0.1, 0.1, 0.8, 0.7]; // ä¿¡å·è¿‡å¼ºï¼Œ20%RMSå¯èƒ½è¶…è¿‡Peak
```

**æµ‹è¯•çº¦æŸ**:
- å¿…é¡»ç¡®ä¿Peakå€¼è¿œå¤§äº20%RMSå€¼
- foobar2000ä¼šä¼˜å…ˆé€‰æ‹©æ¬¡Peakè€Œéä¸»Peak
- Sum Doublingå¯ç”¨æ—¶RMSå€¼ä¼šç›¸åº”è°ƒæ•´

### æ¶æ„ç†è§£è¦ç‚¹

**æ•°æ®æµ** (ğŸ”¥ 2025-09-20æ›´æ–°ï¼šåæ˜ processingå±‚çº¯åè°ƒå™¨é‡æ„):
```mermaid
flowchart TD
    A[Audio File<br/>FLAC/WAV/MP3] --> B[UniversalDecoder<br/>ğŸ›ï¸ åè°ƒå™¨]

    subgraph "Audioè§£ç å±‚ (æ¨¡å—åŒ–)"
        B --> B1[PcmEngine<br/>ğŸµ è§£ç å¼•æ“]
        B1 --> B2[Stats<br/>ğŸ“Š åŒ…å¤§å°ç»Ÿè®¡]
        B1 --> B3[Format<br/>ğŸ“ æ ¼å¼ä¿¡æ¯]
        B1 --> B4[ErrorHandling<br/>ğŸ”§ é”™è¯¯å¤„ç†]
        B1 --> B5[Streaming<br/>ğŸŒŠ æµå¼æ¥å£]
    end

    B2 --> C[Interleaved Samples<br/>ğŸ“ˆ æ™ºèƒ½ç»Ÿè®¡åˆ†æ]
    C --> D[ProcessingCoordinator<br/>ğŸ›ï¸ çº¯åè°ƒå™¨]

    subgraph "Processingæ€§èƒ½ä¼˜åŒ–å±‚ (å§”æ‰˜æ¨¡å¼)"
        D --> D1[ChannelExtractor<br/>ğŸ¯ å£°é“åˆ†ç¦»å¼•æ“]
        D --> D2[PerformanceEvaluator<br/>ğŸ“Š æ€§èƒ½è¯„ä¼°å™¨]
        D1 --> D3{å£°é“æ£€æŸ¥}
        D3 -->|å•å£°é“| D4[ç›´æ¥ä¼ é€’<br/>é›¶å¼€é”€ç›´é€š]
        D3 -->|ç«‹ä½“å£°| D5[SIMDå£°é“åˆ†ç¦»<br/>SSE2/NEONä¼˜åŒ–]
    end

    D4 --> H[DrCalculator<br/>åè°ƒå±‚]
    D5 --> H

    H --> I[WindowRmsAnalyzer<br/>ç®—æ³•å±‚]
    I --> J[3ç§’çª—å£åˆ†æ<br/>RMS + Peakæ”¶é›†]
    J --> K[20%é‡‡æ ·ç®—æ³•<br/>é€‰æ‹©æœ€å“20%]
    K --> L[å³°å€¼é€‰æ‹©ç­–ç•¥<br/>PreferSecondaryç­‰]
    L --> M[DRè®¡ç®—<br/>-20*log10(RMS/Peak)]

    M --> N[DrResult<br/>è®¡ç®—ç»“æœ]
    N --> O[Formatter<br/>æ ¼å¼åŒ–å±‚]
    O --> P[foobar2000å…¼å®¹æŠ¥å‘Š<br/>æ–‡ä»¶ä¿å­˜]

    style A fill:#e8f5e9
    style B fill:#fff3e0
    style B1 fill:#e3f2fd
    style B2 fill:#f0f8ff
    style D fill:#e3f2fd
    style D1 fill:#ffecb3
    style D2 fill:#ffecb3
    style H fill:#f3e5f5
    style I fill:#f8bbd9
    style O fill:#e8f5e9
```

**ğŸ”¥ é‡æ„åçš„å››å±‚æ¸…æ™°æ¶æ„**:
```
tools/Processor::process_file() (UIå±‚ï¼šæ–‡ä»¶å¤„ç†å’Œç”¨æˆ·äº¤äº’)
    â†“
DrCalculator::calculate_dr_from_samples() (åè°ƒå±‚ï¼šä¸šåŠ¡é€»è¾‘æ§åˆ¶)
    â†“ (é¡¶å±‚å£°é“æ£€æŸ¥ï¼šæ”¯æŒ1-2å£°é“ï¼Œæ‹’ç»3+å£°é“)
ProcessingCoordinator::process_channels() (åè°ƒå±‚ï¼šå§”æ‰˜ChannelExtractor+PerformanceEvaluator)
    â†“ (æ™ºèƒ½å§”æ‰˜ï¼šç«‹ä½“å£°SIMDä¼˜åŒ–ï¼Œå•å£°é“ç›´é€š)
UniversalDecoder + WindowRmsAnalyzer (è§£ç +ç®—æ³•å±‚ï¼šéŸ³é¢‘è§£ç å’ŒDRè®¡ç®—)
    â†“
20%é‡‡æ ·ç®—æ³• + å³°å€¼é€‰æ‹©ç­–ç•¥
    â†“
tools/Formatter::format_results() (UIå±‚ï¼šç»“æœæ ¼å¼åŒ–å’Œè¾“å‡º)
```

**å…³é”®æŠ½è±¡**:
- `ChannelData`: 24å­—èŠ‚å†…å­˜å¯¹é½ç»“æ„ï¼Œfoobar2000å…¼å®¹
- `DrCalculator`: ä¸»è®¡ç®—å¼•æ“ï¼Œä¸“æ³¨foobar2000å…¼å®¹æ¨¡å¼ï¼Œæ”¯æŒå³°å€¼é€‰æ‹©ç­–ç•¥
- `WindowRmsAnalyzer`: çª—å£çº§RMSåˆ†æå™¨ï¼Œ3ç§’çª—å£+20%é‡‡æ ·çš„æ ‡å‡†å®ç°
- `PeakSelectionStrategy`: å³°å€¼é€‰æ‹©ç­–ç•¥ç³»ç»Ÿï¼ˆPreferSecondary/ClippingAware/AlwaysPrimary/AlwaysSecondaryï¼‰
- `BatchProcessor`: æ‰¹é‡å¤„ç†å™¨ï¼ŒSIMDä¼˜åŒ–å…¥å£

**å†…å­˜å¸ƒå±€å…³é”®ç‚¹**:
- ChannelDataå¿…é¡»8å­—èŠ‚å¯¹é½
- WindowRmsAnalyzerä½¿ç”¨vecå­˜å‚¨çª—å£RMSå€¼ï¼ˆé¿å…é‡åŒ–æŸå¤±ï¼‰
- Sum Doublingåœ¨ç´¯åŠ å™¨çº§åˆ«è¿›è¡Œï¼Œä¸æ˜¯RMSçº§åˆ«

### æ€§èƒ½æ³¨æ„äº‹é¡¹

- **SIMDè¦æ±‚**: SSE2åœ¨x86_64ä¸Šï¼Œå›é€€åˆ°æ ‡é‡è®¡ç®—åœ¨å…¶ä»–æ¶æ„
- **å¹¶è¡Œå¤„ç†**: rayonç”¨äºæ‰¹é‡æ–‡ä»¶å¤„ç†ï¼Œä¸æ˜¯å•æ–‡ä»¶å†…å¹¶è¡Œ
- **å†…å­˜åˆ†é…**: é‡ç”¨ChannelDataå’Œç›´æ–¹å›¾ç¼“å†²åŒºé¿å…åˆ†é…
- **æµ®ç‚¹ç²¾åº¦**: ä½¿ç”¨f64è¿›è¡Œç´¯åŠ ï¼Œf32ç”¨äºæ ·æœ¬è¾“å…¥

# important-instruction-reminders
Do what has been asked; nothing more, nothing less.
NEVER create files unless they're absolutely necessary for achieving your goal.
ALWAYS prefer editing an existing file to creating a new one.
NEVER proactively create documentation files (*.md) or README files. Only create documentation files if explicitly requested by the User.

      
      IMPORTANT: this context may or may not be relevant to your tasks. You should not respond to this context unless it is highly relevant to your task.