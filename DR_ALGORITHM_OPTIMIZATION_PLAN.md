# DRç®—æ³•ä¼˜åŒ–å®æ–½è®¡åˆ’

**åˆ›å»ºæ—¶é—´**: 2025-10-24
**çŠ¶æ€**: è¿›è¡Œä¸­
**åŸºäº**: ç®—æ³•å®¡æŸ¥æŠ¥å‘Šï¼ˆ2025-10-24ï¼‰

---

## æ€»ä½“ç»“è®º

å½“å‰å®ç°éµå¾ª"çª—å£çº§20%é‡‡æ · + å³°å€¼ç­–ç•¥ + foobar2000 Sum Doubling"ç®—æ³•è·¯å¾„ï¼Œç»“æ„æ¸…æ™°ã€‚å­˜åœ¨å†…å­˜ä¸å¸¸é‡è·¯å¾„ä¸Šçš„ä¼˜åŒ–ç©ºé—´ï¼Œä¸»è¦ä¼˜åŒ–ä»¥"ç­‰ä»·ã€é›¶é£é™©"ä¸ºå‰æã€‚

---

## Phase 1: æµå¼åŒå³°è·Ÿè¸ªä¼˜åŒ– ğŸ¯

**ä¼˜å…ˆçº§**: é«˜
**é£é™©**: é›¶ï¼ˆå®Œå…¨ç­‰ä»·ï¼‰
**çŠ¶æ€**: å¾…å®æ–½

### ç›®æ ‡
ç§»é™¤ `current_window_samples: Vec<f64>` ç¼“å­˜ï¼Œç”¨æµå¼è¿½è¸ªæ›¿ä»£å°¾çª—Peaké‡ç®—

### å½“å‰é—®é¢˜
- **å†…å­˜å¼€é”€**: æ¯ä¸ªçª—å£ä¿å­˜ f64Ã—çª—å£é•¿åº¦ï¼ˆ44.1kHzçº¦130KB/çª—å£ï¼‰
- **è®¡ç®—å¼€é”€**: å°¾çª—éœ€éå†æ•´ä¸ªç¼“å­˜é‡ç®—Peakï¼ˆO(n)æ‰«æï¼‰
- **ä½ç½®**: `src/core/histogram.rs:51, 78-82, 201-224`

### å®æ–½æ–¹æ¡ˆ
åœ¨ `WindowRmsAnalyzer` ä¸­ç»´æŠ¤æµå¼çŠ¶æ€ï¼š
```rust
struct PeakTracker {
    max_value: f64,      // å½“å‰æœ€å¤§å€¼
    max_count: usize,    // æœ€å¤§å€¼å‡ºç°æ¬¡æ•°
    second_max: f64,     // æ¬¡å¤§å€¼
    last_sample: f64,    // æœ€åä¸€ä¸ªæ ·æœ¬
}
```

**å°¾çª—Peakè°ƒæ•´é€»è¾‘**ï¼š
```rust
if abs(last) < max â†’ è°ƒæ•´åPeak = max
if abs(last) == max && max_count > 1 â†’ Peak = max
else â†’ Peak = second_max (ä¸å­˜åœ¨åˆ™0)
```

### é¢„æœŸæ”¶ç›Š
- **å†…å­˜**: å‡å°‘~130KB/çª—å£ï¼ˆå¯¹é•¿éŸ³é¢‘æ–‡ä»¶æ˜¾è‘—ï¼‰
- **æ€§èƒ½**: æ¶ˆé™¤å°¾çª—O(n)éå†
- **æ­£ç¡®æ€§**: å®Œå…¨ç­‰ä»·ï¼Œé›¶åŠŸèƒ½å˜æ›´

### æµ‹è¯•ç­–ç•¥
åˆ›å»º 3 ç±»å›å½’æµ‹è¯•ï¼š
1. å°¾çª—æœ€åæ ·æœ¬ = æœ€å¤§å€¼ä¸”å”¯ä¸€
2. å°¾çª—æœ€åæ ·æœ¬ = æœ€å¤§å€¼ä½†å‡ºç°å¤šæ¬¡
3. å°¾çª—æœ€åæ ·æœ¬ â‰  æœ€å¤§å€¼

### éªŒæ”¶æ ‡å‡†
- [ ] æ‰€æœ‰ç°æœ‰æµ‹è¯•é€šè¿‡
- [ ] 3ä¸ªæ–°å›å½’æµ‹è¯•é€šè¿‡
- [ ] `cargo clippy` é›¶è­¦å‘Š
- [ ] å†…å­˜ä½¿ç”¨å‡å°‘ï¼ˆå¯æµ‹é‡ï¼‰

---

## Phase 2: ä¸´æ—¶æ•°ç»„æ„é€ è½»é‡åŒ– ğŸ”§

**ä¼˜å…ˆçº§**: ä¸­
**é£é™©**: ä½
**çŠ¶æ€**: å¾…å®æ–½

### ç›®æ ‡
ä¼˜åŒ– 20% RMS é‡‡æ ·çš„ä¸´æ—¶æ•°ç»„æ„é€ æ–¹å¼

### å½“å‰é—®é¢˜
- **ä½ç½®**: `src/core/histogram.rs:166-179`
- **ä½æ•ˆ**: å…ˆ `vec![0.0; seg_cnt]` å¡«é›¶ï¼Œå†é€é¡¹æ‹·è´

### å®æ–½æ–¹æ¡ˆ
```rust
// ä¿®æ”¹å‰
let mut rms_array = vec![0.0; seg_cnt];
for (i, &val) in self.window_rms_values.iter().enumerate() {
    rms_array[i] = val;
}

// ä¿®æ”¹å
let mut rms_array = self.window_rms_values.clone();
if has_virtual_zero {
    rms_array.push(0.0);
}
```

### é¢„æœŸæ”¶ç›Š
- é¿å…ä¸€æ¬¡å¡«é›¶æ“ä½œ
- å‡å°‘æ‰‹å·¥å¤åˆ¶å¾ªç¯
- è¯­ä¹‰æ›´æ¸…æ™°

### éªŒæ”¶æ ‡å‡†
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ä»£ç æ›´ç®€æ´
- [ ] é›¶åŠŸèƒ½å˜æ›´

---

## Phase 3: å®¹é‡é¢„ç•™ä¼˜åŒ– ğŸ“Š

**ä¼˜å…ˆçº§**: ä½
**é£é™©**: é›¶
**çŠ¶æ€**: å¾…å®æ–½

### ç›®æ ‡
é¢„åˆ†é… Vec å®¹é‡ï¼Œå‡å°‘åŠ¨æ€æ‰©å®¹ realloc

### å®æ–½æ–¹æ¡ˆ
åœ¨ `process_samples()` é¦–æ¬¡è°ƒç”¨æ—¶ï¼š
```rust
let estimated_windows = total_samples / window_len + 1;
self.window_rms_values.reserve(estimated_windows);
self.window_peaks.reserve(estimated_windows);
```

### é¢„æœŸæ”¶ç›Š
- å‡å°‘å¤šæ¬¡ realloc è°ƒç”¨
- æ”¹å–„å†…å­˜åˆ†é…æ¨¡å¼
- å¯¹é•¿éŸ³é¢‘æ–‡ä»¶æ•ˆæœæ˜æ˜¾

### éªŒæ”¶æ ‡å‡†
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] æ— æ€§èƒ½é€€åŒ–

---

## Phase 4: æµ‹è¯•å¥—ä»¶å¢å¼º ğŸ§ª

**ä¼˜å…ˆçº§**: é«˜ï¼ˆé…åˆPhase 1ï¼‰
**çŠ¶æ€**: å¾…å®æ–½

### æ–°å¢æµ‹è¯•

#### 4.1 å°¾çª—ç­‰ä»·æ€§å›å½’æµ‹è¯•ï¼ˆPhase 1 å¿…é¡»ï¼‰
```rust
test_tail_window_peak_adjustment_unique_max()
test_tail_window_peak_adjustment_duplicate_max()
test_tail_window_peak_adjustment_non_max()
```

#### 4.2 å†…å­˜/æ€§èƒ½åŸºå‡†æµ‹è¯•
```rust
test_memory_usage_large_audio()  // æµ‹è¯•å†…å­˜å³°å€¼
test_processing_throughput()     // æµ‹è¯•å¤„ç†é€Ÿåº¦
```

#### 4.3 20% é‡‡æ ·è¾¹ç•Œæµ‹è¯•
```rust
test_20_percent_sampling_small_segments()   // seg_cnt=1~5
test_20_percent_sampling_large_segments()   // seg_cnt=1000+
```

### éªŒæ”¶æ ‡å‡†
- [ ] æ‰€æœ‰æ–°æµ‹è¯•é€šè¿‡
- [ ] æµ‹è¯•è¦†ç›–ç‡æå‡
- [ ] æ— è¯¯æŠ¥

---

## Phase 5: æ–‡æ¡£æ¸…ç† ğŸ“

**ä¼˜å…ˆçº§**: ä½
**çŠ¶æ€**: å¾…å®æ–½

### ç›®æ ‡
æ¾„æ¸… `sum_doubling_enabled` æ ‡å¿—çš„å®é™…ä½¿ç”¨æƒ…å†µ

### å½“å‰é—®é¢˜
- **ä½ç½®**: `src/core/histogram.rs:63`
- **ç°çŠ¶**: å‚æ•°ä¼ å…¥ä½†æœªä½¿ç”¨ï¼ˆ`_sum_doubling`ï¼‰
- **æ··æ·†**: ä»£ç ä¸­å›ºå®šå¯ç”¨ Sum Doublingï¼Œä½†æœ‰æœªç”¨å‚æ•°

### æ–¹æ¡ˆï¼ˆæ¨èï¼‰
æ–‡æ¡£è¯´æ˜ï¼š
```rust
/// `sum_doubling`: é¢„ç•™å‚æ•°ï¼Œå½“å‰foobar2000å…¼å®¹æ¨¡å¼å›ºå®šå¯ç”¨Sum Doubling
/// æœªæ¥å¦‚éœ€å¯é…ç½®å†æ¥å…¥RMSè®¡ç®—
```

### éªŒæ”¶æ ‡å‡†
- [ ] æ–‡æ¡£æ¸…æ™°å‡†ç¡®
- [ ] æ— APIç ´å

---

## ğŸš« æ˜ç¡®ä¸åšçš„ä¼˜åŒ–

æ ¹æ®æŠ¥å‘Šå»ºè®®ï¼Œä»¥ä¸‹ä¼˜åŒ–**ä¸åº”æ‰§è¡Œ**ï¼š

### âŒ é€šè¿‡ç›´æ–¹å›¾å›æ¨20%é‡‡æ ·
- **åŸå› **: æœ‰é‡åŒ–è¯¯å·®ï¼Œå½“å‰å®ç°åˆ»æ„é¿å…
- **å½±å“**: å¯èƒ½å¯¼è‡´ä¸foobar2000ç»“æœä¸ä¸€è‡´

### âŒ Sum Doubling å¯é…ç½®åŒ–
- **åŸå› **: æ”¹åŠ¨RMSå…¬å¼ä¼šå½±å“ç»“æœ
- **é£é™©**: éœ€è¦å¤§é‡å›å½’æµ‹è¯•

### âŒ SIMDåŒ–çª—å£å†…å¹³æ–¹å’Œï¼ˆæš‚ç¼“ï¼‰
- **åŸå› **: å®ç°å¤æ‚ï¼Œå¯¹å°¾çª—é€»è¾‘å’Œæ¬¡å³°å®šä½éœ€å°å¿ƒå¤„ç†
- **å»ºè®®**: å…ˆå®ŒæˆPhase 1-3ï¼Œå†è¯„ä¼°æ”¶ç›Š

---

## å®æ–½é¡ºåº

```
Phase 1 â†’ Phase 4(éƒ¨åˆ†) â†’ Phase 2 â†’ Phase 3 â†’ Phase 4(å‰©ä½™) â†’ Phase 5
   â†“           â†“            â†“          â†“            â†“           â†“
 æ ¸å¿ƒä¼˜åŒ–   å›å½’æµ‹è¯•    å°ä¼˜åŒ–    å¾®ä¼˜åŒ–    å®Œæ•´æµ‹è¯•    æ–‡æ¡£æ¸…ç†
```

### å…³é”®é‡Œç¨‹ç¢‘
- âœ… Phase 1 å®Œæˆåå¿…é¡»é€šè¿‡å›å½’æµ‹è¯•
- âœ… æ¯ä¸ªPhaseéƒ½éœ€ `cargo test --lib` å…¨éƒ¨é€šè¿‡
- âœ… æ€§èƒ½éªŒè¯ï¼š`./benchmark_10x.sh` ç¡®è®¤æ— æ€§èƒ½é€€åŒ–

---

## è¿›åº¦è¿½è¸ª

| Phase | çŠ¶æ€ | å¼€å§‹æ—¶é—´ | å®Œæˆæ—¶é—´ | è´Ÿè´£äºº | å¤‡æ³¨ |
|-------|------|----------|----------|--------|------|
| Phase 1 | ğŸ”„ è¿›è¡Œä¸­ | 2025-10-24 | - | Claude | æµå¼åŒå³°è·Ÿè¸ª |
| Phase 2 | â¸ï¸ å¾…å¼€å§‹ | - | - | - | ä¸´æ—¶æ•°ç»„ä¼˜åŒ– |
| Phase 3 | â¸ï¸ å¾…å¼€å§‹ | - | - | - | å®¹é‡é¢„ç•™ |
| Phase 4 | â¸ï¸ å¾…å¼€å§‹ | - | - | - | æµ‹è¯•å¢å¼º |
| Phase 5 | â¸ï¸ å¾…å¼€å§‹ | - | - | - | æ–‡æ¡£æ¸…ç† |

---

## è´¨é‡ä¿è¯æ£€æŸ¥æ¸…å•

æ¯ä¸ªPhaseå®Œæˆåå¿…é¡»æ‰§è¡Œï¼š

- [ ] `cargo fmt --check`
- [ ] `cargo clippy -- -D warnings`
- [ ] `cargo test --lib`
- [ ] `cargo test --release`ï¼ˆæ…¢é€Ÿæµ‹è¯•ï¼‰
- [ ] `./benchmark_10x.sh`ï¼ˆæ€§èƒ½éªŒè¯ï¼‰
- [ ] ä»£ç å®¡æŸ¥
- [ ] æäº¤commit

---

## å‚è€ƒèµ„æ–™

- ç®—æ³•å®¡æŸ¥æŠ¥å‘Šï¼ˆ2025-10-24ï¼‰
- `src/core/histogram.rs` - æ ¸å¿ƒå®ç°
- `src/core/dr_calculator.rs` - DRè®¡ç®—å™¨
- foobar2000 DR Meteré€†å‘åˆ†ææ–‡æ¡£
