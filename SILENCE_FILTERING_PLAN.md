# 静音过滤（Silence Filtering）——计划与路线图

状态：进行中（实验能力已发布）；默认：关闭（保持 foobar2000 兼容）

## 背景

本项目的 DR 计算遵循 foobar2000 的“3 秒窗口 + 取最响 20% 窗”的方法。实际音频（尤其有损 AAC/MP3/Opus）常见首尾编码延迟/填充导致的低能量段，这些“静音/近静音窗口”会轻微影响 20% 的挑选（扩大分母），从而带来小幅 DR 抬升（通常 +0.01…+0.10 dB）。

## 现状（已上线的实验能力）

- 实现范围
  - 仅做“窗口级”过滤，不改动 PCM 样本本身。
  - 在“取最响 20%”之前过滤：RMS（dBFS）低于阈值的窗口不进入候选集合。
- 外部接口 / CLI
  - CLI：`--filter-silence[=<DB>]`（若不显式给值，默认 −70 dBFS）。示例：
    - 单文件：`./MacinMeter… --filter-silence=-70 audio.wav` 或 `./MacinMeter… --filter-silence audio.wav`
    - 目录：`./MacinMeter… --filter-silence -- /path/to/dir`（注意 `--` 防止把路径当作阈值）
  - AppConfig：`silence_filter_threshold_db: Option<f64>`（有值即启用）。
- 诊断输出（启用时）
  - 按声道打印：被过滤/总窗口数与百分比。
- 默认与兼容性
  - 默认关闭（100% 复现 foobar2000 行为）。启用为“实验用途”。
- 观测效果（formatTEST）
  - 与默认相比，Precise DR 通常降低 −0.01…−0.04 dB；Official DR 不变。
  - 若已用 ffmpeg 去掉边缘静音，我们的过滤往往“无窗可滤”，结果与未过滤一致（符合预期）。
- 已知限制
  - 仅窗口级：不会缩短音频流、不会改变样本数，无法对齐不同格式的窗口相位。
  - AAC/ADTS 无容器级 delay/padding 元数据，过滤无法完全消除 AAC 与 WAV 的微小差异。

## 设计动机与取舍

- 为什么先做“窗口过滤”？风险低、改动小、诊断直观；关闭时完全保留 foobar2000 的口径。
- 为什么默认 −70 dBFS？更保守，尽量避免误删极弱音乐段；且阈值可配置。

## 路线图（分阶段增强）

以下从“窗口级鲁棒”演进到“样本级精确”，同时保持安全默认。

### P0 —— 仅裁"首尾"的样本级裁切（实验）✅ 已完成

**状态**：已在 2025-10-30 完成实现与验证

- 目标：对首/尾连续静音进行样本/帧级裁切；中段静音（艺术表达）不动。
- 方法：对交错 PCM 帧做流式状态机（每帧幅度 = max(|L|,|R|)）
  - 连续低于阈值 ≥ min_run 帧进入"裁切态"；连续高于阈值 ≥ hysteresis 帧转"通过态"。
  - 尾部使用环形缓冲（容量 = min_run）；若检测到持续静音则丢弃尾缓冲，否则回灌。
- **实现参数**（已支持）：
  - `--trim-edges[=<DB>]`：启用边缘裁切，可指定静音阈值（默认 -70 dBFS，范围 -120…0 dB）
  - `--trim-min-run-ms`：最小连续静音持续时长（默认 300ms，范围 50–2000ms）
  - 声道数量大于1时的聚合：取最大值 max(|L|,|R|)，确保任意声道有声音整帧不裁
- 实现细节：
  - 位置：`src/processing/edge_trimmer.rs`（EdgeTrimmer 状态机）
  - 集成：`src/tools/processor.rs`（管道集成 + 诊断输出）
  - 修复内容：min_run 语义、样本计数准确、EOF 混合帧保护、诊断增强
- 复杂度：时间 O(N) 单遍、空间 O(min_run_frames × channels) 环形缓冲
- 验收状态：
  - ✅ 在 formatTEST 中测试确认：短首尾静音正确回灌，长静音正确丢弃
  - ✅ test_compatibility.aac：首尾均保留全部（无符合 min_run 的静音段），DR 结果精确对齐 WAV 基线（10.25 dB）
  - ✅ 对"静音占比高"的合成样本，首尾被裁切而中段停顿保留（符合预期）
  - ✅ 诊断输出清晰显示参数与处理统计

### P1 —— 容器感知的精确对齐（Gapless 级）

- MP4/ALAC：解析 iTunSMPB/edts（encoder delay、padding）并据此裁样本。
- Opus：应用 OggOpusHead 的 pre‑skip。
- FLAC/WAV：通常无需处理。
- 效果：样本级起止精确，还原 gapless。
- 验收：ALAC/Opus 转自 WAV 的 DR 差距收敛至 ≤ 0.01–0.02 dB。

### P2 —— 无元数据的 ADTS/AAC 对齐（自动对齐）

- 源 WAV 与解码后 AAC 做互相关估计开头偏移；裁剪为等长区间再比对。
- 批量场景无源 WAV 时：采用启发式（如 1024 帧延迟 + 末尾补齐）近似裁切。
- 验收：配对 WAV/AAC 的等长对齐后，平均 DR 差距 ≤ 0.01–0.02 dB。

### P3 —— Robust DR（可选，双结果）

- 只在“非静音窗口集合”上计算“最响 20%”，作为附加“Robust DR”。
- 与“Official DR”（原始口径）同时显示；默认关闭。
- 验收：输出标签清晰，不改变默认行为。

### P4 —— 诊断与开发辅助

- 可选导出：被选中 top‑20% 的窗口索引、各窗 RMS（dB）、噪底估计（底部分位数）、生效阈值、过滤前后计数。
- 用 verbose 与 `--debug` 特性开关限制噪声，避免影响常规输出。

### P5 —— 测试与基准覆盖

- 单元/性质测试：
  - 窗口过滤：阈值、迟滞、声道数量大于1、余数窗口等边界。
  - 首尾裁切状态机：古典弱奏误判保护，仅裁首尾。
  - 容器感知对齐（基于治具）：ALAC/Opus。
  - 自动对齐（配对 WAV/AAC）：对偏移与 DR 的容差断言。
- 集成基准（默认忽略）：约束 DR 变化与运行时在回归范围内。

## 兼容性与默认

- 默认保留 foobar2000 兼容（不开过滤、不裁边、不对齐）。
- 所有实验选项：
  - 默认关闭；
  - 启用时打印清晰诊断；
  - 不放宽错误处理，不改变 DR 公式。

## 风险与缓解

- 风险：把极弱音乐段（如古典）误判为静音。
  - 缓解：保守阈值（−70…−80 dBFS）、最小持续时长、迟滞，并仅裁首尾。
- 风险：容器元数据缺失/错误。
  - 缓解：提供“估算对齐”，并明确标注“estimated”；不覆盖 Official DR。
- 风险：自动对齐带来性能开销。
  - 缓解：限制互相关搜索窗口；默认优先使用 P0/P1。

## 实现指引

- 关键代码路径
  - CLI：`src/tools/cli.rs`（`--filter-silence[=<DB>]` → AppConfig.silence_filter_threshold_db）
  - 处理层：`src/tools/processor.rs`（将阈值传入 WindowRmsAnalyzer）
  - 核心分析：`src/core/histogram.rs`（窗口过滤与每声道统计）
- 文档与示例
  - README“命令行选项”包含 `--filter-silence` 的使用说明
  - formatTEST 汇总：`docs/formatTEST_media_summary.md`（含“默认/过滤”对照表）

## 决策记录（Decision Log）

- 2025‑10‑26：发布"窗口级"静音过滤（`--filter-silence[=<DB>]`），默认关闭；简化 CLI；完善诊断与目录模式下的 `--` 用法文档。
- 2025‑10‑30：**完成 P0 实现与验证**（仅裁首尾的样本级裁切，实验开关）：
  - ✅ 修复 min_run 语义：短于 min_run 的首尾静音完整回灌，不误伤
  - ✅ 修复样本计数准确性：用处理后样本数而非原始块大小
  - ✅ 修复 EOF 混合帧丢失：只在末尾确认纯静音时丢弃缓冲
  - ✅ 增强诊断输出：显示参数、统计、处理结果
  - ✅ 补充代码文档：声道数量大于1时的策略、PCM 归一化假设说明
  - 下一步：实现 P1（容器感知对齐，ALAC/Opus）。
