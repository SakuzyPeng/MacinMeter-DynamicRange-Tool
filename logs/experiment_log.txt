===========================================
  MacinMeter DR Tool 机制实验记录
===========================================

📊 实验目标：
逐步验证文档中关键机制对DR计算精度的影响

📋 测试文件：
Ver2-adm-master-from-DAW-spatialmix-noreverb-peaklimited-0-2025-08-29-00-00-55.flac

🎯 foobar2000基准：
声道1: DR9.99
声道2: DR10.43
平均: DR10.21

===========================================

🔬 实验基线 - Early-Version (当前)
时间: 2025-01-20
分支: early-version
特征: 
- 单样本直方图 (无3秒窗口RMS)
- 无RMS系数2修正
- 使用最大Peak值
- 简化20%计算

结果:
声道1: DR9 (RMS:0.303811, Peak:0.838205)
声道2: DR10 (RMS:0.299939, Peak:0.984858)
平均: DR10

vs foobar2000误差:
声道1: -0.99 dB (优秀)
声道2: -0.43 dB (优秀)
平均: -0.21 dB (接近完美)

===========================================

🧪 **实验1完成 - Sum Doubling机制**
时间: 2025-01-20  
修改: 启用√2 RMS补偿机制

结果:
声道1: DR6 (RMS:0.429653, Peak:0.838205)
声道2: DR7 (RMS:0.424177, Peak:0.984858)  
平均: DR7

vs foobar2000误差:
声道1: -3.99 dB (严重偏离)
声道2: -3.43 dB (严重偏离)
平均: -3.21 dB (过度补偿)

🔍 **关键发现**:
- RMS增加√2倍 (0.304→0.430)，符合文档公式
- DR降低3-4dB，说明Sum Doubling对此文件过度补偿
- Peak值未变，证明只影响RMS计算
- Sum Doubling可能仅适用于特定交错音频格式

===========================================

🧪 **实验2完成 - 双Peak智能回退系统**
时间: 2025-01-20
修改: 启用智能Peak验证和回退机制

结果:
声道1: DR9 (RMS:0.303811, Peak:0.833845)
声道2: DR10 (RMS:0.299939, Peak:0.918527)
平均: DR9

vs foobar2000误差:
声道1: -0.99 dB (优秀)
声道2: -0.43 dB (优秀)  
平均: -1.21 dB (轻微偏离)

🔍 **关键发现**:
- RMS值与基线相同，证明只影响Peak选择
- 声道2 Peak从0.984858→0.918527，系统选择了次Peak
- 可能检测到声道2主Peak质量问题（接近削波阈值0.9999）
- DR精度仍然很好，但略低于基线版本

===========================================

🧪 **实验3完成 - 精确加权RMS计算**
时间: 2025-01-20
修改: 启用精确权重公式 0.00000001×index²

结果:
声道1: DR9 (RMS:0.303811, Peak:0.833845)
声道2: DR10 (RMS:0.299939, Peak:0.918527)
平均: DR9

vs foobar2000误差:
声道1: -0.99 dB (优秀)
声道2: -0.43 dB (优秀)
平均: -1.21 dB (轻微偏离)

🔍 **关键发现**:
- RMS和Peak值与实验2完全相同
- 精确权重公式对此文件的直方图分布影响极小
- 可能需要具有不同幅度分布的音频文件来验证权重效果
- 或权重公式需要进一步调整

===========================================

📝 实验计划：
1. [✅完成] Sum Doubling机制 - 发现过度补偿问题
2. [✅完成] 双Peak回退系统 - 智能Peak质量检测生效  
3. [✅完成] 精确加权RMS - 对当前文件无明显影响
4. [待执行] 完整版本对比 - 所有机制综合测试

===========================================

🧪 **实验4完成 - 所有机制综合测试**
时间: 2025-01-20
修改: 启用所有机制（Sum Doubling + 智能Peak + 精确权重）

结果:
声道1: DR6 (RMS:0.429653, Peak:0.833845)
声道2: DR7 (RMS:0.424177, Peak:0.918527)
平均: DR6

vs foobar2000误差:
声道1: -3.99 dB (严重偏离)
声道2: -3.43 dB (严重偏离)
平均: -4.21 dB (过度补偿)

🔍 **关键发现**:
- Sum Doubling主导了结果，RMS增加√2倍
- 智能Peak回退仍然生效（Peak值与实验2、3相同）
- 精确加权RMS未进一步改变结果
- 综合效果与纯Sum Doubling实验相同

===========================================

📊 **完整实验对比表**

| 版本 | 声道1 | 声道2 | 平均 | vs foobar2000误差 | 主要特征 |
|------|-------|-------|------|-----------------|----------|
| **foobar2000基准** | DR9.99 | DR10.43 | DR10.21 | - | 标准参照 |
| **基线版本** | DR9 (0.304/0.838) | DR10 (0.300/0.985) | DR10 | -0.21dB | 简化算法，最优精度 |
| **实验1：Sum Doubling** | DR6 (0.430/0.838) | DR7 (0.424/0.985) | DR7 | -3.21dB | RMS×√2，过度补偿 |
| **实验2：智能Peak** | DR9 (0.304/0.834) | DR10 (0.300/0.919) | DR9 | -1.21dB | Peak质量评估生效 |
| **实验3：精确权重** | DR9 (0.304/0.834) | DR10 (0.300/0.919) | DR9 | -1.21dB | 权重公式无明显影响 |
| **实验4：全功能** | DR6 (0.430/0.834) | DR7 (0.424/0.919) | DR6 | -4.21dB | 所有机制，Sum主导 |

===========================================

🎯 **最终实验结论**:

### 🥇 **最优版本**: 基线版本（Early-Version）
- **精度最高**: 仅-0.21dB误差，几乎完美匹配foobar2000
- **算法简化**: 使用简单Peak选择和单样本直方图
- **稳定可靠**: 无复杂机制引入的副作用

### 📈 **各机制分析**:
1. **Sum Doubling**: 对此文件过度补偿，误差增加3dB+
2. **智能Peak回退**: 轻微影响精度（-1dB），但提供了质量保证
3. **精确加权RMS**: 对当前测试文件无明显影响
4. **机制组合**: Sum Doubling的影响占主导地位

🧪 **实验5验证 - 智能Peak+精确权重组合（无Sum Doubling）**
时间: 2025-01-20
修改: 启用智能Peak回退+精确权重，禁用Sum Doubling

结果:
声道1: DR9 (RMS:0.303811, Peak:0.833845)
声道2: DR10 (RMS:0.299939, Peak:0.918527)
平均: DR9

🔍 **验证发现**:
- 与实验2、3结果完全相同，证明Sum Doubling是主导因素
- 智能Peak+精确权重组合稳定，提供质量保证的同时保持良好精度
- 证实了"关闭Sum Doubling立即恢复正常精度"的假设

===========================================

### 🎯 **推荐策略**:
- **生产环境**: 使用基线版本，精度最优（-0.21dB误差）
- **工业应用**: 使用智能Peak+精确权重组合，质量保证+良好精度（-1.21dB误差）
- **特殊音频**: Sum Doubling需智能检测适用场景，避免过度补偿
- **进一步优化**: 精确权重公式需要更多样化的测试音频验证有效性

===========================================

🔍 **重要发现更新 - 精确权重公式重新验证**
时间: 2025-08-31
简化Peak算法后，重新测试精确权重效果

🧪 **精确权重单独测试**:
命令: cargo run -- audio/xxx.flac --weighted-rms --verbose

结果对比:
| 模式 | 声道1 | 声道2 | 平均DR | RMS变化 |
|------|-------|-------|--------|---------|
| **简化基线** | DR9 (RMS:0.303811) | DR10 (RMS:0.299939) | DR10 | - |
| **精确权重** | DR8 (RMS:0.345007) | DR9 (RMS:0.340175) | DR8 | +14% |

🚨 **关键发现**:
- **RMS显著增加**: 两声道均增加约14%
- **DR值整体降低1dB**: 由于RMS增加而Peak不变
- **与实验3矛盾**: 之前认为"精确权重公式对此文件无明显影响"
- **性能提升**: 处理速度从28.0M提升到39.7M samples/s (+42%)

💡 **技术分析**:
- 精确权重公式 `0.00000001×index²` 让高幅度样本获得平方级权重
- 20% RMS计算向高能量区域偏移
- 导致RMS值增加，DR值降低
- 可能之前测试时有其他因素遮盖了这个效应

### 🎯 **最终推荐**:
- **唯一生产模式**: 简化基线版本（禁用精确权重）
- **原因**: 与foobar2000精度最优（-0.21dB误差）
- **决策**: 移除兼容模式，统一使用最优精度版本