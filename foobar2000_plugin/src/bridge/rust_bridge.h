#pragma once

#include <cstdint>
#include <functional>

// ====================================================================
// ğŸš€ ç°ä»£å¼‚æ­¥FFIæ¡¥æ¥ - é©å‘½æ€§Rustçº¿ç¨‹ç®¡ç†æ¶æ„
// ====================================================================

/**
 * ğŸ¯ ç°ä»£å¼‚æ­¥æ¶æ„è®¾è®¡åŸåˆ™ï¼š
 * - **Rustæ‹¥æœ‰ä¸€åˆ‡**ï¼šçº¿ç¨‹ã€å†…å­˜ã€ç”Ÿå‘½å‘¨æœŸå®Œå…¨ç”±Rustç®¡ç†
 * - **é›¶é˜»å¡è®¾è®¡**ï¼šç«‹å³è¿”å›ä»»åŠ¡IDï¼Œä¸é˜»å¡UIçº¿ç¨‹
 * - **åŸç”Ÿè¿›åº¦æ”¯æŒ**ï¼šå†…ç½®çº¿ç¨‹å®‰å…¨çš„è¿›åº¦å›è°ƒæœºåˆ¶
 * - **å®Œå…¨ç±»å‹å®‰å…¨**ï¼šç¼–è¯‘æ—¶ä¿è¯æ— æ•°æ®ç«äº‰
 * - **æ–©è‰é™¤æ ¹**ï¼šå½»åº•æŠ›å¼ƒæ—§çš„åŒæ­¥æ¥å£
 */

#ifdef __cplusplus
extern "C" {
#endif

// ğŸ“ å›è°ƒå‡½æ•°ç±»å‹å®šä¹‰
typedef void (*ProgressCallback)(int current, int total, const char* message);
typedef void (*CompletionCallback)(const char* result, bool success);

// ğŸ¯ ä¼˜é›…çš„å›è°ƒå¥æŸ„ç±»å‹
typedef unsigned int CallbackHandle;

// ====================================================================
// ğŸŒŸ ä¼˜é›…çš„å›è°ƒæ³¨å†Œæ¥å£
// ====================================================================

/**
 * ğŸ“ æ³¨å†Œè¿›åº¦å›è°ƒå‡½æ•°
 *
 * @param callback è¿›åº¦å›è°ƒå‡½æ•°æŒ‡é’ˆ
 * @return å›è°ƒå¥æŸ„ï¼ˆç”¨äºåç»­è°ƒç”¨ï¼Œ0è¡¨ç¤ºå¤±è´¥ï¼‰
 */
CallbackHandle rust_register_progress_callback(ProgressCallback callback);

/**
 * ğŸ“ æ³¨å†Œå®Œæˆå›è°ƒå‡½æ•°
 *
 * @param callback å®Œæˆå›è°ƒå‡½æ•°æŒ‡é’ˆ
 * @return å›è°ƒå¥æŸ„ï¼ˆç”¨äºåç»­è°ƒç”¨ï¼Œ0è¡¨ç¤ºå¤±è´¥ï¼‰
 */
CallbackHandle rust_register_completion_callback(CompletionCallback callback);

// ====================================================================
// ğŸŒŠ æµå¼åˆ†å—å¤„ç†API - é›¶å†…å­˜å ç”¨çš„ç»ˆæè§£å†³æ–¹æ¡ˆ
// ====================================================================

/**
 * ğŸš€ ã€æµå¼åˆ†æã€‘åˆå§‹åŒ–æµå¼DRåˆ†æä¼šè¯
 *
 * ## é©å‘½æ€§è®¾è®¡
 * - **é›¶å†…å­˜ç´¯ç§¯**ï¼šæ¯ä¸ªéŸ³é¢‘å—ç«‹å³å¤„ç†ï¼Œä¸å­˜å‚¨åœ¨å†…å­˜ä¸­
 * - **å®æ—¶è¿›åº¦**ï¼šåŸºäºfoobar2000è§£ç å™¨çš„çœŸå®è¿›åº¦
 * - **å®Œç¾å…¼å®¹**ï¼šä½¿ç”¨foobar2000è§£ç å™¨ï¼Œ100%å…¼å®¹æ€§
 * - **æ’å®šå†…å­˜**ï¼šæ— è®ºæ–‡ä»¶å¤šå¤§ï¼Œå†…å­˜ä½¿ç”¨å§‹ç»ˆæ’å®š
 *
 * @param channels å£°é“æ•°ï¼ˆ1-2å£°é“ï¼‰
 * @param sample_rate é‡‡æ ·ç‡
 * @param bits_per_sample ä½æ·±åº¦
 * @param progress_handle è¿›åº¦å›è°ƒå¥æŸ„ï¼ˆ0è¡¨ç¤ºæ— è¿›åº¦å›è°ƒï¼‰
 * @param completion_handle å®Œæˆå›è°ƒå¥æŸ„ï¼ˆå¿…é¡»æä¾›æœ‰æ•ˆå¥æŸ„ï¼‰
 *
 * @return >0: ä¼šè¯IDï¼ˆç”¨äºåç»­åˆ†å—å‘é€å’Œå®Œæˆè°ƒç”¨ï¼‰, -1: æ— æ•ˆå‚æ•°, -2: æ— æ•ˆå¥æŸ„, -5: å£°é“æ•°è¶…é™
 */
int rust_streaming_analysis_init(unsigned int channels, unsigned int sample_rate,
                                 unsigned int bits_per_sample, CallbackHandle progress_handle,
                                 CallbackHandle completion_handle);

/**
 * ğŸŒŠ ã€æµå¼åˆ†æã€‘å‘é€éŸ³é¢‘æ•°æ®å—
 *
 * ## æ ¸å¿ƒç‰¹æ€§
 * - **å³æ—¶å¤„ç†**ï¼šéŸ³é¢‘å—ç«‹å³å¤„ç†ï¼Œä¸ä¿å­˜åœ¨å†…å­˜ä¸­
 * - **è‡ªåŠ¨è¿›åº¦**ï¼šæ ¹æ®å·²å¤„ç†å—æ•°è‡ªåŠ¨è®¡ç®—è¿›åº¦
 * - **çº¿ç¨‹å®‰å…¨**ï¼šæ”¯æŒå¤šçº¿ç¨‹è°ƒç”¨
 *
 * @param session_id rust_streaming_analysis_initè¿”å›çš„ä¼šè¯ID
 * @param samples éŸ³é¢‘æ ·æœ¬æ•°æ®æŒ‡é’ˆï¼ˆf32æ•°ç»„ï¼‰
 * @param sample_count æ ·æœ¬æ•°é‡
 *
 * @return 0: æˆåŠŸ, -1: æ— æ•ˆä¼šè¯ID, -2: æ— æ•ˆå‚æ•°, -3: ä¼šè¯å·²å®Œæˆ
 */
int rust_streaming_analysis_send_chunk(int session_id, const float* samples,
                                       unsigned int sample_count);

/**
 * ğŸ ã€æµå¼åˆ†æã€‘å®Œæˆæµå¼åˆ†æå¹¶è·å–ç»“æœ
 *
 * ## å®Œæˆç‰¹æ€§
 * - **å¼‚æ­¥å®Œæˆ**ï¼šç«‹å³è¿”å›ï¼Œç»“æœé€šè¿‡completion_callbackå›è°ƒ
 * - **è‡ªåŠ¨æ¸…ç†**ï¼šä¼šè¯èµ„æºè‡ªåŠ¨æ¸…ç†
 * - **ç»“æœå›è°ƒ**ï¼šformatted DRç»“æœé€šè¿‡æ³¨å†Œçš„å›è°ƒå‡½æ•°è¿”å›
 *
 * @param session_id rust_streaming_analysis_initè¿”å›çš„ä¼šè¯ID
 *
 * @return 0: æˆåŠŸå¯åŠ¨å®Œæˆå¤„ç†, -1: æ— æ•ˆä¼šè¯ID, -2: ä¼šè¯æœªåˆå§‹åŒ–
 */
int rust_streaming_analysis_finalize(int session_id);

/**
 * ğŸ›‘ ã€æµå¼åˆ†æã€‘å–æ¶ˆæµå¼åˆ†æä¼šè¯
 *
 * @param session_id rust_streaming_analysis_initè¿”å›çš„ä¼šè¯ID
 * @return 0: æˆåŠŸå–æ¶ˆ, -1: ä¼šè¯ä¸å­˜åœ¨æˆ–å·²å®Œæˆ
 */
int rust_streaming_analysis_cancel(int session_id);

#ifdef __cplusplus
}
#endif