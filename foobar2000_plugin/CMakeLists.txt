cmake_minimum_required(VERSION 3.20)
project(MacinMeter_DR_Plugin)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# ğŸš€ å¼ºåˆ¶Releaseæ„å»ºï¼ˆä¼˜åŒ–å¤§å°ï¼‰
if(NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Release CACHE STRING "Build type" FORCE)
endif()

# å¹³å°ç‰¹å®šè®¾ç½®
if(APPLE)
    message(STATUS "Building for macOS foobar2000")
    set(CMAKE_OSX_DEPLOYMENT_TARGET "11.0")
    # ä½¿ç”¨å½“å‰Macçš„åŸç”Ÿæ¶æ„
    set(CMAKE_OSX_ARCHITECTURES "arm64")
endif()

# foobar2000 SDK è·¯å¾„
set(FOOBAR2000_SDK_PATH "${CMAKE_CURRENT_SOURCE_DIR}/../SDK-2025-03-07")

# åŒ…å«foobar2000 SDKå¤´æ–‡ä»¶ï¼ˆæ ‡è®°ä¸ºSYSTEMä»¥å‡å°‘IDEè¯¯æŠ¥ï¼‰
include_directories(SYSTEM
    "${FOOBAR2000_SDK_PATH}"
    "${FOOBAR2000_SDK_PATH}/foobar2000"
    "${FOOBAR2000_SDK_PATH}/foobar2000/SDK"
    "${FOOBAR2000_SDK_PATH}/foobar2000/helpers"
)

# å¹³å°ç‰¹å®šçš„é¢„å®šä¹‰å®
if(APPLE)
    add_definitions(-DMAC_VERSION)
    # ğŸ¯ å¹³è¡¡çš„å¤§å°ä¼˜åŒ–ï¼ˆä¿æŒå¼‚å¸¸å¤„ç†ï¼Œç›®æ ‡ï¼šå‡å°‘30%çš„æ–‡ä»¶å¤§å°ï¼‰
    set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} -Os -flto -ffunction-sections -fdata-sections -fvisibility=hidden -DNDEBUG")
    set(CMAKE_SHARED_LINKER_FLAGS_RELEASE "${CMAKE_SHARED_LINKER_FLAGS_RELEASE} -Wl,-dead_strip -Wl,-x -flto -Wl,-S")
elseif(WIN32)
    add_definitions(-DUNICODE -D_UNICODE -DWIN32_LEAN_AND_MEAN)
endif()

# PFCæºæ–‡ä»¶
set(PFC_SOURCES
    "${FOOBAR2000_SDK_PATH}/pfc/printf.cpp"
    "${FOOBAR2000_SDK_PATH}/pfc/string_base.cpp"
    "${FOOBAR2000_SDK_PATH}/pfc/string-lite.cpp"
    "${FOOBAR2000_SDK_PATH}/pfc/string-compare.cpp"
    "${FOOBAR2000_SDK_PATH}/pfc/other.cpp"
    "${FOOBAR2000_SDK_PATH}/pfc/pathUtils.cpp"
    "${FOOBAR2000_SDK_PATH}/pfc/splitString2.cpp"
    "${FOOBAR2000_SDK_PATH}/pfc/utf8.cpp"
    "${FOOBAR2000_SDK_PATH}/pfc/bit_array.cpp"
    "${FOOBAR2000_SDK_PATH}/pfc/sort.cpp"
    "${FOOBAR2000_SDK_PATH}/pfc/crashWithMessage.cpp"
    "${FOOBAR2000_SDK_PATH}/pfc/timers.cpp"
    "${FOOBAR2000_SDK_PATH}/pfc/nix-objects.cpp"
    "${FOOBAR2000_SDK_PATH}/pfc/synchro_nix.cpp"
    "${FOOBAR2000_SDK_PATH}/pfc/pfc-fb2k-hooks.cpp"
    "${FOOBAR2000_SDK_PATH}/pfc/unicode-normalize.cpp"
    "${FOOBAR2000_SDK_PATH}/pfc/audio_math.cpp"
    "${FOOBAR2000_SDK_PATH}/pfc/audio_sample.cpp"
    "${FOOBAR2000_SDK_PATH}/pfc/wildcard.cpp"
)

# SDKæºæ–‡ä»¶
set(SDK_SOURCES
    "${FOOBAR2000_SDK_PATH}/foobar2000/SDK/service.cpp"
    "${FOOBAR2000_SDK_PATH}/foobar2000/SDK/console.cpp"
    "${FOOBAR2000_SDK_PATH}/foobar2000/SDK/popup_message.cpp"
    "${FOOBAR2000_SDK_PATH}/foobar2000/SDK/completion_notify.cpp"
    "${FOOBAR2000_SDK_PATH}/foobar2000/SDK/input.cpp"
    "${FOOBAR2000_SDK_PATH}/foobar2000/SDK/guids.cpp"
    "${FOOBAR2000_SDK_PATH}/foobar2000/SDK/filesystem.cpp"
    "${FOOBAR2000_SDK_PATH}/foobar2000/SDK/filesystem_helper.cpp"
    "${FOOBAR2000_SDK_PATH}/foobar2000/SDK/file_info.cpp"
    "${FOOBAR2000_SDK_PATH}/foobar2000/SDK/file_info_impl.cpp"
    "${FOOBAR2000_SDK_PATH}/foobar2000/SDK/file_info_merge.cpp"
    "${FOOBAR2000_SDK_PATH}/foobar2000/SDK/abort_callback.cpp"
    "${FOOBAR2000_SDK_PATH}/foobar2000/SDK/audio_chunk.cpp"
    "${FOOBAR2000_SDK_PATH}/foobar2000/SDK/audio_chunk_channel_config.cpp"
    "${FOOBAR2000_SDK_PATH}/foobar2000/SDK/playable_location.cpp"
    "${FOOBAR2000_SDK_PATH}/foobar2000/SDK/metadb_handle.cpp"
    "${FOOBAR2000_SDK_PATH}/foobar2000/SDK/replaygain.cpp"
    "${FOOBAR2000_SDK_PATH}/foobar2000/SDK/replaygain_info.cpp"
    "${FOOBAR2000_SDK_PATH}/foobar2000/shared/shared-nix.cpp"
    "${FOOBAR2000_SDK_PATH}/foobar2000/shared/audio_math.cpp"
    "${FOOBAR2000_SDK_PATH}/foobar2000/foobar2000_component_client/component_client.cpp"
    "${FOOBAR2000_SDK_PATH}/pfc/guid.cpp"
    ${PFC_SOURCES}
)

# æ’ä»¶æºæ–‡ä»¶
set(PLUGIN_SOURCES
    src/plugin_main.cpp
    src/context_menu.cpp
    src/audio_accessor.cpp
    src/rust_bridge.cpp
    src/results_dialog.cpp
    src/foobar2000_stub.cpp
    ${SDK_SOURCES}
)

# æ·»åŠ custom targetæ¥æ„å»ºRustæ ¸å¿ƒåº“
set(RUST_CORE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/rust_core")
set(RUST_BUILD_DIR "${RUST_CORE_PATH}/target/release")

if(APPLE)
    set(RUST_LIB_NAME "libmacinmeter_dr_core.dylib")
    set(RUST_BUILD_TARGET "")  # é»˜è®¤targetï¼Œä½¿ç”¨æœ¬æœºæ¶æ„
elseif(WIN32)
    set(RUST_LIB_NAME "macinmeter_dr_core.dll")
    set(RUST_BUILD_TARGET "--target x86_64-pc-windows-msvc")
endif()

set(RUST_LIB_FULL_PATH "${RUST_BUILD_DIR}/${RUST_LIB_NAME}")

# è·å–Rustæºæ–‡ä»¶åˆ—è¡¨ç”¨äºä¾èµ–æ£€æŸ¥
file(GLOB_RECURSE RUST_SOURCES
    "${RUST_CORE_PATH}/src/*.rs"
)
list(APPEND RUST_SOURCES
    "${RUST_CORE_PATH}/Cargo.toml"
)

# åˆ›å»ºRuståº“è¾“å‡ºçš„custom commandï¼ˆå¸¦æºæ–‡ä»¶ä¾èµ–ï¼‰
add_custom_command(
    OUTPUT ${RUST_LIB_FULL_PATH}
    COMMAND cargo build --release ${RUST_BUILD_TARGET}
    DEPENDS ${RUST_SOURCES}
    WORKING_DIRECTORY ${RUST_CORE_PATH}
    COMMENT "Building Rust core library with output tracking..."
    VERBATIM
)

# åˆ›å»ºåŸºäºè¾“å‡ºæ–‡ä»¶çš„æ„å»ºç›®æ ‡
add_custom_target(build_rust_core DEPENDS ${RUST_LIB_FULL_PATH})

# åˆ›å»ºå¯¼å…¥åº“ç›®æ ‡æ¥è¡¨ç¤ºRuståº“
add_library(rust_core_lib SHARED IMPORTED)
set_target_properties(rust_core_lib PROPERTIES
    IMPORTED_LOCATION ${RUST_LIB_FULL_PATH}
)

# ç¡®ä¿Ruståº“åœ¨å¯¼å…¥å‰æ„å»ºå®Œæˆ
add_dependencies(rust_core_lib build_rust_core)

# åˆ›å»ºå…±äº«åº“/æ’ä»¶
add_library(foo_dr_macinmeter SHARED ${PLUGIN_SOURCES})

# ä¸ºç›®æ ‡è¡¥å……SYSTEMå¤´ï¼Œè¿›ä¸€æ­¥å‡å°‘IDE/clangdå¯¹ç¬¬ä¸‰æ–¹å¤´çš„è¯¯æŠ¥
target_include_directories(foo_dr_macinmeter SYSTEM PRIVATE
    "${FOOBAR2000_SDK_PATH}"
    "${FOOBAR2000_SDK_PATH}/foobar2000"
    "${FOOBAR2000_SDK_PATH}/foobar2000/SDK"
    "${FOOBAR2000_SDK_PATH}/foobar2000/helpers"
)

# ç¡®ä¿æ’ä»¶ä¾èµ–Ruståº“æ„å»º
add_dependencies(foo_dr_macinmeter rust_core_lib)

# å¹³å°ç‰¹å®šçš„åº“é“¾æ¥
if(APPLE)
    # Macç‰ˆæœ¬ï¼šæŸ¥æ‰¾SDKé™æ€åº“
    find_library(FOOBAR2000_SDK_LIB 
        NAMES libfoobar2000_SDK.a foobar2000_SDK
        PATHS "${FOOBAR2000_SDK_PATH}/foobar2000/SDK"
        NO_DEFAULT_PATH
    )
    
    find_library(FOOBAR2000_HELPERS_LIB
        NAMES libfoobar2000_sdk_helpers.a foobar2000_sdk_helpers  
        PATHS "${FOOBAR2000_SDK_PATH}/foobar2000/helpers"
        NO_DEFAULT_PATH
    )
    
    find_library(PFC_LIB
        NAMES libpfc.a pfc
        PATHS "${FOOBAR2000_SDK_PATH}/pfc"
        NO_DEFAULT_PATH
    )
    
    # å¦‚æœæ‰¾åˆ°SDKåº“å°±é“¾æ¥ï¼Œå¦åˆ™ä½¿ç”¨ç›®æ ‡æ–‡ä»¶
    if(FOOBAR2000_SDK_LIB AND FOOBAR2000_HELPERS_LIB AND PFC_LIB)
        target_link_libraries(foo_dr_macinmeter ${FOOBAR2000_SDK_LIB} ${FOOBAR2000_HELPERS_LIB} ${PFC_LIB})
    else()
        message(WARNING "foobar2000 SDK libraries not found, plugin may need manual linking")
    endif()
    
    # Rustæ ¸å¿ƒåº“ (é€šè¿‡å¯¼å…¥ç›®æ ‡é“¾æ¥)
    target_link_libraries(foo_dr_macinmeter rust_core_lib)
    
    # Macç³»ç»Ÿæ¡†æ¶
    find_library(COCOA_FRAMEWORK Cocoa)
    find_library(COREAUDIO_FRAMEWORK CoreAudio)
    find_library(AUDIOTOOLBOX_FRAMEWORK AudioToolbox)
    target_link_libraries(foo_dr_macinmeter 
        ${COCOA_FRAMEWORK}
        ${COREAUDIO_FRAMEWORK} 
        ${AUDIOTOOLBOX_FRAMEWORK}
    )
    
    # è®¾ç½®Macæ’ä»¶å±æ€§
    set_target_properties(foo_dr_macinmeter PROPERTIES
        PREFIX ""
        SUFFIX ".dylib"
        OUTPUT_NAME "foo_dr_macinmeter"
        BUNDLE FALSE
        MACOSX_RPATH TRUE
    )

    # åˆ›å»ºfoobar2000å…¼å®¹çš„macOS Bundleæ’ä»¶åŒ…
    add_custom_command(TARGET foo_dr_macinmeter POST_BUILD
        # åˆ›å»ºBundleç›®å½•ç»“æ„
        COMMAND ${CMAKE_COMMAND} -E make_directory ${CMAKE_CURRENT_BINARY_DIR}/plugin_bundle/mac/foo_dr_macinmeter.component/Contents/MacOS
        COMMAND ${CMAKE_COMMAND} -E make_directory ${CMAKE_CURRENT_BINARY_DIR}/plugin_bundle/mac/foo_dr_macinmeter.component/Contents/Resources

        # å¤åˆ¶ä¸»å¯æ‰§è¡Œæ–‡ä»¶
        COMMAND ${CMAKE_COMMAND} -E copy $<TARGET_FILE:foo_dr_macinmeter> ${CMAKE_CURRENT_BINARY_DIR}/plugin_bundle/mac/foo_dr_macinmeter.component/Contents/MacOS/foo_dr_macinmeter

        # å¤åˆ¶Rustæ ¸å¿ƒåº“åˆ°Resources
        COMMAND ${CMAKE_COMMAND} -E copy ${RUST_LIB_FULL_PATH} ${CMAKE_CURRENT_BINARY_DIR}/plugin_bundle/mac/foo_dr_macinmeter.component/Contents/Resources/

        # å¤åˆ¶Info.plist
        COMMAND ${CMAKE_COMMAND} -E copy ${CMAKE_CURRENT_SOURCE_DIR}/Info.plist.template ${CMAKE_CURRENT_BINARY_DIR}/plugin_bundle/mac/foo_dr_macinmeter.component/Contents/Info.plist

        # ä½¿ç”¨storeæ–¹æ³•ï¼ˆæ— å‹ç¼©ï¼‰åˆ›å»ºæ’ä»¶åŒ…
        COMMAND ${CMAKE_COMMAND} -E chdir ${CMAKE_CURRENT_BINARY_DIR}/plugin_bundle zip -0 -r ../foo_dr_macinmeter.fb2k-component mac/

        COMMENT "Creating macOS foobar2000 Bundle plugin package (.fb2k-component)"
    )

elseif(WIN32)
    # Windowsç‰ˆæœ¬ï¼šä½¿ç”¨.libæ–‡ä»¶
    target_link_libraries(foo_dr_macinmeter
        "${FOOBAR2000_SDK_PATH}/foobar2000/SDK/foobar2000_SDK.lib"
        "${FOOBAR2000_SDK_PATH}/foobar2000/helpers/foobar2000_sdk_helpers.lib"
        "${FOOBAR2000_SDK_PATH}/pfc/pfc.lib"
        "${FOOBAR2000_SDK_PATH}/libPPUI/libPPUI.lib"
    )
    
    # Rustæ ¸å¿ƒåº“ (é€šè¿‡å¯¼å…¥ç›®æ ‡é“¾æ¥)
    target_link_libraries(foo_dr_macinmeter rust_core_lib)
    
    # Windowsç³»ç»Ÿåº“
    target_link_libraries(foo_dr_macinmeter
        user32 kernel32 gdi32 comctl32 comdlg32 ole32 oleaut32 uuid
    )
    
    # è®¾ç½®Windows DLLå±æ€§
    set_target_properties(foo_dr_macinmeter PROPERTIES
        PREFIX ""
        SUFFIX ".dll"
        OUTPUT_NAME "foo_dr_macinmeter"
    )
endif()

# å¤åˆ¶åˆ°foobar2000æ’ä»¶ç›®å½•ï¼ˆå¼€å‘æ—¶ä½¿ç”¨ï¼‰
if(DEFINED FOOBAR2000_PLUGIN_DIR)
    add_custom_command(TARGET foo_dr_macinmeter POST_BUILD
        COMMAND ${CMAKE_COMMAND} -E copy $<TARGET_FILE:foo_dr_macinmeter> ${FOOBAR2000_PLUGIN_DIR}
        COMMENT "Copying plugin to foobar2000 directory"
    )
endif()